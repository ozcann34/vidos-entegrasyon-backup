{% extends "_base.html" %}
{% block title %}N11 Kategori Eşleştirme — VIDOS{% endblock %}
{% block page_title %}N11 Kategori Eşleştirme{% endblock %}

{% block content %}
<div class="card p-4 animate__animated animate__fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="fw-bold mb-1">Kategori Eşleştirme</h5>
            <p class="text-muted small mb-0">XML kategorilerinizi N11 kategorileri ile eşleştirerek toplu yükleme
                başarısını artırın.</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-info" onclick="fetchN11Categories()" id="fetch-cats-btn">
                <i class="bi bi-download me-2"></i>Kategorileri Güncelle
            </button>
            <button class="btn btn-primary shadow-sm px-4 fw-bold" onclick="saveMapping()">
                <i class="bi bi-save me-2"></i>Değişiklikleri Kaydet
            </button>
        </div>
    </div>

    <div class="alert alert-info border-0 shadow-sm mb-4" style="background: rgba(13, 202, 240, 0.1);">
        <i class="bi bi-info-circle-fill me-2"></i>
        Eğer bir kategori için eşleşme yapmazsanız, sistem yapay zeka (TF-IDF) ile en uygun kategoriyi otomatik bulmaya
        çalışacaktır.
    </div>

    <!-- Arama -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text border-end-0"
                    style="background: var(--input-bg); border-color: var(--input-border);"><i
                        class="bi bi-search text-muted"></i></span>
                <input type="text" id="catSearch" class="form-control border-start-0"
                    placeholder="XML Kategorilerinde Ara...">
            </div>
        </div>
        <div class="col-md-6 text-end">
            <span class="badge bg-light text-dark border p-2" id="mapping-stats">
                <span id="total-xml">0</span> XML Kategorisi | <span id="mapped-count">0</span> Eşleşmiş
            </span>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle" id="mappingTable" style="color: var(--text);">
            <thead>
                <tr>
                    <th style="width: 40%;">XML Kategorisi</th>
                    <th style="width: 50%;">N11 Kategorisi (En Alt Kırılım)</th>
                    <th class="text-center">İşlem</th>
                </tr>
            </thead>
            <tbody id="mappingBody">
                <tr id="loading-row">
                    <td colspan="3" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div class="mt-2 text-muted">Kategoriler Yükleniyor...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal: Category Search -->
<div class="modal fade" id="catSelectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">N11 Kategorisi Seçin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" id="n11CatSearch" class="form-control"
                        placeholder="N11 kategorilerinde ara... (Örn: Elbise, Ayakkabı)">
                    <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
                </div>
                <div class="list-group overflow-auto" style="max-height: 400px;" id="n11CatList">
                    <!-- JS populated -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let n11Categories = [];
    let currentXmlCat = null;
    let currentMappings = {{ mapping | tojson | safe }};
    const xmlCategories = {{ xml_categories | tojson | safe }};

    async function fetchN11Categories() {
        const btn = document.getElementById('fetch-cats-btn');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Güncelleniyor...';

        try {
            const resp = await fetch('/api/n11/categories');
            const data = await resp.json();
            if (data.success) {
                n11Categories = data.categories;
                renderTable();
                if (btn.id === 'fetch-cats-btn') {
                    Swal.fire('Başarılı', `${data.count} kategori güncellendi.`, 'success');
                }
            }
        } catch (e) {
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    function renderTable() {
        const tbody = document.getElementById('mappingBody');
        tbody.innerHTML = '';

        let mappedCount = 0;
        xmlCategories.forEach(xmlCat => {
            const row = document.createElement('tr');
            const n11CatId = currentMappings[xmlCat];
            const n11Cat = n11Categories.find(c => c.id == n11CatId);

            if (n11CatId) mappedCount++;

            row.innerHTML = `
            <td><span class="fw-semibold">${xmlCat}</span></td>
            <td>
                <div class="p-2 border rounded d-flex justify-content-between align-items-center cursor-pointer" style="background: var(--bg);" onclick="openCatSelector('${xmlCat.replace(/'/g, "\\'")}')">
                    <span class="${n11Cat ? '' : 'text-muted italic'}">${n11Cat ? n11Cat.path : 'Seçilmedi (Otomatik Eşleşecek)'}</span>
                    <i class="bi bi-chevron-right small text-muted"></i>
                </div>
            </td>
            <td class="text-center">
                ${n11CatId ? `<button class="btn btn-sm btn-outline-danger" onclick="removeMapping('${xmlCat.replace(/'/g, "\\'")}')"><i class="bi bi-x-lg"></i></button>` : ''}
            </td>
        `;
            tbody.appendChild(row);
        });

        document.getElementById('total-xml').innerText = xmlCategories.length;
        document.getElementById('mapped-count').innerText = mappedCount;
    }

    function openCatSelector(xmlCat) {
        currentXmlCat = xmlCat;
        const modal = new bootstrap.Modal(document.getElementById('catSelectModal'));
        modal.show();
        renderN11CatList('');
    }

    function renderN11CatList(query) {
        const list = document.getElementById('n11CatList');
        list.innerHTML = '';

        const filtered = n11Categories.filter(c =>
            c.path.toLowerCase().includes(query.toLowerCase()) ||
            c.name.toLowerCase().includes(query.toLowerCase())
        ).slice(0, 100); // Limit results for UI performance

        if (filtered.length === 0) {
            list.innerHTML = '<div class="text-center py-4 text-muted">Kategori bulunamadı.</div>';
            return;
        }

        filtered.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'list-group-item list-group-item-action py-2';
            btn.innerHTML = `<div class="small text-muted">${c.path.replace(c.name, '')}</div><div class="fw-bold">${c.name}</div>`;
            btn.onclick = () => selectN11Cat(c);
            list.appendChild(btn);
        });
    }

    function selectN11Cat(cat) {
        currentMappings[currentXmlCat] = cat.id;
        const modal = bootstrap.Modal.getInstance(document.getElementById('catSelectModal'));
        modal.hide();
        renderTable();
    }

    function removeMapping(xmlCat) {
        delete currentMappings[xmlCat];
        renderTable();
    }

    async function saveMapping() {
        try {
            const resp = await fetch('/api/n11/category_mapping', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mapping: currentMappings })
            });
            const data = await resp.json();
            if (data.success) {
                Swal.fire('Kaydedildi', data.message, 'success');
            } else {
                Swal.fire('Hata', data.message, 'error');
            }
        } catch (e) {
            Swal.fire('Hata', 'Bağlantı hatası.', 'error');
        }
    }

    // Search XML Tags
    document.getElementById('catSearch').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#mappingBody tr');
        rows.forEach(row => {
            const text = row.cells[0].innerText.toLowerCase();
            row.style.display = text.includes(q) ? '' : 'none';
        });
    });

    // Search N11 Modal
    document.getElementById('n11CatSearch').addEventListener('input', (e) => {
        renderN11CatList(e.target.value);
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', fetchN11Categories);
</script>

<style>
    .cursor-pointer {
        cursor: pointer;
    }

    .cursor-pointer:hover {
        background: #f8f9fa !important;
        border-color: var(--bs-primary) !important;
    }

    .italic {
        font-style: italic;
    }
</style>
{% endblock %}