{% extends "_base.html" %}
{% block title %}Instagram Araçları — VIDOS{% endblock %}
{% block page_title %}Instagram Araçları{% endblock %}

{% block content %}

<div class="row">
    <!-- Tabs Navigation -->
    <div class="col-12 mb-4">
        <ul class="nav nav-tabs" id="instaTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products"
                    type="button" role="tab" aria-selected="true">
                    <i class="bi bi-box-seam me-2"></i>Ürün Seçimi
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="creator-tab" data-bs-toggle="tab" data-bs-target="#creator" type="button"
                    role="tab" aria-selected="false">
                    <i class="bi bi-pencil-square me-2"></i>İçerik Oluşturucu
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scheduled-tab" data-bs-toggle="tab" data-bs-target="#scheduled"
                    type="button" role="tab" aria-selected="false">
                    <i class="bi bi-calendar-event me-2"></i>Zamanlananlar
                    <span class="badge bg-secondary ms-1">{{ scheduled_jobs|length }}</span>
                </button>
            </li>
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="col-12">
        <div class="tab-content" id="instaTabsContent">

            <!-- 1. PRODUCT SELECTION TAB -->
            <div class="tab-pane fade show active" id="products" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Ürün Listesi</h5>

                        <!-- Simple Filter (Search) -->
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" placeholder="Ara..." id="productSearch"
                                onkeyup="filterProducts()">
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-hover align-middle mb-0" id="productsTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 50px;">Resim</th>
                                        <th>Ürün Adı</th>
                                        <th>Fiyat</th>
                                        <th>Stok</th>
                                        <th class="text-end">İşlem</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in products %}
                                    <tr>
                                        <td>
                                            {% set img_url = '' %}
                                            {% set imgs = p.get_images %}
                                            {% if imgs and imgs[0] %}
                                            {% set img_url = imgs[0].url %}
                                            {% endif %}

                                            {% if img_url %}
                                            <img src="{{ img_url }}" class="rounded border" width="40" height="40"
                                                style="object-fit: cover;">
                                            {% else %}
                                            <div class="bg-light rounded d-flex align-items-center justify-content-center border"
                                                style="width:40px;height:40px;">
                                                <i class="bi bi-image text-muted"></i>
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="text-truncate fw-bold" style="max-width: 300px;"
                                                title="{{ p.title }}">{{ p.title }}</div>
                                            <div class="small text-muted font-monospace">{{ p.barcode }}</div>
                                        </td>
                                        <td>
                                            <div class="fw-bold">{{ '%.2f' % p.listPrice }} TL</div>
                                        </td>
                                        <td>{{ p.quantity }}</td>
                                        <td class="text-end">
                                            <button class="btn btn-sm btn-outline-primary select-product-btn"
                                                data-title="{{ p.title }}" data-price="{{ p.listPrice }}"
                                                data-img="{{ img_url }}">
                                                <i class="bi bi-share me-1"></i>Paylaş
                                            </button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4">Ürün bulunamadı.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. CONTENT CREATOR TAB -->
            <div class="tab-pane fade" id="creator" role="tabpanel">
                <div class="row">
                    <!-- Form Side -->
                    <div class="col-lg-5">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <form id="creatorForm" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="action" id="formAction" value="schedule">

                                    <!-- Media Type Selection -->
                                    <div class="mb-3">
                                        <label class="form-label d-block fw-bold">Paylaşım Türü</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="media_type" id="typeStory"
                                                value="story" checked onchange="toggleCaption()">
                                            <label class="btn btn-outline-secondary" for="typeStory">
                                                <i class="bi bi-images me-1"></i>Hikaye (Story)
                                            </label>

                                            <input type="radio" class="btn-check" name="media_type" id="typePost"
                                                value="post" onchange="toggleCaption()">
                                            <label class="btn btn-outline-secondary" for="typePost">
                                                <i class="bi bi-grid-3x3 me-1"></i>Gönderi (Post)
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Görsel URL</label>
                                        <input type="url" class="form-control form-control-sm" name="image_url"
                                            id="imageUrl" required placeholder="https://..." onchange="updatePreview()">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Başlık</label>
                                        <input type="text" class="form-control form-control-sm" name="title"
                                            id="productTitle" required placeholder="Ürün adı..."
                                            onchange="updatePreview()">
                                    </div>

                                    <div class="row g-2 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Fiyat</label>
                                            <input type="number" step="0.01" class="form-control form-control-sm"
                                                name="price" id="productPrice" required onchange="updatePreview()">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">İndirimli</label>
                                            <input type="number" step="0.01" class="form-control form-control-sm"
                                                name="discount_price" id="productDiscountPrice"
                                                onchange="updatePreview()">
                                        </div>
                                    </div>

                                    <!-- Caption for Post -->
                                    <div class="mb-3 d-none" id="captionContainer">
                                        <label class="form-label">Açıklama (Caption)</label>
                                        <textarea class="form-control" name="caption" rows="3"
                                            placeholder="Gönderi açıklaması..."></textarea>
                                    </div>

                                    <div class="mb-3" id="templateContainer">
                                        <label class="form-label">Şablon</label>
                                        <select class="form-select form-select-sm" name="template_style"
                                            id="templateStyle" onchange="updatePreview()">
                                            <option value="modern">Modern (Gradient)</option>
                                        </select>
                                    </div>

                                    <hr>

                                    <!-- Actions -->
                                    <div class="mb-3">
                                        <label class="form-label">Zamanlama</label>
                                        <input type="datetime-local" class="form-control" name="run_date" id="runDate">
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-light border" onclick="generatePreview()">
                                            <i class="bi bi-eye"></i> Önizleme Yenile
                                        </button>

                                        <div class="btn-group">
                                            <button type="submit" class="btn btn-warning text-white"
                                                onclick="setAction('schedule')">
                                                <i class="bi bi-clock"></i> Zamanla
                                            </button>
                                            <button type="submit" class="btn btn-primary"
                                                onclick="setAction('share_now')">
                                                <i class="bi bi-send"></i> Şimdi Paylaş
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Side -->
                    <div class="col-lg-7">
                        <div class="card shadow-sm h-100 bg-dark text-white text-center d-flex align-items-center justify-content-center"
                            style="min-height: 600px;">
                            <div id="previewContainer" class="p-3"
                                style="width: 100%; height: 100%; position: relative;">
                                <p class="text-muted mt-5" id="placeholderText">
                                    <i class="bi bi-image fs-1 d-block mb-3"></i>
                                    Görsel önizlemesi
                                </p>
                                <img id="previewImage" src="" class="img-fluid rounded shadow"
                                    style="max-height: 700px; display: none;">

                                <div id="loadingSpinner" class="spinner-border text-light" role="status"
                                    style="display: none;">
                                    <span class="visually-hidden">Yükleniyor...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. SCHEDULED JOBS TAB -->
            <div class="tab-pane fade" id="scheduled" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0">Zamanlanan Görevler</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Görev Adı</th>
                                    <th>Zaman</th>
                                    <th>Detaylar</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in scheduled_jobs %}
                                <tr>
                                    <td class="small font-monospace">{{ job.id }}</td>
                                    <td class="fw-bold">{{ job.name }}</td>
                                    <td>
                                        <span class="badge bg-light text-dark border">
                                            <i class="bi bi-clock me-1"></i>
                                            {{ job.run_time.strftime('%d.%m.%Y %H:%M') }}
                                        </span>
                                    </td>
                                    <td class="small text-muted">
                                        Media: {{ job.args.get('media_type', 'story')|upper }}
                                    </td>
                                    <td><span class="badge bg-warning text-dark">Bekliyor</span></td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-5 text-muted">
                                        Zamanlanmış görev yok.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- Helper Functions ---

    function setAction(actionName) {
        document.getElementById('formAction').value = actionName;
    }

    function toggleCaption() {
        const isPost = document.getElementById('typePost').checked;
        const captionContainer = document.getElementById('captionContainer');
        if (isPost) {
            captionContainer.classList.remove('d-none');
        } else {
            captionContainer.classList.add('d-none');
        }
    }

    function selectProduct(title, price, imgUrl) {
        // Switch tab
        const triggerEl = document.querySelector('#instaTabs button[data-bs-target="#creator"]');
        const tab = new bootstrap.Tab(triggerEl);
        tab.show();

        // Fill form
        document.getElementById('productTitle').value = title;
        document.getElementById('productPrice').value = price;
        if (imgUrl) {
            document.getElementById('imageUrl').value = imgUrl;
        }

        // Auto generate preview
        generatePreview();
    }

    function filterProducts() {
        // Simple client-side search
        const input = document.getElementById('productSearch');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('productsTable');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) { // Skip header
            const tdTitle = tr[i].getElementsByTagName('td')[1];
            if (tdTitle) {
                const txtValue = tdTitle.textContent || tdTitle.innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    function generatePreview() {
        const form = document.getElementById('creatorForm');
        const formData = new FormData(form);
        formData.set('action', 'generate_preview');

        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('placeholderText').style.display = 'none';

        fetch("{{ url_for('main.instagram_tools') }}", {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (data.success) {
                    const img = document.getElementById('previewImage');
                    img.src = data.image_path + '?t=' + new Date().getTime();
                    img.style.display = 'block';
                } else {
                    alert("Hata: " + data.message);
                    document.getElementById('placeholderText').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                alert("Bağlantı hatası.");
            });
    }

    // Auto-list filter init
    document.addEventListener('DOMContentLoaded', function () {
        // Handle select product buttons
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.select-product-btn');
            if (btn) {
                const title = btn.getAttribute('data-title');
                const price = btn.getAttribute('data-price');
                const img = btn.getAttribute('data-img');
                selectProduct(title, price, img);
            }
        });
    });
</script>

{% endblock %}