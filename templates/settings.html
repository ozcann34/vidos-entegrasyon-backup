{% extends "_base.html" %}
{% block title %}Ayarlar - VIDOS{% endblock %}
{% block page_title %}Ayarlar{% endblock %}

{% block content %}
<style>
  .settings-accordion .accordion-item {
    background: var(--card);
    border: 1px solid var(--border);
    margin-bottom: 0.5rem;
    border-radius: 8px !important;
    overflow: hidden;
  }

  .settings-accordion .accordion-button {
    background: var(--card);
    color: var(--text);
    font-weight: 600;
    padding: 1.25rem 1.5rem;
    font-size: 1.05rem;
  }

  .settings-accordion .accordion-button:not(.collapsed) {
    background: var(--card);
    color: var(--primary);
    box-shadow: none;
  }

  .settings-accordion .accordion-button:focus {
    box-shadow: none;
    border-color: var(--border);
  }

  .settings-accordion .accordion-button::after {
    filter: brightness(0.8);
  }

  .settings-accordion .accordion-body {
    padding: 1.5rem;
    background: var(--bg);
  }

  .info-card {
    background: var(--card);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    margin-bottom: 1rem;
  }

  .info-row {
    display: grid;
    grid-template-columns: 200px 1fr;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-label {
    font-weight: 600;
    color: var(--muted);
  }

  .info-value {
    color: var(--text);
  }
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="card p-4">
  <h4 class="mb-4"><i class="bi bi-gear me-2"></i>Ayarlar</h4>

  <div class="accordion settings-accordion" id="settingsAccordion">

    <!-- Profil Bilgileri -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#profileCollapse">
          <i class="bi bi-person-circle me-2"></i>
          Profil Bilgileri
        </button>
      </h2>
      <div id="profileCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">
          <div class="info-card">
            <h6 class="mb-3 text-muted">Şirket Bilgileri</h6>
            <div class="info-row">
              <div class="info-label">Ünvan:</div>
              <div class="info-value">{{ current_user.company_title or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Vergi Numarası:</div>
              <div class="info-value">{{ current_user.tax_no or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Vergi Dairesi:</div>
              <div class="info-value">{{ current_user.tax_office or '-' }}</div>
            </div>
          </div>

          <div class="info-card">
            <h6 class="mb-3 text-muted">Kişi Bilgileri</h6>
            <div class="info-row">
              <div class="info-label">Ad:</div>
              <div class="info-value">{{ current_user.first_name or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Soyad:</div>
              <div class="info-value">{{ current_user.last_name or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">TC Kimlik No:</div>
              <div class="info-value">{{ current_user.tc_no or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">E-Posta:</div>
              <div class="info-value">{{ current_user.email }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Cep Telefonu:</div>
              <div class="info-value">{{ current_user.phone or '-' }}</div>
            </div>
          </div>

          <div class="info-card">
            <h6 class="mb-3 text-muted">Adres Bilgileri</h6>
            <div class="info-row">
              <div class="info-label">Ülke:</div>
              <div class="info-value">{{ current_user.country or 'Türkiye' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">İl:</div>
              <div class="info-value">{{ current_user.city or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">İlçe:</div>
              <div class="info-value">{{ current_user.district or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Adres:</div>
              <div class="info-value">{{ current_user.address or '-' }}</div>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Bilgilerinizi güncellemek için destek ekibimizle iletişime geçiniz.
          </div>
        </div>
      </div>
    </div>

    <!-- Stok ve Genel Ayarlar -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#stockCollapse">
          <i class="bi bi-sliders me-2"></i>
          Stok ve Genel Ayarlar
        </button>
      </h2>
      <div id="stockCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">
          <form method="POST" action="{{ url_for('main.settings_page') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <label class="form-label fw-bold">Kritik Stok Limiti</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-exclamation-triangle"></i></span>
                  <input type="number" class="form-control" name="CRITICAL_STOCK_LIMIT"
                    value="{{ settings.CRITICAL_STOCK_LIMIT }}" min="0" required>
                  <span class="input-group-text">Adet</span>
                </div>
                <div class="form-text">Ürün stoğu bu sayının altına düştüğünde dashboard'da uyarı verilir.</div>
              </div>
              <div class="col-md-6">
                <button type="submit" class="btn btn-primary"><i class="bi bi-save me-2"></i> Kaydet</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Pazaryeri Ayarları -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#marketplaceCollapse">
          <i class="bi bi-shop me-2"></i>
          Pazaryeri Ayarları
        </button>
      </h2>
      <div id="marketplaceCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">
          <ul class="nav nav-tabs mb-3" id="marketTabs">
            {% if current_user.has_permission('trendyol') %}
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#trendyol-pane">Trendyol</button>
            </li>
            {% endif %}
            {% if current_user.has_permission('hepsiburada') %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#hb-pane">Hepsiburada</button>
            </li>
            {% endif %}
            {% if current_user.has_permission('pazarama') %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pazarama-pane">Pazarama</button>
            </li>
            {% endif %}
            {% if current_user.has_permission('idefix') %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#idefix-pane">İdefix</button>
            </li>
            {% endif %}
            {% if current_user.has_permission('n11') %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#n11-pane"
                style="color: #5c21df; font-weight: bold;">N11</button>
            </li>
            {% endif %}
            {% if current_user.has_permission('instagram_panel') %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#instagram-pane"
                style="color: #E1306C; font-weight: bold;">
                <i class="bi bi-instagram me-1"></i>Instagram
              </button>
            </li>
            {% endif %}
          </ul>

          <div class="tab-content" id="marketTabContent">
            <!-- Trendyol (Default Active if permission exists) -->
            {% if current_user.has_permission('trendyol') %}
            <div class="tab-pane fade show active" id="trendyol-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label fw-bold">Satıcı ID</label>
                    <input type="text" class="form-control" name="SELLER_ID" value="{{ settings.SELLER_ID }}" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-bold">API Key</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="API_KEY" id="API_KEY"
                        value="{{ settings.API_KEY }}" required>
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('API_KEY')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-bold">API Secret</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="API_SECRET" id="API_SECRET"
                        value="{{ settings.API_SECRET }}">
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('API_SECRET')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-bold">Fiyat Çarpanı</label>
                    <div class="input-group">
                      <span class="input-group-text">x</span>
                      <input type="number" step="0.01" min="0" class="form-control" name="PRICE_MULTIPLIER"
                        value="{{ settings.PRICE_MULTIPLIER }}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka Adı</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="TRENDYOL_BRAND_NAME" name="TRENDYOL_BRAND_NAME"
                        value="{{ settings.TRENDYOL_BRAND_NAME }}" placeholder="Örn: Nike">
                      <button type="button" class="btn btn-primary" id="searchTrendyolBrand">
                        <i class="bi bi-search"></i> Marka ID Bul
                      </button>
                    </div>
                    <div class="form-text">Ürün gönderirken kullanılacak varsayılan marka</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka ID</label>
                    <input class="form-control" id="TRENDYOL_BRAND_ID" name="TRENDYOL_BRAND_ID"
                      value="{{ settings.TRENDYOL_BRAND_ID }}" readonly>
                    <div class="form-text">Trendyol'daki marka ID numarası</div>
                  </div>
                  <div class="col-12">
                    <hr>
                    <button type="button" class="btn btn-outline-info" id="fetchCategoriesBtn">
                      <i class="bi bi-diagram-3 me-1"></i> Kategorileri Çek
                    </button>
                    <button type="button" class="btn btn-outline-warning ms-2" id="fetchBrandsBtn">
                      <i class="bi bi-tags me-1"></i> Markaları Çek
                    </button>
                    <button type="button" class="btn btn-outline-danger ms-2" id="clearTrendyolCacheBtn">
                      <i class="bi bi-trash me-1"></i> Önbellek Temizle
                    </button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('trendyol')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                  </div>
                </div>
              </form>
            </div>
            {% endif %}

            <!-- Hepsiburada -->
            {% if current_user.has_permission('hepsiburada') %}
            <div class="tab-pane fade" id="hb-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label fw-bold">Merchant ID</label><input class="form-control"
                      name="HB_MERCHANT_ID" value="{{ settings.HB_MERCHANT_ID }}"></div>
                  <div class="col-md-6"><label class="form-label fw-bold">Service Key (Servis Anahtarı)</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="HB_SERVICE_KEY" id="HB_SERVICE_KEY"
                        value="{{ settings.HB_SERVICE_KEY }}">
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('HB_SERVICE_KEY')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">API Kullanıcı Adı (User-Agent)</label>
                    <input class="form-control" name="HB_API_USERNAME" value="{{ settings.HB_API_USERNAME }}"
                      placeholder="Örn: saticikodu_dev">
                    <div class="form-text">Hepsiburada panelindeki 'Entegratör Kodu / Kullanıcı Adı'.</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Fiyat Çarpanı</label>
                    <div class="input-group"><span class="input-group-text">x</span><input type="number" step="0.01"
                        class="form-control" name="HB_PRICE_MULTIPLIER" value="{{ settings.HB_PRICE_MULTIPLIER }}">
                    </div>
                  </div>
                  <div class="col-md-6 d-flex align-items-center mt-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" name="HB_TEST_MODE" id="HB_TEST_MODE" {% if
                        settings.HB_TEST_MODE=='on' %}checked{% endif %}>
                      <label class="form-check-label fw-bold pulsate-red" for="HB_TEST_MODE">Hepsiburada Test Ortamı
                        (SIT)</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Varsayılan Marka Adı</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="HB_BRAND_NAME" name="HB_BRAND_NAME"
                        value="{{ settings.HB_BRAND_NAME }}" placeholder="Örn: BUZ">
                      <button type="button" class="btn btn-primary" id="searchHBBrand">
                        <i class="bi bi-search"></i> Marka ID Bul
                      </button>
                    </div>
                    <div class="form-text">Hepsiburada'ya gönderirken bu marka kullanılır.</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka ID (Otomatik)</label>
                    <input class="form-control" id="HB_BRAND_ID" name="HB_BRAND_ID" value="{{ settings.HB_BRAND_ID }}"
                      readonly>
                    <div class="form-text">Hepsiburada sistemindeki marka ID'si.</div>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('hepsiburada')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                    <button type="button" class="btn btn-outline-danger ms-2" id="clearHBCacheBtn">
                      <i class="bi bi-trash me-1"></i> Önbellek Temizle
                    </button>
                  </div>
                </div>
              </form>
            </div>
            {% endif %}

            <!-- Pazarama -->
            {% if current_user.has_permission('pazarama') %}
            <div class="tab-pane fade" id="pazarama-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label fw-bold">API Key</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="PAZARAMA_API_KEY" id="PAZARAMA_API_KEY"
                        value="{{ settings.PAZARAMA_API_KEY }}">
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('PAZARAMA_API_KEY')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-4"><label class="form-label fw-bold">API Secret</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="PAZARAMA_API_SECRET" id="PAZARAMA_API_SECRET"
                        value="{{ settings.PAZARAMA_API_SECRET }}">
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('PAZARAMA_API_SECRET')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-bold">Fiyat Çarpanı</label>
                    <div class="input-group"><span class="input-group-text">x</span><input type="number" step="0.01"
                        class="form-control" name="PAZARAMA_PRICE_MULTIPLIER"
                        value="{{ settings.PAZARAMA_PRICE_MULTIPLIER }}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka Adı</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="PAZARAMA_BRAND_NAME" name="PAZARAMA_BRAND_NAME"
                        value="{{ settings.PAZARAMA_BRAND_NAME }}">
                      <button type="button" class="btn btn-primary" id="searchPazaramaBrand"><i
                          class="bi bi-search"></i>
                        Bul</button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka ID</label>
                    <input class="form-control" id="PAZARAMA_BRAND_ID" name="PAZARAMA_BRAND_ID"
                      value="{{ settings.PAZARAMA_BRAND_ID }}" readonly>
                  </div>
                  <div class="col-12">
                    <hr>
                    <button type="button" class="btn btn-outline-info" id="fetchPazaramaCategoriesBtn"><i
                        class="bi bi-diagram-3 me-1"></i> Kategorileri Çek</button>
                    <button type="button" class="btn btn-outline-warning ms-2" id="clearPazaramaCacheBtn"><i
                        class="bi bi-trash me-1"></i> Önbellek Temizle</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('pazarama')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                  </div>
                  <div class="col-12 mt-3"><button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i>
                      Kaydet</button></div>
                </div>
              </form>
            </div>
            {% endif %}

            <!-- İdefix -->
            {% if current_user.has_permission('idefix') %}
            <div class="tab-pane fade" id="idefix-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label fw-bold">API Key</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="IDEFIX_API_KEY" id="IDEFIX_API_KEY"
                        value="{{ settings.IDEFIX_API_KEY }}">
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('IDEFIX_API_KEY')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6"><label class="form-label fw-bold">API Secret</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="IDEFIX_API_SECRET" id="IDEFIX_API_SECRET"
                        value="{{ settings.IDEFIX_API_SECRET }}">
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('IDEFIX_API_SECRET')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6"><label class="form-label fw-bold">Vendor ID</label><input class="form-control"
                      name="IDEFIX_VENDOR_ID" value="{{ settings.IDEFIX_VENDOR_ID }}"></div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka Adı</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="IDEFIX_BRAND_NAME" name="IDEFIX_BRAND_NAME"
                        value="{{ settings.IDEFIX_BRAND_NAME }}">
                      <button type="button" class="btn btn-primary" id="searchIdefixBrand"><i class="bi bi-search"></i>
                        Bul</button>
                    </div>
                  </div>
                  <div class="col-md-6"><label class="form-label fw-bold">Marka ID</label><input class="form-control"
                      id="IDEFIX_BRAND_ID" name="IDEFIX_BRAND_ID" value="{{ settings.IDEFIX_BRAND_ID }}"></div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Varsayılan Kategori ID (Zorunlu)</label>
                    <input type="text" class="form-control" name="IDEFIX_DEFAULT_CATEGORY_ID"
                      value="{{ settings.IDEFIX_DEFAULT_CATEGORY_ID }}" placeholder="Örn: 12345">
                    <div class="form-text">Yeni ürün oluşturulurken kullanılır.</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Barkod Ön Eki Temizle</label>
                    <input type="text" class="form-control" name="IDEFIX_BARCODE_PREFIX"
                      value="{{ settings.IDEFIX_BARCODE_PREFIX }}" placeholder="Örn: BGZ">
                    <div class="form-text">Bu ön ek barkoddan silinir.</div>
                  </div>

                  <div class="col-md-12 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="idefixRandomBarcode"
                        name="IDEFIX_USE_RANDOM_BARCODE" {% if settings.IDEFIX_USE_RANDOM_BARCODE=='on' %}checked{%
                        endif %}>
                      <label class="form-check-label" for="idefixRandomBarcode">Barkod geçersizse rastgele barkod
                        oluştur (GEN-XXXXXX)</label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Fiyat Çarpanı</label>
                    <input type="number" step="0.01" class="form-control" name="IDEFIX_PRICE_MULTIPLIER"
                      value="{{ settings.IDEFIX_PRICE_MULTIPLIER }}">
                  </div>

                  <div class="col-12 mt-3">
                    <button type="button" class="btn btn-outline-info" id="fetchIdefixCategoriesBtn">
                      <i class="bi bi-diagram-3 me-1"></i> Kategorileri Çek
                    </button>
                    <button type="submit" class="btn btn-success ms-2"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('idefix')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                    <button type="button" class="btn btn-outline-danger ms-2" id="clearIdefixCacheBtn">
                      <i class="bi bi-trash me-1"></i> Önbellek Temizle
                    </button>
                  </div>
                </div>
              </form>
            </div>
            {% endif %}

            <!-- N11 -->
            {% if current_user.has_permission('n11') %}
            <div class="tab-pane fade" id="n11-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">App Key (API Anahtarı)</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="N11_API_KEY" id="N11_API_KEY"
                        value="{{ settings.N11_API_KEY }}" required>
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('N11_API_KEY')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">App Secret (Gizli Anahtar)</label>
                    <div class="input-group">
                      <input type="password" class="form-control" name="N11_API_SECRET" id="N11_API_SECRET"
                        value="{{ settings.N11_API_SECRET }}" required>
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('N11_API_SECRET')">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Fiyat Çarpanı</label>
                    <div class="input-group">
                      <span class="input-group-text">x</span>
                      <input type="number" step="0.01" class="form-control" name="N11_PRICE_MULTIPLIER"
                        value="{{ settings.N11_PRICE_MULTIPLIER }}">
                    </div>
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label fw-bold">Varsayılan Marka (Zorunlu İçin)</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="N11_DEFAULT_BRAND" name="N11_DEFAULT_BRAND"
                        value="{{ settings.N11_DEFAULT_BRAND }}" placeholder="Örn: Apple">
                      <button type="button" class="btn btn-primary" id="searchN11Brand"><i class="bi bi-search"></i>
                        Bul</button>
                    </div>
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label fw-bold">Marka ID (Otomatik)</label>
                    <input class="form-control" id="N11_DEFAULT_BRAND_ID" name="N11_DEFAULT_BRAND_ID"
                      value="{{ settings.N11_DEFAULT_BRAND_ID }}" readonly placeholder="Marka ID">
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label fw-bold">Kargo Şablonu İsmi</label>
                    <input class="form-control" name="N11_DEFAULT_SHIPMENT_TEMPLATE"
                      value="{{ settings.N11_DEFAULT_SHIPMENT_TEMPLATE }}" placeholder="Örn: Standart">
                    <div class="form-text">N11 panelinizdeki kargo şablonu ismiyle birebir aynı olmalıdır.</div>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('n11')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                    <button type="button" class="btn btn-outline-info ms-2" id="fetchN11DataBtn">
                      <i class="bi bi-diagram-3 me-1"></i> Kategorileri Çek
                    </button>
                    <button type="button" class="btn btn-outline-danger ms-2" id="clearN11CacheBtn">
                      <i class="bi bi-trash me-1"></i> Önbellek Temizle
                    </button>
                  </div>
                </div>
              </form>
            </div>
            {% endif %}
            {% if current_user.has_permission('instagram_panel') %}
            <!-- Instagram -->
            <div class="tab-pane fade" id="instagram-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="alert alert-light border shadow-sm mb-3">
                  <h6 class="alert-heading text-dark fw-bold"><i
                      class="bi bi-info-circle-fill text-primary me-2"></i>Bilgi</h6>
                  <p class="mb-0 small text-muted">
                    Instagram entegrasyonu için Facebook Geliştirici panelinden aldığınız <strong>"Uzun Süreli Erişim
                      Jetonu"</strong> (Long-lived Access Token) ve <strong>"Instagram Business Account ID"</strong>
                    bilgilerinizi giriniz.
                    Bu bilgiler olmadan paylaşım yapılamaz.
                  </p>
                </div>
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label fw-bold">Instagram Business Account ID</label>
                    <input type="text" class="form-control" name="INSTAGRAM_ACCOUNT_ID"
                      value="{{ settings.INSTAGRAM_ACCOUNT_ID }}" placeholder="Örn: 17841400000000000">
                  </div>
                  <div class="col-md-12">
                    <label class="form-label fw-bold">Erişim Jetonu (Access Token)</label>
                    <div class="input-group">
                      <textarea class="form-control font-monospace" id="INSTAGRAM_ACCESS_TOKEN_2"
                        name="INSTAGRAM_ACCESS_TOKEN" rows="3" placeholder="EAAB..." style="font-size: 0.85rem;"
                        readonly>{{ settings.INSTAGRAM_ACCESS_TOKEN }}</textarea>
                      <button class="btn btn-outline-secondary" type="button"
                        onclick="togglePasswordDisplay('INSTAGRAM_ACCESS_TOKEN_2', true)">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                  </div>
                </div>
              </form>
            </div>
            {% endif %}
          </div> <!-- End tab-content -->
        </div> <!-- End accordion-body -->
      </div> <!-- End accordion-collapse -->
    </div> <!-- End accordion-item (Pazaryeri) -->

    <!-- XML Kaynakları -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#xmlCollapse">
          <i class="bi bi-file-code me-2"></i>
          XML Kaynakları
        </button>
      </h2>
      <div id="xmlCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">

          <!-- XML Tablo ve Form -->
          <ul class="nav nav-tabs mb-3" id="xmlSourceTypeTabs">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#xmlUrlPane" type="button">URL
                Ekle</button>
            </li>
          </ul>

          <div class="tab-content mb-3">
            <div class="tab-pane fade show active" id="xmlUrlPane">
              <div class="row g-2 align-items-end">
                <div class="col-md-3"><label class="form-label">İsim</label><input id="xmlName" class="form-control"
                    placeholder="Tedarikçi A"></div>
                <div class="col-md-6"><label class="form-label">XML URL</label><input id="xmlUrl" class="form-control"
                    placeholder="https://.../urunler.xml"></div>
                <div class="col-md-3"><button id="btnAddXml" type="button" class="btn btn-primary w-100"><i
                      class="bi bi-plus-lg me-1"></i> Ekle</button></div>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>İsim</th>
                  <th>URL</th>
                  <th>Tarih</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="xmlTableBody">
                {% for x in xml_sources %}
                <tr data-id="{{ x.id }}">
                  <td>{{ x.id }}</td>
                  <td>{{ x.name }}</td>
                  <td class="text-truncate" style="max-width:400px">{{ x.url }}</td>
                  <td>{{ x.created_at }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary btnSyncXmlCosts"
                      title="XML'deki maliyetleri ürünlere aktar">
                      <i class="bi bi-currency-dollar"></i> Maliyetleri Güncelle
                    </button>
                    <button class="btn btn-sm btn-outline-danger btnDelXml">Sil</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div> <!-- End accordion-item (XML) -->

    <!-- Bildirim Ayarları -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#notificationCollapse">
          <i class="bi bi-bell me-2"></i>
          Bildirim Ayarları
        </button>
      </h2>
      <div id="notificationCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">
          <div class="info-card">
            <h6 class="mb-3 text-muted">Web Push Bildirimleri</h6>
            <p class="small text-muted mb-3">Bu özellik sayesinde siparişleriniz ve sistem duyuruları hakkında anlık
              bildirim alabilirsiniz.</p>

            <div class="d-flex align-items-center gap-2">
              <button type="button" class="btn btn-primary" id="btnSendTestPush">
                <i class="bi bi-send me-2"></i> Test Bildirimi Gönder
              </button>
              <span id="pushStatus" class="small text-muted">Bildirim testi yapmak için butona tıklayın.</span>
            </div>
          </div>
        </div>
      </div>
    </div> <!-- End accordion-item (Notifications) -->

  </div> <!-- End settingsAccordion -->
</div> <!-- End card -->
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Ensure at least one tab is active
    if (!document.querySelector('#marketTabs .nav-link.active')) {
      const firstTab = document.querySelector('#marketTabs .nav-link');
      if (firstTab) {
        const tab = new bootstrap.Tab(firstTab);
        tab.show();
      }
    }

    // Push Notification Test
    const btnSendTestPush = document.getElementById('btnSendTestPush');
    if (btnSendTestPush) {
      btnSendTestPush.addEventListener('click', async function () {
        if (Notification.permission !== 'granted') {
          Swal.fire({
            title: 'Bildirim İzni Gerekli',
            text: 'Lütfen tarayıcınızdan bildirim izni verin.',
            icon: 'warning'
          });
          return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Gönderiliyor...';

        try {
          const response = await fetch('/api/push/send_test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: 'Vidos Test', message: 'Tebrikler! Bildirim sisteminiz başarıyla çalışıyor.' })
          });

          const data = await response.json();
          if (data.success) {
            Swal.fire('Başarılı', `Test bildirimi ${data.sent_count} tarayıcıya gönderildi.`, 'success');
          } else {
            Swal.fire('Hata', data.message || 'Bildirim gönderilemedi.', 'error');
          }
        } catch (err) {
          Swal.fire('Hata', 'Bağlantı hatası oluştu.', 'error');
        } finally {
          this.disabled = false;
          this.innerHTML = '<i class="bi bi-send me-2"></i> Test Bildirimi Gönder';
        }
      });
    }

    // Generic Test Connection Function
    window.testConnection = function (marketplace) {
      Swal.fire({ title: 'Test Ediliyor...', didOpen: () => Swal.showLoading() });
      fetch(`/api/test_connection/${marketplace}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Başarılı', data.message, 'success');
          } else {
            Swal.fire('Başarısız', data.message, 'error');
          }
        })
        .catch(err => Swal.fire('Hata', 'Sunucu hatası: ' + err, 'error'));
    };

    // Password Toggle Function
    window.togglePasswordDisplay = function (elementId, isTextArea = false) {
      const el = document.getElementById(elementId);
      const icon = event.currentTarget.querySelector('i');

      if (isTextArea) {
        // Special logic for textarea: Instagram token
        if (el.hasAttribute('readonly')) {
          el.removeAttribute('readonly');
          el.style.webkitTextSecurity = 'none'; // Some browsers support this
          icon.classList.replace('bi-eye', 'bi-eye-slash');
        } else {
          el.setAttribute('readonly', 'true');
          el.style.webkitTextSecurity = 'disc'; // Mask it
          icon.classList.replace('bi-eye-slash', 'bi-eye');
        }
      } else {
        if (el.type === "password") {
          el.type = "text";
          icon.classList.replace('bi-eye', 'bi-eye-slash');
        } else {
          el.type = "password";
          icon.classList.replace('bi-eye-slash', 'bi-eye');
        }
      }
    };

    // Generic Cache Clear
    function bindCacheClear(btnId, mp) {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.addEventListener('click', function () {
          Swal.fire({
            title: mp + ' Önbellek Temizle',
            text: 'Önbellek temizlensin mi?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet',
            cancelButtonText: 'Hayır'
          }).then((result) => {
            if (result.isConfirmed) {
              Swal.fire({ title: 'Temizleniyor...', didOpen: () => Swal.showLoading() });
              let url = `/api/${mp.toLowerCase()}/clear_cache`;
              if (mp === 'Trendyol') url = '/api/clear_all_cache';

              fetch(url, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                  Swal.fire(data.success ? 'Başarılı' : 'Hata', data.message, data.success ? 'success' : 'error')
                    .then(() => { if (data.success) location.reload(); });
                })
                .catch(e => Swal.fire('Hata', 'Sunucu hatası: ' + e, 'error'));
            }
          });
        });
      }
    }

    bindCacheClear('clearTrendyolCacheBtn', 'Trendyol');
    bindCacheClear('clearHBCacheBtn', 'Hepsiburada');
    bindCacheClear('clearPazaramaCacheBtn', 'Pazarama');
    bindCacheClear('clearIdefixCacheBtn', 'Idefix');
    bindCacheClear('clearN11CacheBtn', 'N11');


    // Generic Fetch Categories
    function bindFetchCategories(btnId, url) {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.addEventListener('click', function () {
          Swal.fire({ title: 'Kategoriler Çekiliyor...', didOpen: () => Swal.showLoading() });
          fetch(url, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
              Swal.fire(data.success ? 'Başarılı' : 'Hata', data.message, data.success ? 'success' : 'error');
            })
            .catch(e => Swal.fire('Hata', 'İstek hatası: ' + e, 'error'));
        });
      }
    }

    bindFetchCategories('fetchCategoriesBtn', '{{ url_for("main.fetch_trendyol_categories") }}');
    bindFetchCategories('fetchPazaramaCategoriesBtn', '{{ url_for("main.fetch_pazarama_categories") }}');
    bindFetchCategories('fetchIdefixCategoriesBtn', '/settings/fetch_idefix_categories'); // Note: Endpoint consistency
    bindFetchCategories('fetchN11DataBtn', '/api/n11/fetch_categories');


    // Generic Fetch Brands
    function bindFetchBrands(btnId, url) {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.addEventListener('click', function () {
          Swal.fire({
            title: 'Markalar Çekiliyor...',
            text: 'Bu işlem uzun sürebilir.',
            didOpen: () => Swal.showLoading()
          });
          fetch(url, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
              Swal.fire(data.success ? 'Başarılı' : 'Hata', data.message, data.success ? 'success' : 'error');
            })
            .catch(e => Swal.fire('Hata', 'İstek hatası: ' + e, 'error'));
        });
      }
    }
    bindFetchBrands('fetchBrandsBtn', '/api/trendyol/fetch_brands');

    // Trendyol Brand Search
    document.getElementById('searchTrendyolBrand')?.addEventListener('click', function () {
      const brandName = document.getElementById('TRENDYOL_BRAND_NAME').value.trim();
      if (!brandName) {
        Swal.fire('Uyarı', 'Lütfen marka adı giriniz.', 'warning');
        return;
      }

      Swal.fire({
        title: 'Aranıyor...',
        text: 'Trendyol API\'den marka bilgisi alınıyor',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      fetch('/api/trendyol/search_brand', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brand_name: brandName })
      })
        .then(r => r.json())
        .then(data => {
          Swal.close();
          if (data.success && data.brand_id) {
            document.getElementById('TRENDYOL_BRAND_ID').value = data.brand_id;
            Swal.fire({
              icon: 'success',
              title: 'Bulundu!',
              html: `<strong>${data.brand_name}</strong><br>ID: ${data.brand_id}`,
              timer: 2000
            });
          } else {
            Swal.fire('Bulunamadı', data.message || 'Marka bulunamadı. Lütfen farklı bir isim deneyin.', 'error');
          }
        })
        .catch(err => {
          Swal.close();
          Swal.fire('Hata', 'Marka arama sırasında bir hata oluştu: ' + err, 'error');
        });
    });

    // Hepsiburada Brand Search
    document.getElementById('searchHBBrand')?.addEventListener('click', function () {
      const brandName = document.getElementById('HB_BRAND_NAME').value.trim();
      if (!brandName) {
        Swal.fire('Uyarı', 'Lütfen bir marka adı girin', 'warning');
        return;
      }

      Swal.fire({
        title: 'Aranıyor...',
        text: 'Hepsiburada API\'den marka bilgisi alınıyor',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      fetch('/api/hepsiburada/search_brand', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brand_name: brandName })
      })
        .then(r => r.json())
        .then(data => {
          Swal.close();
          if (data.success && data.brands && data.brands.length > 0) {
            const items = data.brands;
            if (items.length === 1) {
              document.getElementById('HB_BRAND_NAME').value = items[0].name;
              document.getElementById('HB_BRAND_ID').value = items[0].id || '0';
              Swal.fire('Bulundu', `Marka: ${items[0].name}`, 'success');
            } else {
              const brandOpts = items.reduce((acc, b) => { acc[b.name] = b.name; return acc; }, {});
              Swal.fire({
                title: 'Birden fazla sonuç bulundu',
                input: 'select',
                inputOptions: brandOpts,
                showCancelButton: true,
                confirmButtonText: 'Seç'
              }).then(res => {
                if (res.isConfirmed) {
                  const selected = items.find(b => b.name === res.value);
                  document.getElementById('HB_BRAND_NAME').value = selected.name;
                  document.getElementById('HB_BRAND_ID').value = selected.id || '0';
                }
              });
            }
          } else {
            Swal.fire('Bulunamadı', data.message || 'Hepsiburada\'da bu marka bulunamadı.', 'error');
          }
        })
        .catch(err => {
          Swal.close();
          Swal.fire('Hata', 'Hepsiburada marka arama hatası: ' + err, 'error');
        });
    });

    // Brand Search Mock
    document.querySelectorAll('[id^="search"]').forEach(btn => {
      btn.addEventListener('click', function () {
        if (this.id === 'searchIdefixBrand' || this.id === 'searchTrendyolBrand' || this.id === 'searchHBBrand' || this.id === 'searchN11Brand' || this.id === 'searchPazaramaBrand') {
          // Handled elsewhere
        } else {
          Swal.fire('Bilgi', 'Marka arama özelliği bu pazaryeri için henüz aktif değil.', 'info');
        }
      });
    });

    // Idefix Brand Search Logic (Preserved)
    document.getElementById('searchIdefixBrand')?.addEventListener('click', function () {
      const name = document.getElementById('IDEFIX_BRAND_NAME').value.trim();
      if (!name) { Swal.fire('Uyarı', 'Marka adı girin', 'warning'); return; }
      Swal.fire({ title: 'Aranıyor...', didOpen: () => Swal.showLoading() });
      fetch('/api/idefix/search_brand', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ brand_name: name }) })
        .then(r => r.json()).then(j => {
          if (j.success && j.brand) { document.getElementById('IDEFIX_BRAND_ID').value = j.brand.id; Swal.fire('Bulundu', 'ID: ' + j.brand.id, 'success'); }
          else Swal.fire('Bulunamadı', '', 'warning');
        });
    });


    // XML Add
    document.getElementById('btnAddXml')?.addEventListener('click', function () {
      const name = document.getElementById('xmlName').value.trim();
      const url = document.getElementById('xmlUrl').value.trim();
      if (!name || !url) { Swal.fire('Uyarı', 'İsim ve URL gerekli', 'warning'); return; }
      fetch('/api/xml_sources', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, url }) })
        .then(r => r.json()).then(j => { if (j.success) location.reload(); else Swal.fire('Hata', j.message, 'error'); });
    });

    // XML Delete
    document.querySelectorAll('.btnDelXml').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.closest('tr').getAttribute('data-id');
        Swal.fire({
          title: 'Sil?',
          text: 'Bu XML kaynağı silinecek. Ürünleriniz etkilenmez.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Evet, Sil',
          cancelButtonText: 'Vazgeç'
        }).then(res => {
          if (res.isConfirmed) {
            fetch('/api/xml_sources/' + id, { method: 'DELETE' })
              .then(r => r.json())
              .then(j => { if (j.success) location.reload(); });
          }
        });
      });
    });

    // XML Sync Costs
    document.querySelectorAll('.btnSyncXmlCosts').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.closest('tr').getAttribute('data-id');
        Swal.fire({
          title: 'Maliyetler Güncellensin mi?',
          text: 'Seçili XML kaynağındaki maliyet fiyatları (cost_price) yerel ürünlerinizle eşleştirilerek güncellenecek. Bu işlem geri alınamaz.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Güncellemeyi Başlat',
          cancelButtonText: 'Vazgeç'
        }).then(res => {
          if (res.isConfirmed) {
            Swal.fire({ title: 'İşlem Başlatılıyor...', didOpen: () => Swal.showLoading() });
            fetch(`/api/xml_sources/${id}/update_costs`, { method: 'POST' })
              .then(r => r.json())
              .then(data => {
                if (data.success && data.job_id) {
                  monitorMpJob(data.job_id);
                } else {
                  Swal.fire('Hata', data.message || 'İşlem başlatılamadı.', 'error');
                }
              })
              .catch(err => Swal.fire('Hata', 'İstek hatası: ' + err, 'error'));
          }
        });
      });
    });

    function monitorMpJob(jobId) {
      let timer = setInterval(() => {
        fetch(`/api/mp_jobs/${jobId}`)
          .then(r => r.json())
          .then(data => {
            if (data.status === 'completed') {
              clearInterval(timer);
              Swal.fire({
                icon: 'success',
                title: 'Tamamlandı!',
                text: 'Maliyet güncellemeleri başarıyla uygulandı.',
                confirmButtonText: 'Tamam'
              }).then(() => location.reload());
            } else if (data.status === 'error') {
              clearInterval(timer);
              Swal.fire('Hata', data.error_message || 'İşlem sırasında bir hata oluştu.', 'error');
            } else {
              Swal.update({
                title: 'İşlem Devam Ediyor...',
                html: `Süreç: <b>%${data.progress || 0}</b><br><small class="text-muted">${data.logs ? data.logs[data.logs.length - 1] : ''}</small>`
              });
            }
          })
          .catch(err => {
            clearInterval(timer);
            console.error('Job monitor error:', err);
          });
      }, 2000);
    }

  });
</script>
{% endblock %}