{% extends "_base.html" %}
{% block title %}Ayarlar - VIDOS{% endblock %}
{% block page_title %}Ayarlar{% endblock %}

{% block content %}
<style>
  .settings-accordion .accordion-item {
    background: var(--card);
    border: 1px solid var(--border);
    margin-bottom: 0.5rem;
    border-radius: 10px !important;
    overflow: hidden;
  }

  .settings-accordion .accordion-button {
    background: var(--card);
    color: var(--text);
    font-weight: 600;
    padding: 1rem 1.25rem;
    font-size: 1rem;
  }

  .settings-accordion .accordion-button:not(.collapsed) {
    background: var(--card);
    color: var(--primary);
    box-shadow: none;
  }

  .settings-accordion .accordion-body {
    padding: 1rem;
    background: var(--bg);
  }

  .info-card {
    background: var(--card);
    padding: 1.25rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    margin-bottom: 1rem;
  }

  .info-row {
    display: grid;
    grid-template-columns: 180px 1fr;
    padding: 0.6rem 0;
    border-bottom: 1px solid var(--border);
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-label {
    font-weight: 600;
    color: var(--muted);
    font-size: 0.9rem;
  }

  .info-value {
    color: var(--text);
    font-size: 0.95rem;
  }

  /* Marketplace Tabs Mobile Optimization */
  .nav-tabs-mobile {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-bottom: 1px solid var(--border);
    padding-bottom: 2px;
    margin-bottom: 1.5rem !important;
  }

  .nav-tabs-mobile::-webkit-scrollbar {
    display: none;
  }

  .nav-tabs-mobile .nav-item {
    white-space: nowrap;
    flex: 0 0 auto;
  }

  .nav-tabs-mobile .nav-link {
    padding: 0.6rem 1rem;
    font-size: 0.9rem;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--muted);
  }

  .nav-tabs-mobile .nav-link.active {
    color: var(--primary) !important;
    border-bottom-color: var(--primary);
    background: transparent;
  }

  @media (max-width: 430px) {
    .settings-accordion .accordion-button {
      padding: 0.85rem 1rem;
      font-size: 0.9rem;
    }

    .info-card {
      padding: 1rem;
    }

    .info-row {
      grid-template-columns: 1fr;
      gap: 2px;
    }
  }
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="card p-4">
  <h4 class="mb-4"><i class="bi bi-gear me-2"></i>Ayarlar</h4>

  <div class="accordion settings-accordion" id="settingsAccordion">

    <!-- Profil Bilgileri -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#profileCollapse">
          <i class="bi bi-person-circle me-2"></i>
          Profil Bilgileri
        </button>
      </h2>
      <div id="profileCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">
          <div class="info-card">
            <h6 class="mb-3 text-muted">Şirket Bilgileri</h6>
            <div class="info-row">
              <div class="info-label">Ünvan:</div>
              <div class="info-value">{{ current_user.company_title or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Vergi Numarası:</div>
              <div class="info-value">{{ current_user.tax_no or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Vergi Dairesi:</div>
              <div class="info-value">{{ current_user.tax_office or '-' }}</div>
            </div>
          </div>

          <div class="info-card">
            <h6 class="mb-3 text-muted">Kişi Bilgileri</h6>
            <div class="info-row">
              <div class="info-label">Ad:</div>
              <div class="info-value">{{ current_user.first_name or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Soyad:</div>
              <div class="info-value">{{ current_user.last_name or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">TC Kimlik No:</div>
              <div class="info-value">{{ current_user.tc_no or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">E-Posta:</div>
              <div class="info-value">{{ current_user.email }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Cep Telefonu:</div>
              <div class="info-value">{{ current_user.phone or '-' }}</div>
            </div>
          </div>

          <div class="info-card">
            <h6 class="mb-3 text-muted">Adres Bilgileri</h6>
            <div class="info-row">
              <div class="info-label">Ülke:</div>
              <div class="info-value">{{ current_user.country or 'Türkiye' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">İl:</div>
              <div class="info-value">{{ current_user.city or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">İlçe:</div>
              <div class="info-value">{{ current_user.district or '-' }}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Adres:</div>
              <div class="info-value">{{ current_user.address or '-' }}</div>
            </div>
          </div>

          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            Bilgilerinizi güncellemek için destek ekibimizle iletişime geçiniz.
          </div>
        </div>
      </div>
    </div>

    <!-- Stok ve Genel Ayarlar -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#stockCollapse">
          <i class="bi bi-sliders me-2"></i>
          Stok ve Genel Ayarlar
        </button>
      </h2>
      <div id="stockCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">
          <form method="POST" action="{{ url_for('main.settings_page') }}">
            <div class="row g-3 align-items-end">
              <div class="col-md-6">
                <label class="form-label fw-bold">Kritik Stok Limiti</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-exclamation-triangle"></i></span>
                  <input type="number" class="form-control" name="CRITICAL_STOCK_LIMIT"
                    value="{{ settings.CRITICAL_STOCK_LIMIT }}" min="0" required>
                  <span class="input-group-text">Adet</span>
                </div>
                <div class="form-text">Ürün stoğu bu sayının altına düştüğünde dashboard'da uyarı verilir.</div>
              </div>
              <div class="col-md-6">
                <button type="submit" class="btn btn-primary"><i class="bi bi-save me-2"></i> Kaydet</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Kademeli Fiyat Kuralları (Tüm Pazaryerlerine Ortak) -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#priceRulesCollapse">
          <i class="bi bi-percent me-2"></i>
          Kademeli Fiyat Kuralları
          <span class="badge bg-success ms-2">TÜM PAZARYERLERI</span>
        </button>
      </h2>
      <div id="priceRulesCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">
          <div class="alert alert-info border-0 shadow-sm mb-4">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Nasıl Çalışır?</strong> Aşağıda tanımladığınız kurallar, XML'den pazaryerlerine (Trendyol,
            Hepsiburada, Pazarama, İdefix, N11) ürün gönderirken otomatik olarak uygulanır.
            Ürünün XML fiyatı hangi aralığa giriyorsa, o aralık için belirlediğiniz kâr yüzdesi ve sabit tutar eklenir.
          </div>

          <form method="POST" action="{{ url_for('main.settings_page') }}">
            <div id="global_rules_container" class="mb-3"></div>
            <button type="button" class="btn btn-outline-primary" onclick="addGlobalPriceRule()">
              <i class="bi bi-plus-circle me-1"></i> Yeni Kural Ekle
            </button>
            <input type="hidden" name="GLOBAL_PRICE_RULES" id="GLOBAL_PRICE_RULES_HIDDEN"
              value='{{ settings.GLOBAL_PRICE_RULES }}'>

            <hr class="my-4">

            <div class="d-flex align-items-center">
              <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
              <div class="form-text ms-3">Kurallar kaydedildiğinde tüm sonraki ürün gönderimlerinde geçerli olacaktır.
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Pazaryeri Ayarları -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#marketplaceCollapse">
          <i class="bi bi-shop me-2"></i>
          Pazaryeri Ayarları
        </button>
      </h2>
      <div id="marketplaceCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">
          <ul class="nav nav-tabs-mobile" id="marketTabs">
            {% set limit = current_user.subscription.max_marketplaces if current_user.subscription else 1 %}
            {% if current_user.is_admin %}{% set limit = 100 %}{% endif %}

            {% if limit >= 1 %}
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#trendyol-pane">Trendyol</button>
            </li>
            {% endif %}

            {% if limit >= 2 %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#hb-pane">Hepsiburada</button>
            </li>
            {% endif %}

            {% if limit >= 3 %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#n11-pane"
                style="color: #5c21df; font-weight: bold;">N11</button>
            </li>
            {% endif %}

            {% if limit >= 4 %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pazarama-pane">Pazarama</button>
            </li>
            {% endif %}

            {% if limit >= 5 %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#idefix-pane">İdefix</button>
            </li>
            {% endif %}

            {% if limit >= 6 or current_user.is_admin %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ikas-pane"
                style="color: #000; font-weight: bold;">İkas</button>
            </li>
            {% endif %}

            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#instagram-pane"
                style="color: #E1306C; font-weight: bold;">
                <i class="bi bi-instagram me-1"></i>Instagram
              </button>
            </li>

            {% if current_user.subscription.plan == 'bug-z-bayilik' or current_user.is_admin %}
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#bugz-pane"
                style="color: #28a745; font-weight: bold;">
                <i class="bi bi-gear me-1 text-success"></i> BUG-Z
              </button>
            </li>
            {% endif %}
          </ul>

          <div class="tab-content">
            <!-- Instagram -->
            <div class="tab-pane fade" id="instagram-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <div class="alert alert-light border shadow-sm mb-3">
                  <h6 class="alert-heading text-dark fw-bold"><i
                      class="bi bi-info-circle-fill text-primary me-2"></i>Bilgi</h6>
                  <p class="mb-0 small text-muted">
                    Instagram entegrasyonu için Facebook Geliştirici panelinden aldığınız <strong>"Uzun Süreli Erişim
                      Jetonu"</strong> (Long-lived Access Token) ve <strong>"Instagram Business Account ID"</strong>
                    bilgilerinizi giriniz.
                    Bu bilgiler olmadan paylaşım yapılamaz.
                  </p>
                </div>
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label fw-bold">Instagram Business Account ID</label>
                    <input type="text" class="form-control" name="INSTAGRAM_ACCOUNT_ID"
                      value="{{ settings.INSTAGRAM_ACCOUNT_ID }}" placeholder="Örn: 17841400000000000">
                  </div>
                  <div class="col-md-12">
                    <label class="form-label fw-bold">Erişim Jetonu (Access Token)</label>
                    <textarea class="form-control font-monospace" name="INSTAGRAM_ACCESS_TOKEN" rows="3"
                      placeholder="EAAB..." style="font-size: 0.85rem;">{{ settings.INSTAGRAM_ACCESS_TOKEN }}</textarea>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <!-- Test butonu (henuz API endpoint yoksa devre disi birakilabilir veya basit bir alert verebiliriz) -->
                    <button type="button" class="btn btn-outline-primary ms-2" disabled title="Önce kaydedin"><i
                        class="bi bi-link-45deg me-1"></i> Bağlantıyı Test Et (Yakında)</button>
                  </div>
                </div>
              </form>
            </div>

            <!-- Trendyol -->
            <!-- Trendyol -->
            <div class="tab-pane fade show active" id="trendyol-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label fw-bold">Satıcı ID</label>
                    <input type="text" class="form-control" name="SELLER_ID" value="{{ settings.SELLER_ID }}" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-bold">API Key</label>
                    <input type="text" class="form-control" name="API_KEY" value="{{ settings.API_KEY }}" required>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label fw-bold">API Secret</label>
                    <input type="text" class="form-control" name="API_SECRET" value="{{ settings.API_SECRET }}">
                  </div>
                  <div class="col-12">
                    <hr>
                    <h6>Kademeli Fiyat Kuralları</h6>
                    <p class="text-muted small">Fiyat aralıklarına göre kar oranı belirleyin. Kural yoksa varsayılan
                      çarpan kullanılır.</p>
                    <div id="trendyol_rules_container" class="mb-3"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPriceRule('trendyol')"><i
                        class="bi bi-plus-circle me-1"></i> Kural Ekle</button>
                    <input type="hidden" name="TRENDYOL_PRICE_RULES" id="TRENDYOL_PRICE_RULES_HIDDEN"
                      value='{{ settings.TRENDYOL_PRICE_RULES }}'>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka Adı</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="TRENDYOL_BRAND_NAME" name="TRENDYOL_BRAND_NAME"
                        value="{{ settings.TRENDYOL_BRAND_NAME }}" placeholder="Örn: Nike">
                      <button type="button" class="btn btn-primary" id="searchTrendyolBrand">
                        <i class="bi bi-search"></i> Marka ID Bul
                      </button>
                    </div>
                    <div class="form-text">Ürün gönderirken kullanılacak varsayılan marka</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka ID</label>
                    <input class="form-control" id="TRENDYOL_BRAND_ID" name="TRENDYOL_BRAND_ID"
                      value="{{ settings.TRENDYOL_BRAND_ID }}" readonly>
                    <div class="form-text">Trendyol'daki marka ID numarası</div>
                  </div>
                  <div class="col-12">
                    <hr>
                    <button type="button" class="btn btn-outline-info" id="fetchCategoriesBtn">
                      <i class="bi bi-diagram-3 me-1"></i> Kategorileri Çek
                    </button>
                    <button type="button" class="btn btn-outline-warning ms-2" id="fetchBrandsBtn">
                      <i class="bi bi-tags me-1"></i> Markaları Çek
                    </button>
                    <button type="button" class="btn btn-outline-danger ms-2" id="clearTrendyolCacheBtn">
                      <i class="bi bi-trash me-1"></i> Önbellek Temizle
                    </button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('trendyol')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                  </div>
                </div>
              </form>
            </div>

            <!-- Hepsiburada -->
            <div class="tab-pane fade" id="hb-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label fw-bold">Merchant ID</label><input class="form-control"
                      name="HB_MERCHANT_ID" value="{{ settings.HB_MERCHANT_ID }}"></div>
                  <div class="col-md-6"><label class="form-label fw-bold">Service Key (Servis Anahtarı)</label><input
                      class="form-control" name="HB_SERVICE_KEY" value="{{ settings.HB_SERVICE_KEY }}"></div>
                  <div class="col-12">
                    <hr>
                    <h6>Kademeli Fiyat Kuralları</h6>
                    <div id="hepsiburada_rules_container" class="mb-3"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary"
                      onclick="addPriceRule('hepsiburada')"><i class="bi bi-plus-circle me-1"></i> Kural Ekle</button>
                    <input type="hidden" name="HB_PRICE_RULES" id="HB_PRICE_RULES_HIDDEN"
                      value='{{ settings.HB_PRICE_RULES }}'>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Varsayılan Marka Adı</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="HB_BRAND_NAME" name="HB_BRAND_NAME"
                        value="{{ settings.HB_BRAND_NAME }}" placeholder="Örn: Samsung">
                      <button type="button" class="btn btn-primary" id="searchHBBrand"><i class="bi bi-search"></i>
                        Bul</button>
                    </div>
                    <div class="form-text">XML'de marka yoksa bu marka kullanılır.</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Varsayılan Marka ID</label>
                    <input class="form-control" id="HB_BRAND_ID" name="HB_BRAND_ID" value="{{ settings.HB_BRAND_ID }}"
                      readonly>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('hepsiburada')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                    <button type="button" class="btn btn-outline-danger ms-2" id="clearHBCacheBtn">
                      <i class="bi bi-trash me-1"></i> Önbellek Temizle
                    </button>
                  </div>
                </div>
              </form>
            </div>

            <!-- Pazarama -->
            <div class="tab-pane fade" id="pazarama-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <div class="row g-3">
                  <div class="col-md-4"><label class="form-label fw-bold">API Key</label><input class="form-control"
                      name="PAZARAMA_API_KEY" value="{{ settings.PAZARAMA_API_KEY }}"></div>
                  <div class="col-md-4"><label class="form-label fw-bold">API Secret</label><input class="form-control"
                      name="PAZARAMA_API_SECRET" value="{{ settings.PAZARAMA_API_SECRET }}"></div>
                  <div class="col-12">
                    <hr>
                    <h6>Kademeli Fiyat Kuralları</h6>
                    <div id="pazarama_rules_container" class="mb-3"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPriceRule('pazarama')"><i
                        class="bi bi-plus-circle me-1"></i> Kural Ekle</button>
                    <input type="hidden" name="PAZARAMA_PRICE_RULES" id="PAZARAMA_PRICE_RULES_HIDDEN"
                      value='{{ settings.PAZARAMA_PRICE_RULES }}'>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka Adı</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="PAZARAMA_BRAND_NAME" name="PAZARAMA_BRAND_NAME"
                        value="{{ settings.PAZARAMA_BRAND_NAME }}">
                      <button type="button" class="btn btn-primary" id="searchPazaramaBrand"><i
                          class="bi bi-search"></i> Bul</button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka ID</label>
                    <input class="form-control" id="PAZARAMA_BRAND_ID" name="PAZARAMA_BRAND_ID"
                      value="{{ settings.PAZARAMA_BRAND_ID }}" readonly>
                  </div>
                  <div class="col-12">
                    <hr>
                    <button type="button" class="btn btn-outline-info" id="fetchPazaramaCategoriesBtn"><i
                        class="bi bi-diagram-3 me-1"></i> Kategorileri Çek</button>
                    <button type="button" class="btn btn-outline-warning ms-2" id="clearPazaramaCacheBtn"><i
                        class="bi bi-trash me-1"></i> Önbellek Temizle</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('pazarama')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                  </div>
                  <div class="col-12 mt-3"><button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i>
                      Kaydet</button></div>
                </div>
              </form>
            </div>

            <!-- İdefix -->
            <div class="tab-pane fade" id="idefix-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label fw-bold">API Key</label><input class="form-control"
                      name="IDEFIX_API_KEY" value="{{ settings.IDEFIX_API_KEY }}"></div>
                  <div class="col-md-6"><label class="form-label fw-bold">API Secret</label><input class="form-control"
                      name="IDEFIX_API_SECRET" value="{{ settings.IDEFIX_API_SECRET }}"></div>
                  <div class="col-md-6"><label class="form-label fw-bold">Vendor ID</label><input class="form-control"
                      name="IDEFIX_VENDOR_ID" value="{{ settings.IDEFIX_VENDOR_ID }}"></div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Marka Adı</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="IDEFIX_BRAND_NAME" name="IDEFIX_BRAND_NAME"
                        value="{{ settings.IDEFIX_BRAND_NAME }}">
                      <button type="button" class="btn btn-primary" id="searchIdefixBrand"><i class="bi bi-search"></i>
                        Bul</button>
                    </div>
                  </div>
                  <div class="col-md-6"><label class="form-label fw-bold">Marka ID</label><input class="form-control"
                      id="IDEFIX_BRAND_ID" name="IDEFIX_BRAND_ID" value="{{ settings.IDEFIX_BRAND_ID }}"></div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Varsayılan Kategori ID (Zorunlu)</label>
                    <input type="text" class="form-control" name="IDEFIX_DEFAULT_CATEGORY_ID"
                      value="{{ settings.IDEFIX_DEFAULT_CATEGORY_ID }}" placeholder="Örn: 12345">
                    <div class="form-text">Yeni ürün oluşturulurken kullanılır.</div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Barkod Ön Eki Temizle</label>
                    <input type="text" class="form-control" name="IDEFIX_BARCODE_PREFIX"
                      value="{{ settings.IDEFIX_BARCODE_PREFIX }}" placeholder="Örn: BGZ">
                    <div class="form-text">Bu ön ek barkoddan silinir.</div>
                  </div>

                  <div class="col-md-12 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="idefixRandomBarcode"
                        name="IDEFIX_USE_RANDOM_BARCODE" {% if settings.IDEFIX_USE_RANDOM_BARCODE=='on' %}checked{%
                        endif %}>
                      <label class="form-check-label" for="idefixRandomBarcode">Barkod geçersizse rastgele barkod
                        oluştur (GEN-XXXXXX)</label>
                    </div>
                  </div>

                  <div class="col-12">
                    <hr>
                    <h6>Kademeli Fiyat Kuralları</h6>
                    <div id="idefix_rules_container" class="mb-3"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPriceRule('idefix')"><i
                        class="bi bi-plus-circle me-1"></i> Kural Ekle</button>
                    <input type="hidden" name="IDEFIX_PRICE_RULES" id="IDEFIX_PRICE_RULES_HIDDEN"
                      value='{{ settings.IDEFIX_PRICE_RULES }}'>
                  </div>

                  <div class="col-12 mt-3">
                    <button type="button" class="btn btn-outline-info" id="fetchIdefixCategoriesBtn">
                      <i class="bi bi-diagram-3 me-1"></i> Kategorileri Çek
                    </button>
                    <button type="submit" class="btn btn-success ms-2"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('idefix')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                    <button type="button" class="btn btn-outline-danger ms-2" id="clearIdefixCacheBtn">
                      <i class="bi bi-trash me-1"></i> Önbellek Temizle
                    </button>
                  </div>
                </div>
              </form>
            </div>

            <!-- N11 -->
            <div class="tab-pane fade" id="n11-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">App Key (API Anahtarı)</label>
                    <input class="form-control" name="N11_API_KEY" value="{{ settings.N11_API_KEY }}" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">App Secret (Gizli Anahtar)</label>
                    <input class="form-control" name="N11_API_SECRET" value="{{ settings.N11_API_SECRET }}" required>
                  </div>
                  <div class="col-12">
                    <hr>
                    <h6>Kademeli Fiyat Kuralları</h6>
                    <div id="n11_rules_container" class="mb-3"></div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPriceRule('n11')"><i
                        class="bi bi-plus-circle me-1"></i> Kural Ekle</button>
                    <input type="hidden" name="N11_PRICE_RULES" id="N11_PRICE_RULES_HIDDEN"
                      value='{{ settings.N11_PRICE_RULES }}'>
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label fw-bold">Varsayılan Marka (Zorunlu İçin)</label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="N11_DEFAULT_BRAND" name="N11_DEFAULT_BRAND"
                        value="{{ settings.N11_DEFAULT_BRAND }}" placeholder="Örn: Apple">
                      <button type="button" class="btn btn-primary" id="searchN11Brand"><i class="bi bi-search"></i>
                        Bul</button>
                    </div>
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label fw-bold">Marka ID (Otomatik)</label>
                    <input class="form-control" id="N11_DEFAULT_BRAND_ID" name="N11_DEFAULT_BRAND_ID"
                      value="{{ settings.N11_DEFAULT_BRAND_ID }}" readonly placeholder="Marka ID">
                  </div>
                  <div class="col-md-6 mt-3">
                    <label class="form-label fw-bold">Kargo Şablonu İsmi</label>
                    <input class="form-control" name="N11_DEFAULT_SHIPMENT_TEMPLATE"
                      value="{{ settings.N11_DEFAULT_SHIPMENT_TEMPLATE }}" placeholder="Örn: Standart">
                    <div class="form-text">N11 panelinizdeki kargo şablonu ismiyle birebir aynı olmalıdır.</div>
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('n11')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                    <button type="button" class="btn btn-outline-info ms-2" id="fetchN11DataBtn">
                      <i class="bi bi-diagram-3 me-1"></i> Kategorileri Çek
                    </button>
                    <button type="button" class="btn btn-outline-danger ms-2" id="clearN11CacheBtn">
                      <i class="bi bi-trash me-1"></i> Önbellek Temizle
                    </button>
                  </div>
                </div>
              </form>
            </div>

            <!-- Ikas -->
            <div class="tab-pane fade" id="ikas-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">Ikas Shop URL</label>
                    <input class="form-control" name="IKAS_SHOP_URL" value="{{ settings.IKAS_SHOP_URL }}"
                      placeholder="https://myshop.ikas.com">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">API Token (Bearer)</label>
                    <input class="form-control" name="IKAS_API_TOKEN" value="{{ settings.IKAS_API_TOKEN }}"
                      placeholder="API Token">
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('ikas')">
                      <i class="bi bi-wifi me-1"></i> Bağlantı Testi
                    </button>
                  </div>
                </div>
              </form>
            </div>
            <!-- BUG-Z -->
            <div class="tab-pane fade" id="bugz-pane">
              <form method="POST" action="{{ url_for('main.settings_page') }}">
                <div class="alert alert-success border-0 shadow-sm mb-3">
                  <h6 class="alert-heading fw-bold"><i class="bi bi-info-circle me-2"></i>BUG-Z / Quakasoft Entegrasyonu
                  </h6>
                  <p class="mb-0 small">
                    Siparişlerinizin otomatik olarak BUG-Z ERP sistemine aktarılması için API bilgilerinizi
                    tanımlayınız.
                  </p>
                </div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">BUG-Z API Key</label>
                    <input type="text" class="form-control" name="BUGZ_API_KEY" value="{{ settings.BUGZ_API_KEY }}"
                      required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">BUG-Z API Secret</label>
                    <input type="text" class="form-control" name="BUGZ_API_SECRET"
                      value="{{ settings.BUGZ_API_SECRET }}" required>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label fw-bold">API URL</label>
                    <input type="text" class="form-control" name="BUGZ_API_URL"
                      value="{{ settings.BUGZ_API_URL or 'https://bug-z.com/api/v2' }}">
                  </div>
                  <div class="col-12 mt-3">
                    <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i> Kaydet</button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="testConnection('bugz')">
                      <i class="bi bi-wifi me-1"></i> Bağlantıyı Test Et
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div> <!-- End tab-content -->
        </div> <!-- End accordion-body -->
      </div> <!-- End accordion-collapse -->
    </div> <!-- End accordion-item (Pazaryeri) -->

    <!-- Ödeme Ayarları (Shopier) -->


    <!-- XML Kaynakları -->
    <div class="accordion-item">
      <h2 class="accordion-header">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#xmlCollapse">
          <i class="bi bi-file-code me-2"></i>
          XML Kaynakları
        </button>
      </h2>
      <div id="xmlCollapse" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
        <div class="accordion-body">

          <!-- XML Tablo ve Form -->
          <ul class="nav nav-tabs mb-3" id="xmlSourceTypeTabs">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#xmlUrlPane" type="button">URL
                Ekle</button>
            </li>
          </ul>

          <div class="tab-content mb-3">
            <div class="tab-pane fade show active" id="xmlUrlPane">
              <div class="row g-2 align-items-end">
                {% if current_user.has_plan_feature('add_xml_source') %}
                <div class="col-md-3"><label class="form-label">İsim</label><input id="xmlName" class="form-control"
                    placeholder="Tedarikçi A"></div>
                <div class="col-md-6"><label class="form-label">XML URL</label><input id="xmlUrl" class="form-control"
                    placeholder="https://.../urunler.xml"></div>
                <div class="col-md-3"><button id="btnAddXml" type="button" class="btn btn-primary w-100"><i
                      class="bi bi-plus-lg me-1"></i> Ekle</button></div>
                {% else %}
                <div class="col-12">
                  <div class="alert alert-warning border-0 shadow-sm">
                    <i class="bi bi-lock-fill me-2"></i>
                    XML Ekleme özelliği mevcut planınızda ({{ current_user.subscription.plan_display_name }})
                    kullanılamaz.
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>İsim</th>
                  <th>URL</th>
                  <th>Tarih</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="xmlTableBody">
                {% for x in xml_sources %}
                <tr data-id="{{ x.id }}">
                  <td>{{ x.id }}</td>
                  <td>{{ x.name }}</td>
                  <td class="text-truncate" style="max-width:400px">{{ x.url }}</td>
                  <td>{{ x.created_at }}</td>
                  <td><button class="btn btn-sm btn-outline-danger btnDelXml">Sil</button></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div> <!-- End accordion-item (XML) -->

  </div> <!-- End settingsAccordion -->
</div> <!-- End card -->
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {

    // Global Test Connection Function
    window.testConnection = function (marketplace) {
      Swal.fire({ title: 'Test Ediliyor...', didOpen: () => Swal.showLoading() });
      fetch(`/api/test_connection/${marketplace}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Başarılı', data.message, 'success');
          } else {
            Swal.fire('Başarısız', data.message, 'error');
          }
        })
        .catch(err => Swal.fire('Hata', 'Sunucu hatası: ' + err, 'error'));
    };

    // Generic Cache Clear
    function bindCacheClear(btnId, mp) {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.addEventListener('click', function () {
          Swal.fire({
            title: mp + ' Önbellek Temizle',
            text: 'Önbellek temizlensin mi?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet',
            cancelButtonText: 'Hayır'
          }).then((result) => {
            if (result.isConfirmed) {
              Swal.fire({ title: 'Temizleniyor...', didOpen: () => Swal.showLoading() });
              let url = `/api/${mp.toLowerCase()}/clear_cache`;
              if (mp === 'Trendyol') url = '/api/clear_all_cache';

              fetch(url, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                  Swal.fire(data.success ? 'Başarılı' : 'Hata', data.message, data.success ? 'success' : 'error')
                    .then(() => { if (data.success) location.reload(); });
                })
                .catch(e => Swal.fire('Hata', 'Sunucu hatası: ' + e, 'error'));
            }
          });
        });
      }
    }

    bindCacheClear('clearTrendyolCacheBtn', 'Trendyol');
    bindCacheClear('clearHBCacheBtn', 'Hepsiburada');
    bindCacheClear('clearPazaramaCacheBtn', 'Pazarama');
    bindCacheClear('clearIdefixCacheBtn', 'Idefix');
    bindCacheClear('clearN11CacheBtn', 'N11');


    // Generic Fetch Categories
    function bindFetchCategories(btnId, url) {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.addEventListener('click', function () {
          Swal.fire({ title: 'İstek Gönderiliyor...', didOpen: () => Swal.showLoading() });
          fetch(url, { method: 'POST' })
            .then(async r => {
              const text = await r.text();
              try {
                return JSON.parse(text);
              } catch (e) {
                console.error("JSON parse error. Response was:", text);
                const snippet = text.substring(0, 200) + "...";
                throw new Error("Sunucu geçersiz bir yanıt döndürdü (JSON değil). Yanıt özeti: " + snippet);
              }
            })
            .then(data => {
              if (data.success && data.job_id) {
                // Background job started - monitor it
                monitorBackgroundJob(data.job_id);
              } else {
                Swal.fire(data.success ? 'Başarılı' : 'Hata', data.message, data.success ? 'success' : 'error');
              }
            })
            .catch(e => {
              console.error("Fetch error:", e);
              Swal.fire('Hata', 'İstek hatası: ' + e.message, 'error');
            });
        });
      }
    }

    function monitorBackgroundJob(jobId) {
      let pollCount = 0;
      const swalInstance = Swal.fire({
        title: 'İşlem Başlatıldı',
        html: '<div class="text-start"><p id="job-status">Hazırlanıyor...</p><div class="progress mb-2"><div id="job-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div></div><pre id="job-logs" style="font-size: 11px; max-height: 150px; overflow-y: auto; background: #eee; padding: 5px;"></pre></div>',
        showConfirmButton: false,
        allowOutsideClick: false,
        didOpen: () => {
          const poll = () => {
            fetch(`/api/job/status/${jobId}`)
              .then(r => r.json())
              .then(data => {
                if (!data.success) {
                  Swal.fire('Hata', data.message, 'error');
                  return;
                }

                const status = data.status;
                const progress = data.progress || {};
                const logs = data.logs || [];
                const res = data.result || {};

                // Update UI
                const statusEl = document.getElementById('job-status');
                const progressEl = document.getElementById('job-progress');
                const logsEl = document.getElementById('job-logs');

                if (statusEl) statusEl.innerText = progress.message || `Durum: ${status}`;
                if (progressEl && progress.current && progress.total) {
                  const percent = Math.round((progress.current / progress.total) * 100);
                  progressEl.style.width = percent + '%';
                } else if (progressEl && progress.current) {
                  // Generic progress if no total
                  progressEl.style.width = '100%';
                }

                if (logsEl && logs.length > 0) {
                  logsEl.innerText = logs.map(l => `[${l.ts.substring(11, 19)}] ${l.message}`).join('\n');
                  logsEl.scrollTop = logsEl.scrollHeight;
                }

                if (status === 'completed') {
                  Swal.fire('Başarılı', res.message || 'İşlem başarıyla tamamlandı.', 'success')
                    .then(() => location.reload());
                } else if (status === 'failed') {
                  Swal.fire('Hata', data.error || 'İşlem sırasında bir hata oluştu.', 'error');
                } else if (status === 'cancelled') {
                  Swal.fire('İptal Edildi', 'İşlem kullanıcı tarafından iptal edildi.', 'warning');
                } else {
                  // Continue polling
                  pollCount++;
                  setTimeout(poll, 2000);
                }
              })
              .catch(err => {
                console.error("Polling error:", err);
                setTimeout(poll, 5000); // Retry later
              });
          };
          poll();
        }
      });
    }

    bindFetchCategories('fetchCategoriesBtn', '{{ url_for("main.fetch_trendyol_categories") }}');
    bindFetchCategories('fetchPazaramaCategoriesBtn', '{{ url_for("main.fetch_pazarama_categories") }}');
    bindFetchCategories('fetchIdefixCategoriesBtn', '{{ url_for("main.fetch_idefix_categories") }}');
    bindFetchCategories('fetchN11DataBtn', '{{ url_for("main.fetch_n11_categories") }}');


    // Generic Fetch Brands
    function bindFetchBrands(btnId, url) {
      const btn = document.getElementById(btnId);
      if (btn) {
        btn.addEventListener('click', function () {
          Swal.fire({
            title: 'Markalar Çekiliyor...',
            text: 'Bu işlem uzun sürebilir.',
            didOpen: () => Swal.showLoading()
          });
          fetch(url, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
              Swal.fire(data.success ? 'Başarılı' : 'Hata', data.message, data.success ? 'success' : 'error');
            })
            .catch(e => Swal.fire('Hata', 'İstek hatası: ' + e, 'error'));
        });
      }
    }
    bindFetchBrands('fetchBrandsBtn', '/api/trendyol/fetch_brands');

    // Trendyol Brand Search
    document.getElementById('searchTrendyolBrand')?.addEventListener('click', function () {
      const brandName = document.getElementById('TRENDYOL_BRAND_NAME').value.trim();
      if (!brandName) {
        Swal.fire('Uyarı', 'Lütfen marka adı giriniz.', 'warning');
        return;
      }

      Swal.fire({
        title: 'Aranıyor...',
        text: 'Trendyol API\'den marka bilgisi alınıyor',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      fetch('/api/trendyol/search_brand', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brand_name: brandName })
      })
        .then(r => r.json())
        .then(data => {
          Swal.close();
          if (data.success && data.brand_id) {
            document.getElementById('TRENDYOL_BRAND_ID').value = data.brand_id;
            Swal.fire({
              icon: 'success',
              title: 'Bulundu!',
              html: `<strong>${data.brand_name}</strong><br>ID: ${data.brand_id}`,
              timer: 2000
            });
          } else {
            Swal.fire('Bulunamadı', data.message || 'Marka bulunamadı. Lütfen farklı bir isim deneyin.', 'error');
          }
        })
        .catch(err => {
          Swal.close();
          Swal.fire('Hata', 'Marka arama sırasında bir hata oluştu: ' + err, 'error');
        });
    });

    // Brand Search Logic
    document.querySelectorAll('[id^="search"]').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.id;
        let mp = '';
        let inputId = '';
        let resultId = '';
        let apiUrl = '';

        if (id === 'searchTrendyolBrand') return; // Handled below
        if (id === 'searchIdefixBrand') return; // Handled below

        if (id === 'searchPazaramaBrand') {
          mp = 'Pazarama';
          inputId = 'PAZARAMA_BRAND_NAME';
          resultId = 'PAZARAMA_BRAND_ID';
          apiUrl = '/api/pazarama/search_brand';
        } else if (id === 'searchHepsiburadaBrand' || id === 'searchHBBrand') {
          mp = 'Hepsiburada';
          inputId = 'HB_BRAND_NAME';
          resultId = 'HB_BRAND_ID';
          apiUrl = '/api/hepsiburada/search_brand';
        } else if (id === 'searchN11Brand') {
          mp = 'N11';
          inputId = 'N11_DEFAULT_BRAND';
          resultId = 'N11_DEFAULT_BRAND_ID';
          apiUrl = '/api/n11/search_brand';
        }

        if (!mp) return;

        const name = document.getElementById(inputId).value.trim();
        if (!name) { Swal.fire('Uyarı', 'Marka adı girin', 'warning'); return; }

        Swal.fire({ title: 'Aranıyor...', didOpen: () => Swal.showLoading() });

        fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ brand_name: name })
        })
          .then(r => r.json())
          .then(j => {
            if (j.success && (j.brand || j.brand_id)) {
              const b = j.brand || { id: j.brand_id, name: j.brand_name };
              document.getElementById(resultId).value = b.id;
              Swal.fire('Bulundu', `${b.name || b.title || name} (ID: ${b.id})`, 'success');
            }
            else Swal.fire('Bulunamadı', j.message || '', 'warning');
          })
          .catch(err => Swal.fire('Hata', err.message, 'error'));
      });
    });

    // Idefix Brand Search Logic (Preserved)
    document.getElementById('searchIdefixBrand')?.addEventListener('click', function () {
      const name = document.getElementById('IDEFIX_BRAND_NAME').value.trim();
      if (!name) { Swal.fire('Uyarı', 'Marka adı girin', 'warning'); return; }
      Swal.fire({ title: 'Aranıyor...', didOpen: () => Swal.showLoading() });
      fetch('/api/idefix/search_brand', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ brand_name: name }) })
        .then(r => r.json()).then(j => {
          if (j.success && j.brand) { document.getElementById('IDEFIX_BRAND_ID').value = j.brand.id; Swal.fire('Bulundu', 'ID: ' + j.brand.id, 'success'); }
          else Swal.fire('Bulunamadı', '', 'warning');
        });
    });


    // XML Add
    document.getElementById('btnAddXml')?.addEventListener('click', function () {
      const name = document.getElementById('xmlName').value.trim();
      const url = document.getElementById('xmlUrl').value.trim();
      if (!name || !url) { Swal.fire('Uyarı', 'İsim ve URL gerekli', 'warning'); return; }
      fetch('/api/xml_sources', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, url }) })
        .then(r => r.json()).then(j => { if (j.success) location.reload(); else Swal.fire('Hata', j.message, 'error'); });
    });

    // XML Delete
    document.querySelectorAll('.btnDelXml').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.closest('tr').getAttribute('data-id');
        Swal.fire({ title: 'Sil?', icon: 'warning', showCancelButton: true }).then(res => {
          if (res.isConfirmed) fetch('/api/xml_sources/' + id, { method: 'DELETE' }).then(r => r.json()).then(j => { if (j.success) location.reload(); });
        });
      });
    });

    // --- Global Price Rules Logic (Tüm Pazaryerlerine Ortak) ---
    window.globalPriceRules = [];

    function initGlobalPriceRules() {
      const hiddenInput = document.getElementById('GLOBAL_PRICE_RULES_HIDDEN');
      if (hiddenInput && hiddenInput.value) {
        try {
          window.globalPriceRules = JSON.parse(hiddenInput.value);
        } catch (e) {
          console.error('Error parsing global price rules:', e);
          window.globalPriceRules = [];
        }
      }
      renderGlobalRules();
    }

    window.addGlobalPriceRule = function () {
      window.globalPriceRules.push({ min: 0, max: 1000, percent: 10, fixed: 0 });
      renderGlobalRules();
      saveGlobalRules();
    };

    window.removeGlobalPriceRule = function (index) {
      window.globalPriceRules.splice(index, 1);
      renderGlobalRules();
      saveGlobalRules();
    };

    window.updateGlobalPriceRule = function (index, field, value) {
      window.globalPriceRules[index][field] = parseFloat(value) || 0;
      saveGlobalRules();
    };

    function renderGlobalRules() {
      const container = document.getElementById('global_rules_container');
      if (!container) return;

      if (window.globalPriceRules.length === 0) {
        container.innerHTML = `
          <div class="alert alert-warning py-3 text-center">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Henüz tanımlı kural yok. "Yeni Kural Ekle" butonuna tıklayarak başlayın.
          </div>`;
        return;
      }

      let html = '<div class="table-responsive"><table class="table table-bordered align-middle mb-0">';
      html += '<thead class="table-light"><tr><th style="width:20%">Min Fiyat (>=)</th><th style="width:20%">Max Fiyat (<)</th><th style="width:20%">Kâr Yüzdesi (%)</th><th style="width:20%">Ek Sabit (TL)</th><th style="width:10%"></th></tr></thead><tbody>';

      window.globalPriceRules.forEach((rule, idx) => {
        html += `<tr>
          <td><div class="input-group input-group-sm"><span class="input-group-text">₺</span><input type="number" step="0.01" class="form-control" value="${rule.min}" onchange="updateGlobalPriceRule(${idx}, 'min', this.value)"></div></td>
          <td><div class="input-group input-group-sm"><span class="input-group-text">₺</span><input type="number" step="0.01" class="form-control" value="${rule.max || 999999}" onchange="updateGlobalPriceRule(${idx}, 'max', this.value)"></div></td>
          <td><div class="input-group input-group-sm"><input type="number" step="0.1" class="form-control" value="${rule.percent}" onchange="updateGlobalPriceRule(${idx}, 'percent', this.value)"><span class="input-group-text">%</span></div></td>
          <td><div class="input-group input-group-sm"><span class="input-group-text">₺</span><input type="number" step="0.01" class="form-control" value="${rule.fixed || 0}" onchange="updateGlobalPriceRule(${idx}, 'fixed', this.value)"></div></td>
          <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeGlobalPriceRule(${idx})"><i class="bi bi-trash"></i></button></td>
        </tr>`;
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function saveGlobalRules() {
      const hiddenInput = document.getElementById('GLOBAL_PRICE_RULES_HIDDEN');
      if (hiddenInput) {
        hiddenInput.value = JSON.stringify(window.globalPriceRules);
      }
    }

    initGlobalPriceRules();
    // --- End Global Price Rules Logic ---

    // Password Visibility Toggle
    window.togglePassword = function (btn) {
      const input = btn.previousElementSibling;
      if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
      } else {
        input.type = 'password';
        btn.innerHTML = '<i class="bi bi-eye"></i>';
      }
    };

  });
</script>
{% endblock %}