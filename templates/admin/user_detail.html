{% extends "admin/_base.html" %}

{% block title %}{{ user.full_name or user.email }}{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>
        <a href="{{ url_for('admin.users') }}" class="text-muted text-decoration-none me-2">
            <i class="bi bi-arrow-left"></i>
        </a>
        Kullanıcı Detayı
    </h1>
</div>

<div class="row g-4">
    <!-- User Info Card -->
    <div class="col-lg-4">
        <div class="admin-card">
            <div class="text-center mb-4">
                <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center"
                    style="width: 80px; height: 80px;">
                    <i class="bi bi-person-fill display-5"></i>
                </div>
                <h4 class="mt-3 mb-1">{{ user.full_name or 'İsimsiz' }}</h4>
                <p class="text-muted mb-2">{{ user.email }}</p>

                {% if user.is_banned %}
                <span class="badge bg-danger">Banlı</span>
                {% elif user.email == 'bugraerkaradeniz34@gmail.com' %}
                <span class="badge badge-admin">Ana Admin</span>
                {% elif user.is_admin %}
                <span class="badge bg-info">Yönetici</span>
                {% elif user.is_support %}
                <span class="badge bg-primary">Destek</span>
                {% elif user.is_active %}
                <span class="badge bg-success">Aktif</span>
                {% else %}
                <span class="badge bg-warning">Pasif</span>
                {% endif %}
            </div>

            <hr>

            <div class="mb-3">
                <small class="text-muted">Kayıt Tarihi</small>
                <p class="mb-0">{{ user.created_at.strftime('%d.%m.%Y %H:%M') if user.created_at else '-' }}</p>
            </div>

            <div class="mb-3">
                <small class="text-muted">Son Giriş</small>
                <p class="mb-0">{{ user.last_login.strftime('%d.%m.%Y %H:%M') if user.last_login else 'Hiç giriş
                    yapmadı' }}</p>
            </div>

            {% if user.is_banned and user.ban_reason %}
            <div class="mb-3">
                <small class="text-muted">Ban Sebebi</small>
                <p class="mb-0 text-danger">{{ user.ban_reason }}</p>
            </div>
            {% endif %}

            <!-- Ticari Bilgiler -->
            <div class="mt-4 pt-3 border-top">
                <h6 class="small fw-bold text-primary text-uppercase mb-3">Ticari Bilgiler</h6>
                <div class="mb-2">
                    <small class="text-muted d-block">Firma Ünvanı</small>
                    <span class="small">{{ user.company_title or '-' }}</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Vergi No / TC</small>
                    <span class="small">{{ user.tax_no or '-' }}</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Vergi Dairesi</small>
                    <span class="small">{{ user.tax_office or '-' }}</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Telefon</small>
                    <span class="small">{{ user.phone or '-' }}</span>
                </div>
                <div>
                    <small class="text-muted d-block">Adres</small>
                    <span class="small">{{ user.city or '' }} {{ user.district or '' }} / {{ user.address or '-'
                        }}</span>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="admin-card mt-4">
            <h6 class="mb-3"><i class="bi bi-gear me-2"></i>İşlemler</h6>

            <a href="{{ url_for('admin.user_orders', user_id=user.id) }}" class="btn btn-outline-info w-100 mb-2">
                <i class="bi bi-box-seam me-2"></i>Siparişleri Gör
            </a>

            <a href="{{ url_for('admin.user_activity_logs', user_id=user.id) }}"
                class="btn btn-outline-primary w-100 mb-2">
                <i class="bi bi-journal-text me-2"></i>İşlem Loglarını Gör
            </a>

            {% if not user.is_admin %}
            <form action="{{ url_for('admin.impersonate_user', user_id=user.id) }}" method="POST" class="mb-2">
                <button type="submit" class="btn btn-info w-100 text-white">
                    <i class="bi bi-eyeglasses me-2"></i>Kullanıcı Olarak Gör
                </button>
            </form>

            <!-- Support Toggle (Super Admin Only) -->
            {% if current_user.is_super_admin and user.email != 'bugraerkaradeniz34@gmail.com' %}
            <form action="{{ url_for('admin.toggle_support_route', user_id=user.id) }}" method="POST" class="mb-2">
                <button type="submit"
                    class="btn btn-{{ 'outline-primary' if not user.is_support else 'outline-warning' }} w-100">
                    <i class="bi bi-headset me-2"></i>
                    {{ 'Destek Yetkisi Ver' if not user.is_support else 'Destek Yetkisini Kaldır' }}
                </button>
            </form>
            {% endif %}

            <a href="{{ url_for('admin.user_permissions', user_id=user.id) }}" class="btn btn-warning w-100 mb-2">
                <i class="bi bi-key me-2"></i>İzinleri Düzenle
            </a>

            <!-- Edit Profile Button -->
            <button type="button" class="btn btn-outline-secondary w-100 mb-2" data-bs-toggle="modal"
                data-bs-target="#editProfileModal">
                <i class="bi bi-pencil-square me-2"></i>Bilgileri Düzenle
            </button>

            {% if current_user.is_super_admin %}
            {% if user.is_banned %}
            <form action="{{ url_for('admin.unban_user_route', user_id=user.id) }}" method="POST">
                <button type="submit" class="btn btn-success w-100 mb-2">
                    <i class="bi bi-person-check me-2"></i>Banı Kaldır
                </button>
            </form>
            {% else %}
            <button type="button" class="btn btn-danger w-100 mb-2" data-bs-toggle="modal" data-bs-target="#banModal">
                <i class="bi bi-person-x me-2"></i>Kullanıcıyı Banla
            </button>
            {% endif %}

            {% if not user.is_email_verified %}
            <form action="{{ url_for('admin.verify_user_route', user_id=user.id) }}" method="POST" class="mb-2">
                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-patch-check me-2"></i>Manuel Doğrula
                </button>
            </form>
            {% endif %}

            <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal"
                data-bs-target="#deleteModal">
                <i class="bi bi-trash me-2"></i>Hesabı Sil
            </button>
            {% else %}
            <div class="alert alert-info py-2 px-3 small border-0 mb-0">
                <i class="bi bi-info-circle me-2"></i>Kritik işlemler (Silme, Banlama) sadece Ana Yönetici tarafından
                yapılabilir.
            </div>
            {% endif %}
            {% else %}
            <p class="text-muted text-center mb-0">
                <i class="bi bi-shield-lock me-2"></i>{{ 'Ana Admin' if user.email == 'bugraerkaradeniz34@gmail.com'
                else 'Destek' if user.is_support else 'Yönetici' }} hesabı
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Stats & Subscription -->
    <div class="col-lg-8">
        <!-- Stats -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="admin-card text-center">
                    <h3 class="mb-0">{{ stats.products }}</h3>
                    <small class="text-muted">Ürün</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-card text-center">
                    <h3 class="mb-0">{{ stats.orders }}</h3>
                    <small class="text-muted">Sipariş</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-card text-center">
                    <h3 class="mb-0">{{ stats.xml_sources }}</h3>
                    <small class="text-muted">XML</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-card text-center">
                    <h3 class="mb-0">{{ stats.batch_logs }}</h3>
                    <small class="text-muted">İşlem</small>
                </div>
            </div>
        </div>

        <!-- Subscription -->
        <div class="admin-card mb-4">
            <h5 class="card-title"><i class="bi bi-credit-card text-danger"></i>Abonelik</h5>

            {% if user.subscription %}
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <small class="text-muted">Mevcut Plan</small>
                        <p class="mb-0">
                            <span
                                class="badge bg-{{ 'success' if user.subscription.plan in ['enterprise', 'bug-z-bayilik'] else 'primary' if user.subscription.plan == 'pro' else 'secondary' }} fs-6">
                                {{ user.subscription.plan_display_name }}
                            </span>
                            {% if not user.subscription.is_approved %}
                            <span class="badge bg-warning text-dark ms-2"><i class="bi bi-shield-lock"></i> Onay
                                Bekliyor</span>
                            {% endif %}
                        </p>
                    </div>
                    {% if not user.subscription.is_approved %}
                    <div class="mb-3">
                        <form action="{{ url_for('admin.approve_subscription_route', sub_id=user.subscription.id) }}"
                            method="POST">
                            <button type="submit"
                                class="btn btn-success p-2 px-4 shadow-sm animate__animated animate__pulse animate__infinite">
                                <i class="bi bi-check-circle me-2"></i> Aboneliği Onayla <i
                                    class="bi bi-arrow-right ms-2"></i>
                            </button>
                        </form>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <small class="text-muted">Durum</small>
                        <p class="mb-0">{{ user.subscription.status }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <small class="text-muted">Başlangıç</small>
                        <p class="mb-0">{{ user.subscription.start_date.strftime('%d.%m.%Y') if
                            user.subscription.start_date else '-' }}</p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">Bitiş</small>
                        <p class="mb-0">{{ user.subscription.end_date.strftime('%d.%m.%Y') if user.subscription.end_date
                            else 'Sınırsız' }}</p>
                    </div>
                </div>
            </div>

            <hr>

            <form action="{{ url_for('admin.update_subscription_route', user_id=user.id) }}" method="POST"
                class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Plan</label>
                    <select name="plan" class="form-select">
                        <option value="basic" {{ 'selected' if user.subscription.plan=='basic' else '' }}>Başlangıç
                        </option>
                        <option value="pro" {{ 'selected' if user.subscription.plan=='pro' else '' }}>Profesyonel
                        </option>
                        <option value="enterprise" {{ 'selected' if user.subscription.plan=='enterprise' else '' }}>
                            Kurumsal</option>
                        <option value="bug-z-bayilik" {{ 'selected' if user.subscription.plan=='bug-z-bayilik' else ''
                            }}>
                            BUG-Z Bayilik</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Bitiş Tarihi</label>
                    <input type="date" name="end_date" class="form-control"
                        value="{{ user.subscription.end_date.strftime('%Y-%m-%d') if user.subscription.end_date else '' }}">
                </div>

                <div class="col-12 border-top pt-3 mt-3">
                    <h6 class="text-muted mb-3"><i class="bi bi-sliders me-2"></i>Özel Limitler (Opsiyonel)</h6>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Ürün Limiti</label>
                    <div class="input-group">
                        <input type="number" name="max_products" class="form-control"
                            value="{{ user.subscription.max_products }}" placeholder="Varsayılan">
                        <span class="input-group-text">Adet</span>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">XML Kaynak Limiti</label>
                    <div class="input-group">
                        <input type="number" name="max_xml_sources" class="form-control"
                            value="{{ user.subscription.max_xml_sources }}" placeholder="Varsayılan">
                        <span class="input-group-text">Adet</span>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Pazaryeri Limiti</label>
                    <div class="input-group">
                        <input type="number" name="max_marketplaces" class="form-control"
                            value="{{ user.subscription.max_marketplaces }}" placeholder="Varsayılan">
                        <span class="input-group-text">Adet</span>
                    </div>
                </div>

                {% if current_user.is_super_admin %}
                <div class="col-12 mt-4">
                    <button type="submit" class="btn btn-admin w-100 py-2 shadow-sm">
                        <i class="bi bi-save me-2"></i>Aboneliği ve Limitleri Güncelle
                    </button>
                </div>
                {% else %}
                <div class="col-12 mt-4">
                    <div class="alert alert-light border small text-muted mb-0">
                        <i class="bi bi-lock me-2"></i>Abonelik paketlerini sadece Ana Yönetici güncelleyebilir.
                    </div>
                </div>
                {% endif %}
            </form>
            {% else %}
            <p class="text-muted">Abonelik bilgisi bulunamadı.</p>
            {% endif %}
        </div>

        <!-- Recent Activity -->
        <div class="admin-card">
            <h5 class="card-title"><i class="bi bi-clock-history text-danger"></i>Son İşlemler</h5>
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Batch ID</th>
                        <th>Pazar Yeri</th>
                        <th>Ürün</th>
                        <th>Durum</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in recent_logs %}
                    <tr>
                        <td><code>{{ log.batch_id[:8] }}...</code></td>
                        <td>{{ log.marketplace }}</td>
                        <td>{{ log.product_count }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if log.success else 'danger' }}">
                                {{ 'Başarılı' if log.success else 'Başarısız' }}
                            </span>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-muted text-center">Henüz işlem yok</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ban Modal -->
<div class="modal fade" id="banModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Kullanıcıyı Banla</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.ban_user_route', user_id=user.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Ban Sebebi</label>
                        <textarea name="reason" class="form-control" rows="3" placeholder="Opsiyonel..."></textarea>
                    </div>
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>{{ user.email }}</strong> hesabı banlanacak ve giriş yapamayacak.
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-danger">Banla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Hesabı Sil
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.delete_user_route', user_id=user.id) }}" method="POST">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Dikkat!</h6>
                        <p class="mb-0">
                            <strong>{{ user.email }}</strong> hesabı ve tüm verileri <strong>kalıcı olarak
                                silinecek</strong>.
                        </p>
                    </div>

                    <p class="text-muted mb-2">Silinecek veriler:</p>
                    <ul class="text-muted small">
                        <li>Tüm ürünler ({{ stats.products }})</li>
                        <li>Tüm siparişler ({{ stats.orders }})</li>
                        <li>Tüm XML kaynakları ({{ stats.xml_sources }})</li>
                        <li>Tüm işlem logları ({{ stats.batch_logs }})</li>
                        <li>Abonelik ve ödeme bilgileri</li>
                    </ul>

                    <p class="text-danger small mb-0">
                        <strong>Bu işlem geri alınamaz!</strong>
                    </p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>Evet, Sil
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('admin.update_user_profile', user_id=user.id) }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Kullanıcı Bilgilerini Düzenle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Personal Info -->
                        <div class="col-md-6">
                            <label class="form-label">Ad</label>
                            <input type="text" name="first_name" class="form-control"
                                value="{{ user.first_name or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Soyad</label>
                            <input type="text" name="last_name" class="form-control" value="{{ user.last_name or '' }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Tam Ad</label>
                            <input type="text" name="full_name" class="form-control" value="{{ user.full_name or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">E-posta</label>
                            <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telefon</label>
                            <input type="tel" name="phone" class="form-control" value="{{ user.phone or '' }}">
                        </div>

                        <hr class="my-3">

                        <!-- Company Info -->
                        <div class="col-12">
                            <label class="form-label">Firma Ünvanı</label>
                            <input type="text" name="company_title" class="form-control"
                                value="{{ user.company_title or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">TC Kimlik No</label>
                            <input type="text" name="tc_no" class="form-control" value="{{ user.tc_no or '' }}"
                                maxlength="11">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Vergi No</label>
                            <input type="text" name="tax_no" class="form-control" value="{{ user.tax_no or '' }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Vergi Dairesi</label>
                            <input type="text" name="tax_office" class="form-control"
                                value="{{ user.tax_office or '' }}">
                        </div>

                        <hr class="my-3">

                        <!-- Address -->
                        <div class="col-md-6">
                            <label class="form-label">İl</label>
                            <input type="text" name="city" class="form-control" value="{{ user.city or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">İlçe</label>
                            <input type="text" name="district" class="form-control" value="{{ user.district or '' }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Adres</label>
                            <textarea name="address" class="form-control" rows="2">{{ user.address or '' }}</textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-2"></i>Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}