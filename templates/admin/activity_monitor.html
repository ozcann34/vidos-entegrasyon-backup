{% extends "admin/_base.html" %}

{% block title %}Canlı Aktivite Monitörü{% endblock %}

{% block content %}
<div class="admin-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-broadcast me-2 text-danger"></i>Canlı Aktivite Monitörü</h1>
        <span class="text-muted">Kullanıcı işlemleri anlık olarak aşağıda listelenir.</span>
    </div>
    <div>
        <span class="badge bg-success" id="connectionStatus">Bağlı</span>
    </div>
</div>

<div class="card mt-4">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0" id="logsTable">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Zaman</th>
                        <th>Kullanıcı</th>
                        <th>İşlem</th>
                        <th>Pazaryeri</th>
                        <th>Detaylar</th>
                        <th>IP</th>
                    </tr>
                </thead>
                <tbody id="logsBody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let lastLogId = 0;

    function fetchLogs() {
        // Fetch all logs initially, then incrementally if needed. 
        // For simplicity, we just fetch last 50 every time to ensure order active.
        fetch('{{ url_for("admin.api_live_logs") }}?limit=50')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTable(data.logs);
                    document.getElementById('connectionStatus').className = 'badge bg-success';
                    document.getElementById('connectionStatus').innerText = 'Canlı';
                } else {
                    console.error('Error fetching logs:', data.message);
                    document.getElementById('connectionStatus').className = 'badge bg-warning';
                    document.getElementById('connectionStatus').innerText = 'Hata';
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                document.getElementById('connectionStatus').className = 'badge bg-danger';
                document.getElementById('connectionStatus').innerText = 'Bağlantı Koptu';
            });
    }

    function updateTable(logs) {
        const tbody = document.getElementById('logsBody');

        if (logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Henüz işlem yok.</td></tr>';
            return;
        }

        let html = '';
        logs.forEach(log => {
            let badgeClass = 'bg-secondary';
            if (log.action.includes('delete')) badgeClass = 'bg-danger';
            else if (log.action.includes('update')) badgeClass = 'bg-warning text-dark';
            else if (log.action.includes('create')) badgeClass = 'bg-success';
            else if (log.action.includes('send')) badgeClass = 'bg-info text-dark';

            html += `
                <tr class="animate__animated animate__fadeIn">
                    <td><small class="text-muted">#${log.id}</small></td>
                    <td>${log.time}</td>
                    <td><strong>${log.user}</strong></td>
                    <td><span class="badge ${badgeClass}">${log.action}</span></td>
                    <td>${log.marketplace}</td>
                    <td><code>${log.details}</code></td>
                    <td><small class="text-muted">${log.ip || '-'}</small></td>
                </tr>
            `;
        });

        // Only update if content changed prevents flicker, but replacing innerHTML is simplest for now.
        // Ideally we diff, but for "Live Monitor" a simple replace is okay if frequent.
        // To reduce flicker, we could check if html matches current.
        if (tbody.innerHTML !== html) {
            tbody.innerHTML = html;
        }
    }

    // Refresh every 3 seconds
    setInterval(fetchLogs, 3000);

    // Initial fetch
    fetchLogs();
</script>

<style>
    .animate__fadeIn {
        animation-duration: 0.5s;
    }
</style>
{% endblock %}