{% extends "admin/_base.html" %}

{% block title %}Abonelikler{% endblock %}

{% block content %}
<div class="admin-header">
    <h1><i class="bi bi-credit-card me-2"></i>Abonelikler</h1>
    <div class="btn-group">
        <a href="?plan=" class="btn btn-{{ 'admin' if not plan_filter else 'outline-light' }}">Tümü</a>
        <a href="?plan=free" class="btn btn-{{ 'admin' if plan_filter == 'free' else 'outline-light' }}">Ücretsiz</a>
        <a href="?plan=pro" class="btn btn-{{ 'admin' if plan_filter == 'pro' else 'outline-light' }}">Pro</a>
        <a href="?plan=enterprise"
            class="btn btn-{{ 'admin' if plan_filter == 'enterprise' else 'outline-light' }}">Enterprise</a>
    </div>
</div>

<div class="admin-card">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Kullanıcı</th>
                <th>Plan</th>
                <th>Durum</th>
                <th>Başlangıç</th>
                <th>Bitiş</th>
                <th>Periyot</th>
                <th>Tutar</th>
                <th>Kalan Gün</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for sub in subscriptions.items %}
            <tr>
                <td>
                    <a href="{{ url_for('admin.user_detail', user_id=sub.user_id) }}"
                        class="text-white text-decoration-none">
                        {{ sub.user.email if sub.user else 'Bilinmiyor' }}
                    </a>
                </td>
                <td>
                    <span
                        class="badge bg-{{ 'success' if sub.plan == 'enterprise' else 'primary' if sub.plan == 'pro' else 'secondary' }}">
                        {{ sub.plan_display_name }}
                    </span>
                </td>
                <td>
                    <span
                        class="badge bg-{{ 'success' if sub.status == 'active' else 'warning' if sub.status == 'expired' else 'danger' }}">
                        {{ sub.status }}
                    </span>
                </td>
                <td>{{ sub.start_date.strftime('%d.%m.%Y') if sub.start_date else '-' }}</td>
                <td>{{ sub.end_date.strftime('%d.%m.%Y') if sub.end_date else 'Sınırsız' }}</td>
                <td>
                    <span class="badge bg-outline-light border text-white">
                        {{ 'Yıllık' if sub.billing_cycle == 'annual' else 'Aylık' }}
                    </span>
                </td>
                <td>{{ "%.2f"|format(sub.price_paid) }} {{ sub.currency }}</td>
                <td>
                    {% if sub.days_remaining == -1 %}
                    <span class="text-success">∞</span>
                    {% elif sub.days_remaining == 0 %}
                    <span class="text-danger">Süresi doldu</span>
                    {% elif sub.days_remaining <= 7 %} <span class="text-warning">{{ sub.days_remaining }} gün</span>
                        {% else %}
                        {{ sub.days_remaining }} gün
                        {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('admin.user_detail', user_id=sub.user_id) }}"
                        class="btn btn-sm btn-outline-light">
                        <i class="bi bi-pencil"></i>
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    {% if plan_filter %}
                    {{ plan_filter }} planında abonelik bulunamadı
                    {% else %}
                    Henüz abonelik yok
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    {% if subscriptions.pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center mb-0">
            {% if subscriptions.has_prev %}
            <li class="page-item">
                <a class="page-link" href="?page={{ subscriptions.prev_num }}&plan={{ plan_filter }}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for page in subscriptions.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page %}
            <li class="page-item {{ 'active' if page == subscriptions.page else '' }}">
                <a class="page-link" href="?page={{ page }}&plan={{ plan_filter }}">{{ page }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            {% endfor %}

            {% if subscriptions.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ subscriptions.next_num }}&plan={{ plan_filter }}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}