{% extends "_base.html" %}

{% block title %}Barkod Araçları - Vidos{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">Barkod Araçları</h2>
            <p class="text-muted small mb-0">Ürünleriniz için barkod üretin, doğrulayın ve yönetin.</p>
        </div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">Barkod Araçları</li>
            </ol>
        </nav>
    </div>

    <div class="row g-4">
        <!-- 1. Barkod Oluşturucu -->
        <div class="col-xl-7">
            <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: 20px;">
                <div class="card-header bg-white py-3 border-bottom border-light">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 p-2 rounded-3 me-3">
                            <i class="bi bi-upc-scan text-primary fs-4"></i>
                        </div>
                        <h5 class="card-title mb-0 fw-bold">Barkod Oluşturucu</h5>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3 mb-4">
                        <div class="col-md-8">
                            <label class="form-label small fw-bold text-muted">Barkod Verisi</label>
                            <input type="text" id="barcode-input"
                                class="form-control form-control-lg border-light bg-light"
                                placeholder="Örn: 8680000000123" style="border-radius: 12px;">
                            <div class="form-text mt-2 small text-muted">EAN-13, Code128 veya herhangi bir sayısal veri
                                girin.</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Format</label>
                            <select id="barcode-format" class="form-select form-select-lg border-light bg-light"
                                style="border-radius: 12px;">
                                <option value="CODE128">Code 128 (Genel)</option>
                                <option value="EAN13">EAN-13 (TR/Global)</option>
                                <option value="EAN8">EAN-8</option>
                                <option value="UPC">UPC-A</option>
                                <option value="CODE39">Code 39</option>
                                <option value="ITF14">ITF-14</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 align-items-end mb-4">
                        <div class="col-md-4">
                            <label class="form-label small fw-bold text-muted">Genişlik</label>
                            <input type="range" class="form-range" min="1" max="4" step="1" id="barcode-width"
                                value="2">
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" id="display-value" checked>
                                <label class="form-check-label small fw-bold" for="display-value">Değeri Göster</label>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary w-100 py-2 fw-bold shadow-sm" onclick="generateBarcode()"
                                style="border-radius: 12px;">
                                <i class="bi bi-magic me-2"></i> Oluştur
                            </button>
                        </div>
                    </div>

                    <div class="barcode-preview-area bg-light rounded-4 p-5 text-center border-dashed position-relative"
                        style="min-height: 250px;">
                        <div id="barcode-placeholder" class="py-5">
                            <i class="bi bi-upc-scan display-1 text-muted opacity-25"></i>
                            <p class="text-muted mt-3">Barkod önizlemesi burada görünecek.</p>
                        </div>
                        <svg id="barcode-svg" style="display: none;"></svg>

                        <div id="barcode-actions" class="mt-4" style="display: none;">
                            <hr class="border-light">
                            <div class="d-flex justify-content-center gap-2">
                                <button class="btn btn-outline-secondary btn-sm rounded-3 px-3"
                                    onclick="downloadBarcode('png')">
                                    <i class="bi bi-file-earmark-image me-1"></i> PNG Kaydet
                                </button>
                                <button class="btn btn-outline-secondary btn-sm rounded-3 px-3"
                                    onclick="printBarcode()">
                                    <i class="bi bi-printer me-1"></i> Yazdır
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Barkod Doğrulayıcı & Bilgi -->
        <div class="col-xl-5">
            <!-- Doğrulayıcı -->
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 20px;">
                <div class="card-header bg-white py-3 border-bottom border-light">
                    <div class="d-flex align-items-center">
                        <div class="bg-info bg-opacity-10 p-2 rounded-3 me-3">
                            <i class="bi bi-shield-check text-info fs-4"></i>
                        </div>
                        <h5 class="card-title mb-0 fw-bold">EAN-13 Doğrulayıcı</h5>
                    </div>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted small">EAN-13 barkodunun kontrol basamağını (checksum) ve geçerliliğini test
                        edin.</p>
                    <div class="input-group mb-3">
                        <input type="text" id="verify-input" class="form-control border-light bg-light"
                            placeholder="13 haneli barkod girin"
                            style="border-top-left-radius: 12px; border-bottom-left-radius: 12px;">
                        <button class="btn btn-info text-white px-4 fw-bold" onclick="verifyBarcode()"
                            style="border-top-right-radius: 12px; border-bottom-right-radius: 12px;">
                            Kontrol Et
                        </button>
                    </div>
                    <div id="verify-result" class="mt-3" style="display: none;">
                        <!-- JS handles content -->
                    </div>
                </div>
            </div>

            <!-- Bilgi Kartı -->
            <div class="card border-0 shadow-sm bg-gradient-primary text-white mb-4"
                style="border-radius: 20px; background: linear-gradient(135deg, #4361ee, #4895ef);">
                <div class="card-body p-4">
                    <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-2"></i> Barkod Hakkında İpuçları</h6>
                    <ul class="list-unstyled small mb-0">
                        <li class="mb-2"><i class="bi bi-check2-circle me-2"></i> <strong>EAN-13:</strong> Türkiye (868,
                            869) ve Avrupa'da perakende satılan ürünler için standarttır.</li>
                        <li class="mb-2"><i class="bi bi-check2-circle me-2"></i> <strong>Code 128:</strong> Hem sayı
                            hem harf içerebilir, depo ve lojistik etiketleri için idealdir.</li>
                        <li><i class="bi bi-check2-circle me-2"></i> <strong>Checkpoint:</strong> 13. hane bir
                            matematiksel hesaplama (mod10) sonucudur.</li>
                    </ul>
                </div>
            </div>

            <!-- Veritabanı Aksiyonları -->
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 20px;">
                <div class="card-header bg-white py-3 border-bottom border-light">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-10 p-2 rounded-3 me-3">
                            <i class="bi bi-database-fill-gear text-warning fs-4"></i>
                        </div>
                        <h5 class="card-title mb-0 fw-bold">Toplu Veritabanı İşlemleri</h5>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="d-grid gap-3">
                        <button class="btn btn-light border py-3 text-start px-4 position-relative overflow-hidden"
                            onclick="runDatabaseAction('generate_missing')" style="border-radius: 12px;">
                            <div class="fw-bold">Eksik Barkodları Tamamla</div>
                            <div class="text-muted extra-small">Barkodu olmayan ürünlere 13 haneli barkod üretir.</div>
                        </button>

                        <button class="btn btn-outline-danger py-3 text-start px-4 position-relative overflow-hidden"
                            onclick="runDatabaseAction('override_all')" style="border-radius: 12px;">
                            <div class="fw-bold text-danger">TÜM Barkodları Yenile (Sıfırla)</div>
                            <div class="text-muted extra-small">TÜM ürünlerin barkodunu rastgele 13 hane ile değiştirir.
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Rapor Alanı -->
            <div id="report-card" class="card border-0 shadow-sm" style="border-radius: 20px; display: none;">
                <div
                    class="card-header bg-white py-3 border-bottom border-light d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-dark">İşlem Raporu</h6>
                    <button class="btn btn-sm btn-link text-muted p-0"
                        onclick="document.getElementById('report-card').style.display='none'"><i
                            class="bi bi-x-lg"></i></button>
                </div>
                <div class="card-body p-3">
                    <textarea id="report-text" class="form-control border-0 bg-light small" rows="10" readonly
                        style="font-family: monospace; font-size: 0.75rem; border-radius: 10px;"></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
<script>
    async function runDatabaseAction(action) {
        let msg = action === 'override_all' ?
            "DİKKAT! Bu işlem TÜM ürün barkodlarını rastgele barkodlarla değiştirecektir. Bu işlem geri alınamaz. Devam etmek istiyor musunuz?" :
            "Barkodu olmayan veya yetersiz olan ürünler için 13 haneli barkod üretilecektir. Onaylıyor musunuz?";

        if (!confirm(msg)) return;

        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `<div class="d-flex align-items-center"><span class="spinner-border spinner-border-sm me-3"></span> İşlem yapılıyor...</div>`;

        try {
            const response = await fetch(`/api/barcodes/${action}`, { method: 'POST' });
            const data = await response.json();

            if (data.success) {
                alert(data.message);
                if (data.report) {
                    document.getElementById('report-card').style.display = 'block';
                    document.getElementById('report-text').value = data.report;
                    // Scroll to report
                    document.getElementById('report-card').scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                alert("Hata: " + (data.message || "Bilinmeyen hata"));
            }
        } catch (e) {
            alert("İşlem hatası: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
    function generateBarcode() {
        const value = document.getElementById('barcode-input').value.trim();
        const format = document.getElementById('barcode-format').value;
        const width = parseInt(document.getElementById('barcode-width').value);
        const displayValue = document.getElementById('display-value').checked;

        if (!value) {
            alert('Lütfen bir değer girin.');
            return;
        }

        try {
            document.getElementById('barcode-placeholder').style.display = 'none';
            const svg = document.getElementById('barcode-svg');
            svg.style.display = 'inline-block';

            JsBarcode("#barcode-svg", value, {
                format: format,
                width: width,
                height: 100,
                displayValue: displayValue,
                fontSize: 18,
                background: "transparent",
                lineColor: "#212529",
                margin: 10
            });

            document.getElementById('barcode-actions').style.display = 'block';
        } catch (e) {
            alert('Hata: Seçilen format veri ile uyumsuz olabilir.\n' + e.message);
            document.getElementById('barcode-placeholder').style.display = 'block';
            document.getElementById('barcode-svg').style.display = 'none';
            document.getElementById('barcode-actions').style.display = 'none';
        }
    }

    function verifyBarcode() {
        const value = document.getElementById('verify-input').value.trim();
        const resultDiv = document.getElementById('verify-result');

        if (value.length !== 13 || isNaN(value)) {
            resultDiv.innerHTML = '<div class="alert alert-warning py-2 small mb-0"><i class="bi bi-exclamation-triangle me-2"></i> Lütfen tam olarak 13 haneli bir sayı girin.</div>';
            resultDiv.style.display = 'block';
            return;
        }

        // Mod10 Calculation
        let sum = 0;
        for (let i = 0; i < 12; i++) {
            sum += parseInt(value[i]) * (i % 2 === 0 ? 1 : 3);
        }
        const checkDigit = (10 - (sum % 10)) % 10;
        const actualCheckDigit = parseInt(value[12]);

        if (checkDigit === actualCheckDigit) {
            resultDiv.innerHTML = `
                <div class="alert alert-success py-2 small mb-0">
                    <i class="bi bi-check-circle-fill me-2"></i> <strong>Geçerli Barkod!</strong><br>
                    Ülke/Önek: ${value.substring(0, 3)} | 13. Hane (Check): ${actualCheckDigit} (Doğru)
                </div>`;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger py-2 small mb-0">
                    <i class="bi bi-x-circle-fill me-2"></i> <strong>Geçersiz Barkod!</strong><br>
                    Beklenen Check Digit: ${checkDigit} | Girilen: ${actualCheckDigit}
                </div>`;
        }
        resultDiv.style.display = 'block';
    }

    function downloadBarcode(format) {
        const svg = document.getElementById('barcode-svg');
        const serializer = new XMLSerializer();
        let source = serializer.serializeToString(svg);

        if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
            source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
        }

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();

        img.onload = function () {
            canvas.width = img.width + 40;
            canvas.height = img.height + 40;
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 20, 20);

            const link = document.createElement("a");
            link.download = `barcode-${document.getElementById('barcode-input').value}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        };

        img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(source)));
    }

    function printBarcode() {
        const svg = document.getElementById('barcode-svg').outerHTML;
        const printWindow = window.open('', '', 'width=600,height=400');
        printWindow.document.write('<html><head><title>Barkod Yazdır</title><style>body{text-align:center;padding:50px;}</style></head><body>');
        printWindow.document.write(svg);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }
</script>

<style>
    .border-dashed {
        border: 2px dashed #dee2e6;
    }

    .extra-small {
        font-size: 0.65rem;
    }
</style>
{% endblock %}