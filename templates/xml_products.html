{% extends "_base.html" %}
{% block title %}XML Ürün Listesi — VIDOS{% endblock %}
{% block page_title %}Tedarikçi XML'den Gelen Ürünler{% endblock %}

{% block content %}
<div class="animate-fade-in">
  <!-- Tools & Options (Filter Card) -->
  <div class="card mb-4 border-0 shadow-sm animate-fade-in" style="background: var(--card);">
    <div class="card-body p-3">
      <div class="d-flex align-items-center justify-content-between mb-3 pb-2 border-bottom">
        <h6 class="mb-0 fw-bold"><i class="bi bi-sliders me-2 text-primary"></i>Ürün Filtreleme ve Gönderim Ayarları
        </h6>
        <div class="d-flex gap-2">
          <button id="changeSourceBtn" class="btn btn-outline-secondary btn-sm" title="XML Kaynağını Değiştir">
            <i class="bi bi-shuffle me-1"></i>Kaynak Değiştir
          </button>
          <button id="toggleViewBtn" class="btn btn-outline-primary btn-sm" data-mode="list" title="Görünümü Değiştir">
            <i class="bi bi-grid-3x3-gap"></i>
          </button>
        </div>
      </div>

      <div class="row g-3">
        <!-- Row 1: Search & Basic Filters -->
        <div class="col-md-4">
          <label class="form-label small fw-bold mb-1">Genel Arama (Ad/Barkod)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text border-end-0 bg-light"><i class="bi bi-search"></i></span>
            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Ara...">
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Stok Durumu</label>
          <select id="stockStatusSelect" class="form-select form-select-sm">
            <option value="all">Hepsi</option>
            <option value="in_stock">Stokta Var</option>
            <option value="out_of_stock">Stokta Yok</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Görsel Durumu</label>
          <select id="imageStatusSelect" class="form-select form-select-sm">
            <option value="all">Hepsi</option>
            <option value="has_image">Görsel Var</option>
            <option value="no_image">Görsel Yok</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Fiyat Sıralaması</label>
          <select id="priceSortSelect" class="form-select form-select-sm">
            <option value="none">Varsayılan</option>
            <option value="asc">Artan (Düşük → Yüksek)</option>
            <option value="desc">Azalan (Yüksek → Düşük)</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Min Stok</label>
          <input type="number" id="minStockInput" class="form-control form-control-sm" placeholder="0">
        </div>

        <!-- Row 2: Price & Category Filters -->
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Min Fiyat</label>
          <input type="number" id="minPriceInput" class="form-control form-control-sm" placeholder="0">
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-bold mb-1">Max Fiyat</label>
          <input type="number" id="maxPriceInput" class="form-control form-control-sm" placeholder="Max">
        </div>
        <div class="col-md-4">
          <label class="form-label small fw-bold mb-1">Marka</label>
          <input type="text" id="brandFilterInput" class="form-control form-control-sm" placeholder="Marka adı...">
        </div>
        <div class="col-md-4">
          <label class="form-label small fw-bold mb-1">Kategori</label>
          <input type="text" id="catFilterInput" class="form-control form-control-sm" placeholder="Kategori adı...">
        </div>

        <!-- Row 3: Navigation & Options -->
        <div class="col-md-12">
          <hr class="my-2 op-1">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-3">
              <div class="d-flex align-items-center gap-2">
                <span class="small text-muted">Sayfa:</span>
                <div class="input-group input-group-sm" style="width: 100px;">
                  <input id="goToInput" type="number" min="1" class="form-control" placeholder="1">
                  <button id="goToBtn" class="btn btn-secondary">Git</button>
                </div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span class="small text-muted">Adet:</span>
                <select id="perPageSelect" class="form-select form-select-sm" style="width: 80px;">
                  <option value="10">10</option>
                  <option value="20">20</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
              <span id="productCount" class="badge bg-light text-dark border p-2">Toplam 0 ürün</span>
            </div>

            <div class="d-flex gap-3 align-items-center">
              <div class="form-check form-switch pt-1">
                <input class="form-check-input" type="checkbox" id="optMatchByStockCode">
                <label class="form-check-label small fw-bold" for="optMatchByStockCode">Stok Kodu İle Eşleştir</label>
              </div>
              <div class="form-check form-switch pt-1">
                <input class="form-check-input" type="checkbox" id="optZeroStockAsOne">
                <label class="form-check-label small fw-bold" for="optZeroStockAsOne">Stok 0 ise 1 gönder</label>
              </div>
              <div class="vr mx-2 d-none d-lg-block"></div>
              <button id="applyFiltersBtn" class="btn btn-primary btn-sm fw-bold px-3 shadow-sm">
                <i class="bi bi-funnel-fill me-1"></i>Filtreleri Uygula
              </button>
              <button id="clearFiltersBtn" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-x-circle me-1"></i>Temizle
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-pills mb-3 gap-2 p-2 bg-light rounded shadow-sm border" id="marketplaceTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active fw-bold py-2 px-4 border-0" id="genel-tab" data-bs-toggle="tab" data-mp="all"
        type="button" role="tab">
        <i class="bi bi-list-stars me-2"></i>Genel Liste
      </button>
    </li>
    {% if current_user.is_admin or current_user.has_permission('trendyol') %}
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-bold py-2 px-4 border-0" id="trendyol-tab" data-bs-toggle="tab" data-mp="trendyol"
        type="button" role="tab">
        <i class="bi bi-shop me-2"></i>Trendyol
      </button>
    </li>
    {% endif %}
    {% if current_user.is_admin or current_user.has_permission('hepsiburada') %}
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-bold py-2 px-4 border-0" id="hepsiburada-tab" data-bs-toggle="tab"
        data-mp="hepsiburada" type="button" role="tab" style="color:#FF6000;">
        <i class="bi bi-bag-fill me-2"></i>Hepsiburada
      </button>
    </li>
    {% endif %}
    {% if current_user.is_admin or current_user.has_permission('pazarama') %}
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-bold py-2 px-4 border-0" id="pazarama-tab" data-bs-toggle="tab" data-mp="pazarama"
        type="button" role="tab">
        <i class="bi bi-credit-card-fill me-2"></i>Pazarama
      </button>
    </li>
    {% endif %}
    {% if current_user.is_admin or current_user.has_permission('n11') %}
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-bold py-2 px-4 border-0" id="n11-tab" data-bs-toggle="tab" data-mp="n11" type="button"
        role="tab" style="color:#5f259f;">
        <i class="bi bi-shop-window me-2"></i>N11
      </button>
    </li>
    {% endif %}
    {% if current_user.is_admin or current_user.has_permission('idefix') %}
    <li class="nav-item" role="presentation">
      <button class="nav-link fw-bold py-2 px-4 border-0" id="idefix-tab" data-bs-toggle="tab" data-mp="idefix"
        type="button" role="tab" style="color:#0dcaf0;">
        <i class="bi bi-box-seam-fill me-2"></i>İdefix
      </button>
    </li>
    {% endif %}
  </ul>

  <!-- Marketplace Info Card (Dynamic) -->
  <div id="mpInfoCard" class="card mb-3 border-0 shadow-sm d-none animate-fade-in"
    style="background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);">
    <div class="card-body p-3 d-flex align-items-center justify-content-between flex-wrap gap-3">
      <div class="d-flex align-items-center gap-3">
        <div id="mpIconBox"
          class="rounded-circle p-3 bg-white shadow-sm d-flex align-items-center justify-content-center"
          style="width: 50px; height: 50px;">
          <!-- Icon injected by JS -->
        </div>
        <div>
          <h6 id="mpTitle" class="mb-0 fw-bold text-dark">Pazaryeri Modu</h6>
          <div class="small text-muted">Bu sekmede fiyatlar <span id="mpMultiplierText"
              class="fw-bold text-primary">1.00x</span> çarpanı ile hesaplanmaktadır.</div>
          <div id="mpBrandOverrideInfo" class="small fw-bold text-warning d-none mt-1">
            <i class="bi bi-shield-check me-1"></i>Marka Override: <span id="mpBrandName">---</span>
          </div>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button id="sendSelectedBtn" class="btn btn-primary fw-bold px-4 shadow-sm">
          <i class="bi bi-send-check-fill me-2"></i>Seçiliyi Gönder
        </button>
        <button id="sendAllBtnAtInfo" class="btn btn-success fw-bold px-4 shadow-sm">
          <i class="bi bi-send-fill me-2"></i>Tümünü Gönder
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive shadow-sm card border-0 mb-4" id="listContainer">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th style="width: 40px;" class="ps-3"><input id="selectAll" type="checkbox" class="form-check-input"></th>
          <th style="width: 70px;">Görsel</th>
          <th style="width: 25%;">Ürün Adı</th>
          <th>Barkod</th>
          <th>Kategori Yolu</th>
          <th id="priceHeader">Fiyat / Stok</th>
          <th>Durum</th>
          <th class="text-center">İşlem</th>
        </tr>
      </thead>
      <tbody id="productListBody"></tbody>
    </table>
  </div>

  <div id="gridContainer" class="d-none mb-4">
    <div id="productGrid" class="row g-3"></div>
  </div>

  <nav class="pb-4">
    <ul class="pagination justify-content-center shadow-sm" id="pagination"></ul>
  </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Global Variables
  let currentPage = 1;
  let itemsPerPage = 5000;
  let currentSearchQuery = '';
  let currentTotal = 0;
  let selectedSourceId = localStorage.getItem('vidos_xml_source_id') || null;
  const selectedBarcodes = new Set();
  let viewMode = localStorage.getItem('vidos_view_mode') || 'list';
  let currentMarketplace = 'all'; // Default to "Genel Liste"
  let multipliers = {};
  let brandOverrides = {};

  // DOM Elements
  const productListBody = document.getElementById('productListBody');
  const pagination = document.getElementById('pagination');
  const productCountSpan = document.getElementById('productCount');
  const searchInput = document.getElementById('searchInput');

  // Advanced Filter Inputs
  const stockStatusSelect = document.getElementById('stockStatusSelect');
  const imageStatusSelect = document.getElementById('imageStatusSelect');
  const priceSortSelect = document.getElementById('priceSortSelect');
  const minPriceInput = document.getElementById('minPriceInput');
  const maxPriceInput = document.getElementById('maxPriceInput');
  const minStockInput = document.getElementById('minStockInput');
  const brandFilterInput = document.getElementById('brandFilterInput');
  const catFilterInput = document.getElementById('catFilterInput');

  const perPageSelect = document.getElementById('perPageSelect');
  const goToInput = document.getElementById('goToInput');
  const goToBtn = document.getElementById('goToBtn');
  const selectAll = document.getElementById('selectAll');
  const changeSourceBtn = document.getElementById('changeSourceBtn');
  const toggleViewBtn = document.getElementById('toggleViewBtn');

  const sendSelectedBtn = document.getElementById('sendSelectedBtn');
  const sendAllBtnAtInfo = document.getElementById('sendAllBtnAtInfo');

  // --- Helper Functions ---

  function showSummaryAndRedirect(j) {
    try { Swal.close(); } catch (e) { }
    const m = j.matched || [];
    const sk = j.skipped || [];
    const s = j.summary || { success_count: 0, fail_count: 0, failures: [] };

    const successCount = s.success_count || 0;
    const failCount = s.fail_count || 0;
    const skippedCount = sk.length;

    // Success Card Logic: If everything succeeded without any errors or skips
    if (failCount === 0 && skippedCount === 0 && successCount > 0) {
      Swal.fire({
        title: 'İşlem Başarılı!',
        html: `
          <div class="text-center py-3">
            <div class="display-1 text-success mb-3"><i class="bi bi-patch-check-fill"></i></div>
            <p class="fs-5">Tüm ürünler (<strong>${successCount} adet</strong>) başarıyla gönderildi.</p>
          </div>
        `,
        icon: 'success',
        confirmButtonText: 'Tamam',
        timer: 5000
      });
      return;
    }

    const html = `
    <div class="text-start">
      <div class="mb-3 p-3 bg-light rounded border">
        <div class="d-flex justify-content-between mb-2">
          <span>Başarılı Gönderim:</span>
          <span class="badge bg-success">${successCount}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Hatalı İşlem:</span>
          <span class="badge bg-danger">${failCount}</span>
        </div>
        <div class="d-flex justify-content-between">
          <span>Atlanan (Eşleşmeyen):</span>
          <span class="badge bg-warning text-dark">${skippedCount}</span>
        </div>
      </div>
      <div class="alert alert-info py-2 small mb-0">
        <i class="bi bi-info-circle me-1"></i> İncelemek için <strong>Detay Gör</strong> butonuna tıklayabilirsiniz.
      </div>
    </div>`;

    Swal.fire({
      title: 'İşlem Durumu',
      html,
      icon: failCount > 0 ? 'warning' : 'info',
      showCancelButton: true,
      confirmButtonText: 'Detay Gör',
      cancelButtonText: 'Kapat',
      confirmButtonColor: '#0d6efd'
    }).then(res => {
      if (res.isConfirmed) {
        window.location.href = j.batch_id ? `/batch/${j.batch_id}` : '/report/history';
      }
    });
  }

  function renderProducts(products) {
    try {
      const listContainer = document.getElementById('listContainer');
      const gridContainer = document.getElementById('gridContainer');
      const grid = document.getElementById('productGrid');

      if (!listContainer || !gridContainer || !productListBody) return;

      if (viewMode === 'list') {
        listContainer.classList.remove('d-none');
        gridContainer.classList.add('d-none');
        productListBody.innerHTML = '';

        if (!products || products.length === 0) {
          productListBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Hiç ürün bulunamadı.</td></tr>';
          return;
        }

        products.forEach(product => {
          const checked = selectedBarcodes.has(product.barcode) ? 'checked' : '';
          const imgUrl = (product.images && product.images[0] && (product.images[0].url || product.images[0])) || 'https://via.placeholder.com/120x120?text=IMG';

          let displayPrice = Number(product.price || 0);
          let priceDetails = '';

          if (currentMarketplace !== 'all') {
            const mult = multipliers[currentMarketplace] || 1.0;
            const mpPrice = displayPrice * mult;
            displayPrice = mpPrice;
            priceDetails = `<div class="x-small text-muted mt-1" style="font-size: 0.7rem;">Ham: ${Number(product.price || 0).toFixed(2)} TL</div>`;
          }

          const row = `
              <tr class="animate-fade-in">
                  <td class="ps-3"><input type="checkbox" class="form-check-input row-check" data-barcode="${product.barcode}" ${checked}></td>
                  <td><img src="${imgUrl}" alt="${product.title}" class="img-thumbnail border-0 shadow-sm" style="width: 50px; height: 50px; object-fit: cover;"></td>
                  <td class="text-truncate" style="max-width: 250px;" title="${product.title}">${product.title}</td>
                  <td><span class="badge bg-secondary font-monospace">${product.barcode}</span></td>
                  <td style="font-size: 0.85rem;" class="text-muted">
                    <div class="text-truncate" style="max-width: 150px;">${product.category || '---'}</div>
                    ${currentMarketplace !== 'all' ? '<div class="x-small text-info" style="font-size:0.7rem;"><i class="bi bi-magic me-1"></i>Oto-Eşleşme Aktif</div>' : ''}
                  </td>
                  <td>
                    <div class="d-flex flex-column">
                      <span class="fw-bold">${displayPrice.toFixed(2)} TL</span>
                      ${priceDetails}
                      <span class="small text-success fw-bold">Stok: ${parseInt(product.quantity || 0)}</span>
                    </div>
                  </td>
                  <td><span class="badge bg-info bg-opacity-10 text-info border border-info">Hazır</span></td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary" onclick="showProductDetail('${product.barcode}')" title="Detay">
                      <i class="bi bi-eye"></i>
                    </button>
                  </td>
              </tr>
          `;
          productListBody.insertAdjacentHTML('beforeend', row);
        });

      } else {
        // Grid View
        listContainer.classList.add('d-none');
        gridContainer.classList.remove('d-none');
        grid.innerHTML = '';

        if (!products || products.length === 0) {
          grid.innerHTML = '<div class="col-12 text-center p-5 text-muted">Hiç ürün bulunamadı.</div>';
          return;
        }

        products.forEach(product => {
          const checked = selectedBarcodes.has(product.barcode) ? 'checked' : '';
          const imgUrl = (product.images && product.images[0] && (product.images[0].url || product.images[0])) || 'https://via.placeholder.com/300x200?text=IMG';
          const card = `
              <div class="col-12 col-sm-6 col-md-4 col-lg-3 animate-fade-in">
                <div class="card h-100 border-0 shadow-sm product-card">
                  <div class="card-body p-2 d-flex flex-column">
                    <div class="d-flex align-items-start justify-content-between mb-2">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input row-check" data-barcode="${product.barcode}" ${checked}>
                      </div>
                      <span class="badge bg-secondary font-monospace small">${product.barcode}</span>
                    </div>
                    <div class="text-center mb-2" style="height: 160px; overflow: hidden; border-radius: 8px; background: #f8f9fa;">
                      <img src="${imgUrl}" class="h-100 w-100" style="object-fit: contain;">
                    </div>
                    <div class="fw-semibold text-truncate mb-1" title="${product.title}">${product.title}</div>
                    <div class="text-muted small mb-2 text-truncate">${product.category_path || '---'}</div>
                    <div class="mt-auto d-flex justify-content-between align-items-center pt-2 border-top">
                      <div class="fw-bold fs-5 text-primary">${Number(product.price || 0).toFixed(2)} TL</div>
                      <div class="badge bg-success bg-opacity-10 text-success">Stok: ${parseInt(product.quantity || 0)}</div>
                    </div>
                  </div>
                </div>
              </div>`;
          grid.insertAdjacentHTML('beforeend', card);
        });
      }

      // Re-attach event listeners
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const bc = e.target.dataset.barcode;
          if (e.target.checked) selectedBarcodes.add(bc); else selectedBarcodes.delete(bc);
        });
      });
    } catch (err) {
      console.error("Render error:", err);
    }
  }

  function addPageItem(num, active = false, disabled = false, text = null) {
    const li = document.createElement('li');
    li.className = `page-item ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}`;
    const label = text || num;
    li.innerHTML = `<a class="page-link" href="#" data-page="${num}">${label}</a>`;
    if (!disabled) {
      li.addEventListener('click', (e) => { e.preventDefault(); currentPage = parseInt(e.target.dataset.page); fetchProducts(); });
    }
    pagination.appendChild(li);
  }

  function renderPagination(total, current) {
    const totalPages = Math.ceil(total / itemsPerPage) || 1;
    pagination.innerHTML = '';
    addPageItem(Math.max(1, current - 1), false, current === 1, '«');
    const windowSize = 2;
    const pages = [];
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= current - windowSize && i <= current + windowSize)) pages.push(i);
    }
    let last = 0;
    pages.forEach(p => {
      if (p - last > 1) {
        const li = document.createElement('li'); li.className = 'page-item disabled'; li.innerHTML = '<span class="page-link">…</span>'; pagination.appendChild(li);
      }
      addPageItem(p, p === current);
      last = p;
    });
    addPageItem(Math.min(totalPages, current + 1), false, current === totalPages, '»');
  }

  function fetchProducts() {
    if (!selectedSourceId) {
      const errorHtml = '<tr><td colspan="8" class="text-center p-5 text-muted">Lütfen bir XML kaynağı seçin.</td></tr>';
      if (viewMode === 'list') productListBody.innerHTML = errorHtml;
      return Promise.resolve();
    }

    if (viewMode === 'list') {
      productListBody.innerHTML = '<tr><td colspan="8" class="text-center p-5 text-primary"><div class="spinner-border spinner-border-sm me-2"></div> Ürünler yükleniyor...</td></tr>';
    } else {
      const grid = document.getElementById('productGrid');
      if (grid) grid.innerHTML = '<div class="col-12 text-center p-5 text-primary"><div class="spinner-border spinner-border-sm me-2"></div> Ürünler yükleniyor...</div>';
    }

    const q = encodeURIComponent(searchInput.value.trim());
    const stockStatus = stockStatusSelect ? stockStatusSelect.value : 'all';
    const imageStatus = imageStatusSelect ? imageStatusSelect.value : 'all';
    const priceSort = priceSortSelect ? priceSortSelect.value : 'none';
    const minPrice = minPriceInput.value;
    const maxPrice = maxPriceInput.value;
    const minStock = minStockInput.value;
    const brand = encodeURIComponent(brandFilterInput.value.trim());
    const category = encodeURIComponent(catFilterInput.value.trim());
    const perPage = perPageSelect.value;
    itemsPerPage = parseInt(perPage);

    const url = `/api/xml_source_products?source_id=${selectedSourceId}&page=${currentPage}&per_page=${perPage}&q=${q}&stock_status=${stockStatus}&image_status=${imageStatus}&price_sort=${priceSort}&min_price=${minPrice}&max_price=${maxPrice}&min_stock=${minStock}&brand=${brand}&category=${category}`;

    return fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error("API Hatası: " + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (!data || !Array.isArray(data.items)) {
          throw new Error("Veri formatı geçersiz");
        }
        currentTotal = data.total || 0;
        const totalPages = Math.ceil(currentTotal / itemsPerPage) || 1;
        productCountSpan.textContent = `Toplam ${currentTotal} ürün (${currentPage}/${totalPages} sayfa)`;
        renderProducts(data.items);
        renderPagination(currentTotal, currentPage);
      })
      .catch((err) => {
        console.error("Fetch error:", err);
        const errorMsg = '<tr><td colspan="8" class="text-center p-5 text-danger">Ürünler yüklenemedi. Lütfen sayfayı yenileyin.</td></tr>';
        if (viewMode === 'list') productListBody.innerHTML = errorMsg;
        else {
          const grid = document.getElementById('productGrid');
          if (grid) grid.innerHTML = '<div class="col-12 text-center p-5 text-danger">Ürünler yüklenemedi.</div>';
        }
        productCountSpan.textContent = 'Toplam 0 ürün';
      });
  }

  // --- Event Listeners ---

  // Apply Filters Button
  const applyFiltersBtn = document.getElementById('applyFiltersBtn');
  const clearFiltersBtn = document.getElementById('clearFiltersBtn');

  function applyFilters() {
    currentPage = 1;
    fetchProducts();
  }

  if (applyFiltersBtn) {
    applyFiltersBtn.addEventListener('click', applyFilters);
  }

  // Clear Filters Button
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', () => {
      if (searchInput) searchInput.value = '';
      if (stockStatusSelect) stockStatusSelect.value = 'all';
      if (imageStatusSelect) imageStatusSelect.value = 'all';
      if (priceSortSelect) priceSortSelect.value = 'none';
      if (minPriceInput) minPriceInput.value = '';
      if (maxPriceInput) maxPriceInput.value = '';
      if (minStockInput) minStockInput.value = '';
      if (brandFilterInput) brandFilterInput.value = '';
      if (catFilterInput) catFilterInput.value = '';
      applyFilters();
    });
  }

  // Enter key support for filter inputs
  const filterInputs = [
    searchInput,
    minPriceInput, maxPriceInput, minStockInput,
    brandFilterInput, catFilterInput
  ];

  filterInputs.forEach(input => {
    if (!input) return;
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        applyFilters();
      }
    });
  });

  if (perPageSelect) {
    perPageSelect.addEventListener('change', () => {
      currentPage = 1;
      fetchProducts();
    });
  }


  // Go to Page
  function goToPage() {
    const val = parseInt(goToInput.value || '1');
    const totalPages = Math.ceil(currentTotal / itemsPerPage) || 1;
    if (val >= 1 && val <= totalPages) { currentPage = val; fetchProducts(); }
  }
  if (goToBtn) goToBtn.addEventListener('click', goToPage);
  if (goToInput) goToInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); goToPage(); } });

  // Select All
  if (selectAll) {
    selectAll.addEventListener('change', (e) => {
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.checked = e.target.checked;
        const bc = cb.dataset.barcode;
        if (e.target.checked) selectedBarcodes.add(bc); else selectedBarcodes.delete(bc);
      });
    });
  }

  // Toggle View
  if (toggleViewBtn) {
    // Set initial UI based on local storage
    if (viewMode === 'grid') {
      toggleViewBtn.dataset.mode = 'grid';
      toggleViewBtn.innerHTML = '<i class="bi bi-list-ul me-1"></i> Görünüm: Liste';
    }

    toggleViewBtn.addEventListener('click', () => {
      if (viewMode === 'list') {
        viewMode = 'grid';
        toggleViewBtn.dataset.mode = 'grid';
        toggleViewBtn.innerHTML = '<i class="bi bi-list-ul me-1"></i> Görünüm: Liste';
      } else {
        viewMode = 'list';
        toggleViewBtn.dataset.mode = 'list';
        toggleViewBtn.innerHTML = '<i class="bi bi-grid-3x3-gap me-1"></i> Görünüm: Grid';
      }
      localStorage.setItem('vidos_view_mode', viewMode);
      fetchProducts(); // Re-render logic handles container visibility
    });
  }

  // Change Source
  function chooseSource() {
    fetch('/api/xml_sources').then(r => r.json()).then(j => {
      const items = j.items || [];
      if (items.length === 0) { Swal.fire('Bilgi', 'Kayıtlı XML kaynağı yok. Ayarlar sayfasından ekleyin.', 'info'); return; }
      const opts = items.reduce((acc, it) => { acc[it.id] = `${it.name}`; return acc; }, {});
      Swal.fire({ title: 'XML Kaynağı Seçin', input: 'select', inputOptions: opts, showCancelButton: true, confirmButtonText: 'Seç' })
        .then(res => {
          if (!res.isConfirmed) return;
          selectedSourceId = res.value;
          localStorage.setItem('vidos_xml_source_id', String(selectedSourceId));
          currentPage = 1;
          fetchProducts();
        });
    });
  }
  if (changeSourceBtn) changeSourceBtn.addEventListener('click', chooseSource);

  // Send selected (NEW logic)
  if (sendSelectedBtn) {
    sendSelectedBtn.addEventListener('click', () => {
      if (currentMarketplace === 'all') {
        Swal.fire('Bilgi', 'Lütfen bir pazaryeri sekmesi seçin.', 'info');
        return;
      }
      const mpName = document.querySelector(`#${currentMarketplace}-tab`).innerText.trim();
      const color = document.querySelector(`#${currentMarketplace}-tab`).style.color || 'var(--primary)';
      sendToMarketplace(currentMarketplace, mpName, color);
    });
  }

  // Send all (NEW logic at info card)
  if (sendAllBtnAtInfo) {
    sendAllBtnAtInfo.addEventListener('click', () => {
      if (currentMarketplace === 'all') {
        Swal.fire('Bilgi', 'Lütfen bir pazaryeri sekmesi seçin.', 'info');
        return;
      }
      const mpName = document.querySelector(`#${currentMarketplace}-tab`).innerText.trim();
      triggerSendAll(currentMarketplace);
    });
  }

  function sendToMarketplace(mp, mpName, color = '#primary') {
    const barcodes = Array.from(selectedBarcodes);
    if (barcodes.length === 0) { Swal.fire('Uyarı', 'Lütfen ürün seçin', 'warning'); return; }

    Swal.fire({
      title: `${mpName}'a Gönderilecek`,
      html: `<p class="fs-5 fw-bold" style="color:${color}">${barcodes.length} ürün ${mpName} pazaryerine gönderilecek.</p><p>Doğru pazaryerini seçtiğinizden emin misiniz?</p>`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Evet, Gönder',
      cancelButtonText: 'İptal',
      confirmButtonColor: color
    }).then(confirm => {
      if (!confirm.isConfirmed) return;

      function getOptions() {
        const titlePrefix = document.getElementById('titlePrefixInput')?.value || '';
        const matchBy = document.getElementById('optMatchByStockCode')?.checked ? 'stock_code' : 'barcode';
        return {
          title_prefix: titlePrefix,
          match_by: matchBy,
          zero_stock_as_one: document.getElementById('optZeroStockAsOne')?.checked || false
        };
      }

      function doSend(xml_source_id) {
        Swal.fire({ title: 'Gönderiliyor', text: 'İşlem biraz sürebilir...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const opts = getOptions();
        const payload = { barcodes, xml_source_id, ...opts };

        fetch(`/api/send_selected/${mp}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
          .then(r => r.json()).then(j => {
            if (j.success) { showSummaryAndRedirect(j); }
            else { Swal.fire('Hata', j.message || 'İşlem başarısız', 'error'); }
          }).catch(() => Swal.fire('Hata', 'API çağrısı sırasında bir sorun oluştu.', 'error'));
      }

      function doSendAuto(xml_source_id) {
        Swal.fire({ title: 'Gönderiliyor', text: 'Kategori eşlemesi yapılıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const opts = getOptions();
        const payload = { barcodes, xml_source_id, auto_match: true, ...opts };

        fetch(`/api/trendyol/send_auto`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
          .then(r => r.json()).then(j => {
            if (j.success) { showSummaryAndRedirect(j); }
            else { Swal.fire('Hata', j.message || 'İşlem başarısız', 'error'); }
          }).catch(() => Swal.fire('Hata', 'API çağrısı sırasında bir sorun oluştu.', 'error'));
      }

      if (mp === 'trendyol') {
        Swal.fire({
          title: 'Otomatik Kategori Eşleştirilsin mi?',
          text: 'Ürün adı ile en yakın kategori bulunup gönderilecek.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Evet, otomatik',
          cancelButtonText: 'Hayır, manuel'
        }).then(ans => {
          const proceedAuto = ans.isConfirmed;
          const doNext = (id) => proceedAuto ? doSendAuto(id) : doSend(id);
          doNext(selectedSourceId);
        });
      } else {
        doSend(selectedSourceId);
      }
    });
  }

  async function triggerSendAll(mp) {
    const mpName = document.querySelector(`#${mp}-tab`).innerText.trim();
    const result = await Swal.fire({
      title: 'Tüm Ürünleri Gönder',
      html: `
        <div class="text-start">
          <p><strong>${currentTotal} ürün</strong> ${mpName} pazaryerine gönderilecek.</p>
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="autoMatchCheck" checked>
            <label class="form-check-label" for="autoMatchCheck">
              Otomatik kategori eşleştir (Varsayılan)
            </label>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="stockCodeMatchCheck" ${document.getElementById('optMatchByStockCode')?.checked ? 'checked' : ''}>
            <label class="form-check-label" for="stockCodeMatchCheck">
              Stok Kodu İle Eşleştir (Barkod yerine)
            </label>
          </div>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: 'Başlat',
      cancelButtonText: 'İptal',
      preConfirm: () => {
        return {
          autoMatch: document.getElementById('autoMatchCheck').checked,
          matchBy: document.getElementById('stockCodeMatchCheck').checked ? 'stock_code' : 'barcode'
        };
      }
    });

    if (result.isConfirmed) {
      const { autoMatch, matchBy } = result.value;
      try {
        Swal.fire({ title: 'Başlatılıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const response = await fetch(`/api/${mp}/send_all`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source_id: selectedSourceId, auto_match: autoMatch, match_by: matchBy })
        });
        const data = await response.json();
        if (data.success && data.batch_id && window.showJobWidget) {
          window.showJobWidget(data.batch_id);
          Swal.close();
        } else {
          Swal.fire('Hata', data.message || 'Başlatılamadı', 'error');
        }
      } catch (error) { Swal.fire('Hata', error.message, 'error'); }
    }
  }

  // Products Detail
  async function showProductDetail(barcode) {
    Swal.fire({ title: 'Yükleniyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    try {
      // Find product in current display or fetch if needed
      const url = `/api/xml_source_products?source_id=${selectedSourceId}&q=${barcode}&per_page=1`;
      const resp = await fetch(url);
      const data = await resp.json();
      if (!data.items || data.items.length === 0) {
        Swal.fire('Hata', 'Ürün bulunamadı', 'error');
        return;
      }
      const product = data.items[0];
      const imgUrl = (product.images && product.images[0] && (product.images[0].url || product.images[0])) || 'https://via.placeholder.com/200x200?text=IMG';

      Swal.fire({
        title: product.title,
        html: `
          <div class="text-start">
            <div class="text-center mb-3">
              <img src="${imgUrl}" class="img-fluid rounded shadow-sm" style="max-height: 200px;">
            </div>
            <table class="table table-sm table-bordered">
              <tr><th class="bg-light" style="width: 30%;">Barkod</th><td>${product.barcode}</td></tr>
              <tr><th class="bg-light">Stok Kodu</th><td>${product.stock_code || '---'}</td></tr>
              <tr><th class="bg-light">Marka</th><td>${product.brand || '---'}</td></tr>
              <tr><th class="bg-light">Kategori</th><td>${product.category || '---'}</td></tr>
              <tr><th class="bg-light">Fiyat</th><td>${Number(product.price || 0).toFixed(2)} TL</td></tr>
              <tr><th class="bg-light">Stok</th><td>${parseInt(product.quantity || 0)}</td></tr>
            </table>
            <div class="mb-1 fw-bold">Açıklama:</div>
            <div class="small p-2 bg-light border rounded" style="max-height: 150px; overflow-y: auto;">
              ${product.description || 'Açıklama yok.'}
            </div>
          </div>
        `,
        width: '600px',
        confirmButtonText: 'Kapat'
      });
    } catch (e) {
      Swal.fire('Hata', 'Ürün detayları yüklenemedi', 'error');
    }
  }

  // Initial Load
  document.addEventListener('DOMContentLoaded', async () => {
    // 1. Initial UI Setup
    if (window.activeJobId && window.showJobWidget) {
      window.showJobWidget(window.activeJobId);
    }

    // Load Multipliers & Brands
    try {
      const resp = await fetch('/api/settings/multipliers');
      const data = await resp.json();
      if (data.success) {
        multipliers = data.multipliers;
        brandOverrides = data.brands || {};
      }
    } catch (e) { console.error("Settings load error:", e); }

    // Tab Switch Listener
    const marketplaceTabs = document.querySelectorAll('#marketplaceTabs button');
    marketplaceTabs.forEach(tab => {
      tab.addEventListener('shown.bs.tab', (e) => {
        const mp = e.target.dataset.mp;
        currentMarketplace = mp;

        // Update Header
        const priceHeader = document.getElementById('priceHeader');
        const mpInfoCard = document.getElementById('mpInfoCard');

        if (mp === 'all') {
          priceHeader.textContent = 'Fiyat / Stok';
          mpInfoCard.classList.add('d-none');
        } else {
          priceHeader.innerHTML = `<span class="text-primary">${e.target.innerText} Fiyatı</span>`;
          mpInfoCard.classList.remove('d-none');

          // Update Info Card
          document.getElementById('mpTitle').textContent = `${e.target.innerText} Görünümü`;
          document.getElementById('mpMultiplierText').textContent = `${(multipliers[mp] || 1).toFixed(2)}x`;

          // Brand Override Info
          const brandInfo = document.getElementById('mpBrandOverrideInfo');
          const brandNameSpan = document.getElementById('mpBrandName');
          if (brandOverrides[mp] && brandOverrides[mp].name) {
            brandNameSpan.textContent = brandOverrides[mp].name;
            brandInfo.classList.remove('d-none');
          } else {
            brandInfo.classList.add('d-none');
          }

          // Set Icon
          const iconBox = document.getElementById('mpIconBox');
          iconBox.innerHTML = tab.querySelector('i').outerHTML;
          iconBox.style.color = tab.style.color || 'var(--primary)';
        }

        // RE-RENDER
        fetchProducts();
      });
    });

    // 2. Logic: Priority to LocalStorage Source ID
    const savedPrefix = localStorage.getItem('xmlTitlePrefix');
    if (savedPrefix) {
      const inp = document.getElementById('titlePrefixInput');
      if (inp) inp.value = savedPrefix;
    }

    if (selectedSourceId) {
      // We have a stored ID, fetch immediately
      fetchProducts().catch(e => console.error("Initial fetch failed:", e));
    } else {
      // No source ever selected
      chooseSource();
    }
  });
</script>
{% endblock %}