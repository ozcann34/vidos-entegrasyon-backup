{% extends "_base.html" %}
{% block title %}XML Ürün Listesi — VIDOS{% endblock %}
{% block page_title %}Tedarikçi XML'den Gelen Ürünler{% endblock %}

{% block content %}
<div class="animate-fade-in">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center gap-2">
      <button id="changeSourceBtn"
        class="btn btn-outline-primary border-2 px-3 shadow-sm d-flex align-items-center gap-2">
        <i class="bi bi-hdd-network fs-5"></i>
        <span class="fw-bold">Kaynak Değiştir</span>
      </button>
      <span id="productCount"
        class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2 rounded-pill fw-bold">
        Yükleniyor...
      </span>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button id="toggleViewBtn" class="btn btn-light border shadow-sm px-3" data-mode="list">
        <i class="bi bi-grid-3x3-gap me-1"></i> Görünüm: Grid
      </button>
      <button id="sendAllBtn" class="btn btn-admin px-4 shadow-sm animate-pulse">
        <i class="bi bi-rocket-takeoff me-2"></i> Tümünü Gönder
      </button>
    </div>
  </div>
</div>

<!-- Advanced Filters -->
<div class="card mb-3 border-0 shadow-sm animate-fade-in" style="background: var(--card);">
  <div class="card-body p-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h6 class="mb-0 text-secondary"><i class="bi bi-funnel me-2"></i>Gelişmiş Filtreler</h6>
      <button class="btn btn-sm btn-link text-decoration-none text-muted p-0" onclick="clearFilters()">Filtreleri
        Temizle</button>
    </div>
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label small fw-bold mb-1">Min. Stok</label>
        <input type="number" id="minStockInput" class="form-control form-control-sm" placeholder="0">
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-bold mb-1">Max. Stok</label>
        <input type="number" id="maxStockInput" class="form-control form-control-sm" placeholder="99999">
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-bold mb-1">Min. Fiyat</label>
        <input type="number" id="minPriceInput" class="form-control form-control-sm" placeholder="0.00">
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-bold mb-1">Max. Fiyat</label>
        <input type="number" id="maxPriceInput" class="form-control form-control-sm" placeholder="100000.00">
      </div>
      <div class="col-md-2">
        <label class="form-label small fw-bold mb-1">Kategori</label>
        <input type="text" id="categoryInput" class="form-control form-control-sm" placeholder="Kategori ara...">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <div class="form-check form-switch mb-1">
          <input class="form-check-input" type="checkbox" id="hasImageFilter">
          <label class="form-check-label small" for="hasImageFilter">Sadece Resimliler</label>
        </div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 text-end">
        <button id="applyFiltersBtn" class="btn btn-primary btn-sm px-4 shadow-sm" onclick="fetchProducts(1)">
          Filtreleri Uygula
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Tools & Options -->
<div class="card mb-4 border-0 shadow-sm animate-fade-in" style="background: var(--card);">
  <div class="card-body p-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h6 class="mb-0 text-secondary"><i class="bi bi-sliders me-2"></i>Gönderim Ayarları</h6>
      <span class="badge text-muted border py-1 px-2" style="background: var(--input-bg);">
        Ayarlar toplu gönderim sırasında otomatik uygulanır.
      </span>
    </div>
    <div class="row g-4">
      <!-- Sol Kolon: Başlık ve Fiyat Ayarları -->
      <div class="col-lg-5 border-end">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label small fw-bold mb-1">Başlık Ön Ek (Prefix)</label>
            <input type="text" id="titlePrefixInput" class="form-control form-control-sm"
              placeholder="Örn: [KAMPANYA] ">
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold mb-1">Fiyat Çarpanı</label>
            <input type="number" id="priceMultiplierInput" class="form-control form-control-sm" value="1.0" step="0.01">
          </div>
          <div class="col-md-12">
            <label class="form-label small fw-bold mb-1">Fiyat 0 ise varsayılan fiyat</label>
            <input type="number" id="defaultPriceInput" class="form-control form-control-sm" placeholder="0.00">
            <div class="form-text small mt-1" style="font-size: 0.7rem;">XML'de fiyat bulunamazsa bu değer kullanılır.
            </div>
          </div>
        </div>
      </div>

      <!-- Sağ Kolon: Atlatma ve Eşleştirme Seçenekleri -->
      <div class="col-lg-7">
        <label class="form-label small fw-bold mb-2">Gönderim Seçenekleri</label>
        <div class="row g-2">
          <div class="col-md-6">
            <div class="form-check form-switch p-2 border rounded-3 bg-light bg-opacity-10 mb-2">
              <input class="form-check-input ms-0 me-2" type="checkbox" id="optSkipNoBarcode">
              <label class="form-check-label small fw-semibold" for="optSkipNoBarcode">Barkodsuz Ürünleri Atla</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check form-switch p-2 border rounded-3 bg-light bg-opacity-10 mb-2">
              <input class="form-check-input ms-0 me-2" type="checkbox" id="optSkipNoImage">
              <label class="form-check-label small fw-semibold" for="optSkipNoImage">Resimsiz Ürünleri Atla</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check form-switch p-2 border rounded-3 bg-light bg-opacity-10 mb-2">
              <input class="form-check-input ms-0 me-2" type="checkbox" id="optMatchByStockCode">
              <label class="form-check-label small fw-semibold" for="optMatchByStockCode">Stok Kodu İle Eşleştir</label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check form-switch p-2 border rounded-3 bg-light bg-opacity-10 mb-2">
              <input class="form-check-input ms-0 me-2" type="checkbox" id="optZeroStockAsOne">
              <label class="form-check-label small fw-semibold" for="optZeroStockAsOne">Stok 0 ise 1 Gönder</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive shadow-sm card border-0 mb-4" id="listContainer">
  <table class="table table-hover align-middle mb-0">
    <thead class="bg-light">
      <tr>
        <th style="width: 40px;" class="ps-3"><input id="selectAll" type="checkbox" class="form-check-input"></th>
        <th style="width: 70px;">Görsel</th>
        <th style="width: 30%;">Ürün Adı</th>
        <th>Barkod</th>
        <th>Kategori Yolu</th>
        <th>Fiyat / Stok</th>
        <th>Durum</th>
      </tr>
    </thead>
    <tbody id="productListBody"></tbody>
  </table>
</div>

<div id="gridContainer" class="d-none mb-4">
  <div id="productGrid" class="row g-3"></div>
</div>

<nav class="pb-4">
  <ul class="pagination justify-content-center shadow-sm" id="pagination"></ul>
</nav>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Global Variables
  let currentPage = 1;
  let itemsPerPage = 5000;
  let currentSearchQuery = '';
  let currentTotal = 0;
  let selectedSourceId = localStorage.getItem('vidos_xml_source_id') || null;
  const selectedBarcodes = new Set();
  let viewMode = localStorage.getItem('vidos_view_mode') || 'list';

  // DOM Elements
  const productListBody = document.getElementById('productListBody');
  const pagination = document.getElementById('pagination');
  const productCountSpan = document.getElementById('productCount');
  const searchInput = document.getElementById('searchInput');
  const perPageSelect = document.getElementById('perPageSelect');
  const goToInput = document.getElementById('goToInput');
  const goToBtn = document.getElementById('goToBtn');
  const selectAll = document.getElementById('selectAll');
  const changeSourceBtn = document.getElementById('changeSourceBtn');
  const toggleViewBtn = document.getElementById('toggleViewBtn');

  // --- Helper Functions ---

  function showSummaryAndRedirect(j) {
    try { Swal.close(); } catch (e) { }
    const m = j.matched || [];
    const sk = j.skipped || [];
    const s = j.summary || { success_count: 0, fail_count: 0, failures: [] };

    const failures = (s.failures || []).map(f => `
      <div class="d-flex align-items-center mb-2 p-2 border-bottom border-danger border-opacity-10">
        <span class="badge bg-danger me-2" style="font-size: 0.7rem;">HATA</span>
        <div class="small">
          <div class="fw-bold text-dark">${f.barcode || 'Bilinmeyen Barkod'}</div>
          <div class="text-muted">${(Array.isArray(f.reasons) ? f.reasons.join(', ') : f.reasons) || 'Sistem hatası'}</div>
        </div>
      </div>
    `).join('') || '<div class="text-center text-muted py-3 small">Hata kaydı bulunmuyor.</div>';

    const skippedList = sk.map(x => `
      <div class="d-flex align-items-center mb-2 p-2 border-bottom border-warning border-opacity-10">
        <span class="badge bg-warning text-dark me-2" style="font-size: 0.7rem;">ATLANI</span>
        <div class="small">
          <div class="fw-bold text-dark">${x.barcode || 'Bilinmeyen'}</div>
          <div class="text-muted">${x.reason || 'Kategori eşleşmedi'}</div>
        </div>
      </div>
    `).join('') || '<div class="text-center text-muted py-3 small">Atlanan ürün bulunmuyor.</div>';

    const html = `
    <div class="text-start" style="font-family: 'Inter', sans-serif;">
      <!-- İşlem Durumu -->
      <div class="p-3 bg-light rounded-3 mb-4 shadow-sm border border-primary border-opacity-25">
        <h6 class="fw-bold text-primary mb-3"><i class="bi bi-activity me-2"></i>İşlem Durumu</h6>
        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="p-2 border rounded bg-white">
              <div class="text-muted small">Başarılı</div>
              <div class="h5 fw-bold text-success mb-0">${s.success_count}</div>
            </div>
          </div>
          <div class="col-6">
            <div class="p-2 border rounded bg-white">
              <div class="text-muted small">Hatalı</div>
              <div class="h5 fw-bold text-danger mb-0">${s.fail_count}</div>
            </div>
          </div>
        </div>
        <div class="small text-muted mb-1 d-flex justify-content-between">
          <span>Match: ${m.length} / Atlanan: ${sk.length}</span>
          <span class="fw-bold">B. ID: ${j.batch_id ? j.batch_id.substring(0, 8) : '-'}</span>
        </div>
      </div>

      <!-- Detaylı Raporlar -->
      <h6 class="fw-bold text-dark mb-2"><i class="bi bi-file-earmark-text me-2"></i>İşlem Raporları</h6>
      <ul class="nav nav-tabs nav-fill mb-2" id="reportTabs" role="tablist" style="font-size: 0.85rem;">
        <li class="nav-item">
          <button class="nav-link active py-1" data-bs-toggle="tab" data-bs-target="#errorReport">Hatalar (${s.fail_count})</button>
        </li>
        <li class="nav-item">
          <button class="nav-link py-1" data-bs-toggle="tab" data-bs-target="#skipReport">Atlananlar (${sk.length})</button>
        </li>
      </ul>
      <div class="tab-content border rounded bg-white overflow-auto" style="max-height: 250px;">
        <div class="tab-pane fade show active p-2" id="errorReport">
          ${failures}
        </div>
        <div class="tab-pane fade p-2" id="skipReport">
          ${skippedList}
        </div>
      </div>
    </div>`;

    Swal.fire({
      title: 'Gönderim Raporu',
      html,
      width: '600px',
      icon: (s.fail_count > 0 ? 'warning' : 'success'),
      showCancelButton: true,
      confirmButtonText: '<i class="bi bi-list-check me-2"></i>Tüm Kayıtlara Git',
      cancelButtonText: 'Kapat',
      confirmButtonColor: '#3085d6',
      customClass: {
        container: 'vidos-report-swal'
      }
    }).then(res => {
      if (res.isConfirmed) {
        window.location.href = j.batch_id ? `/batch/${j.batch_id}` : '/batch_logs';
      }
    });
  }

  function renderProducts(products) {
    try {
      const listContainer = document.getElementById('listContainer');
      const gridContainer = document.getElementById('gridContainer');
      const grid = document.getElementById('productGrid');

      if (!listContainer || !gridContainer || !productListBody) return;

      if (viewMode === 'list') {
        listContainer.classList.remove('d-none');
        gridContainer.classList.add('d-none');
        productListBody.innerHTML = '';

        if (!products || products.length === 0) {
          productListBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Hiç ürün bulunamadı.</td></tr>';
          return;
        }

        products.forEach(product => {
          const checked = selectedBarcodes.has(product.barcode) ? 'checked' : '';
          const imgUrl = (product.images && product.images[0] && (product.images[0].url || product.images[0])) || 'https://via.placeholder.com/120x120?text=IMG';
          const row = `
              <tr class="animate-fade-in">
                  <td class="ps-3"><input type="checkbox" class="form-check-input row-check" data-barcode="${product.barcode}" ${checked}></td>
                  <td><img src="${imgUrl}" alt="${product.title}" class="img-thumbnail border-0 shadow-sm" style="width: 50px; height: 50px; object-fit: cover;"></td>
                  <td class="text-truncate" style="max-width: 250px;" title="${product.title}">${product.title}</td>
                  <td><span class="badge bg-secondary font-monospace">${product.barcode}</span></td>
                  <td style="font-size: 0.85rem;" class="text-muted text-truncate" style="max-width: 150px;">${product.category || '---'}</td>
                  <td>
                    <div class="d-flex flex-column">
                      <span class="fw-bold">${Number(product.price || 0).toFixed(2)} TL</span>
                      <span class="small text-success fw-bold">Stok: ${parseInt(product.quantity || 0)}</span>
                    </div>
                  </td>
                  <td><span class="badge bg-info bg-opacity-10 text-info border border-info">Hazır</span></td>
              </tr>
          `;
          productListBody.insertAdjacentHTML('beforeend', row);
        });

      } else {
        // Grid View
        listContainer.classList.add('d-none');
        gridContainer.classList.remove('d-none');
        grid.innerHTML = '';

        if (!products || products.length === 0) {
          grid.innerHTML = '<div class="col-12 text-center p-5 text-muted">Hiç ürün bulunamadı.</div>';
          return;
        }

        products.forEach(product => {
          const checked = selectedBarcodes.has(product.barcode) ? 'checked' : '';
          const imgUrl = (product.images && product.images[0] && (product.images[0].url || product.images[0])) || 'https://via.placeholder.com/300x200?text=IMG';
          const card = `
              <div class="col-12 col-sm-6 col-md-4 col-lg-3 animate-fade-in">
                <div class="card h-100 border-0 shadow-sm product-card">
                  <div class="card-body p-2 d-flex flex-column">
                    <div class="d-flex align-items-start justify-content-between mb-2">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input row-check" data-barcode="${product.barcode}" ${checked}>
                      </div>
                      <span class="badge bg-secondary font-monospace small">${product.barcode}</span>
                    </div>
                    <div class="text-center mb-2" style="height: 160px; overflow: hidden; border-radius: 8px; background: #f8f9fa;">
                      <img src="${imgUrl}" class="h-100 w-100" style="object-fit: contain;">
                    </div>
                    <div class="fw-semibold text-truncate mb-1" title="${product.title}">${product.title}</div>
                    <div class="text-muted small mb-2 text-truncate">${product.category_path || '---'}</div>
                    <div class="mt-auto d-flex justify-content-between align-items-center pt-2 border-top">
                      <div class="fw-bold fs-5 text-primary">${Number(product.price || 0).toFixed(2)} TL</div>
                      <div class="badge bg-success bg-opacity-10 text-success">Stok: ${parseInt(product.quantity || 0)}</div>
                    </div>
                  </div>
                </div>
              </div>`;
          grid.insertAdjacentHTML('beforeend', card);
        });
      }

      // Re-attach event listeners
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const bc = e.target.dataset.barcode;
          if (e.target.checked) selectedBarcodes.add(bc); else selectedBarcodes.delete(bc);
        });
      });
    } catch (err) {
      console.error("Render error:", err);
    }
  }

  function addPageItem(num, active = false, disabled = false, text = null) {
    const li = document.createElement('li');
    li.className = `page-item ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}`;
    const label = text || num;
    li.innerHTML = `<a class="page-link" href="#" data-page="${num}">${label}</a>`;
    if (!disabled) {
      li.addEventListener('click', (e) => { e.preventDefault(); currentPage = parseInt(e.target.dataset.page); fetchProducts(); });
    }
    pagination.appendChild(li);
  }

  function renderPagination(total, current) {
    const totalPages = Math.ceil(total / itemsPerPage) || 1;
    pagination.innerHTML = '';
    addPageItem(Math.max(1, current - 1), false, current === 1, '«');
    const windowSize = 2;
    const pages = [];
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= current - windowSize && i <= current + windowSize)) pages.push(i);
    }
    let last = 0;
    pages.forEach(p => {
      if (p - last > 1) {
        const li = document.createElement('li'); li.className = 'page-item disabled'; li.innerHTML = '<span class="page-link">…</span>'; pagination.appendChild(li);
      }
      addPageItem(p, p === current);
      last = p;
    });
    addPageItem(Math.min(totalPages, current + 1), false, current === totalPages, '»');
  }

  async function fetchProducts(page = 1) {
    if (!selectedSourceId) {
      productListBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Lütfen bir XML kaynağı seçin.</td></tr>';
      return;
    }
    currentPage = page;
    currentSearchQuery = searchInput.value;

    const minStock = document.getElementById('minStockInput')?.value;
    const maxStock = document.getElementById('maxStockInput')?.value;
    const minPrice = document.getElementById('minPriceInput')?.value;
    const maxPrice = document.getElementById('maxPriceInput')?.value;
    const category = document.getElementById('categoryInput')?.value;
    const hasImage = document.getElementById('hasImageFilter')?.checked;

    if (viewMode === 'list') {
      productListBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-primary"><div class="spinner-border spinner-border-sm me-2"></div> Ürünler yükleniyor...</td></tr>';
    } else {
      const grid = document.getElementById('productGrid');
      if (grid) grid.innerHTML = '<div class="col-12 text-center p-5 text-primary"><div class="spinner-border spinner-border-sm me-2"></div> Ürünler yükleniyor...</div>';
    }

    let url = `/api/xml_source_products?source_id=${selectedSourceId}&page=${page}&per_page=${itemsPerPage}&q=${encodeURIComponent(currentSearchQuery)}`;

    if (minStock) url += `&min_stock=${minStock}`;
    if (maxStock) url += `&max_stock=${maxStock}`;
    if (minPrice) url += `&min_price=${minPrice}`;
    if (maxPrice) url += `&max_price=${maxPrice}`;
    if (category) url += `&category=${encodeURIComponent(category)}`;
    if (hasImage) url += `&has_image=true`;

    try {
      const resp = await fetch(url);
      const data = await resp.json();
      currentTotal = data.total || 0;
      productCountSpan.innerText = `Toplam ${currentTotal.toLocaleString('tr-TR')} ürün`;
      renderProducts(data.items || []);
      renderPagination(currentTotal, currentPage);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (e) {
      console.error("Fetch error:", e);
      const errorMsg = '<tr><td colspan="7" class="text-center p-5 text-danger">Ürünler yüklenemedi. Lütfen sayfayı yenileyin.</td></tr>';
      if (viewMode === 'list') productListBody.innerHTML = errorMsg;
      else {
        const grid = document.getElementById('productGrid');
        if (grid) grid.innerHTML = '<div class="col-12 text-center p-5 text-danger">Ürünler yüklenemedi.</div>';
      }
    }
  }

  function clearFilters() {
    document.getElementById('minStockInput').value = '';
    document.getElementById('maxStockInput').value = '';
    document.getElementById('minPriceInput').value = '';
    document.getElementById('maxPriceInput').value = '';
    document.getElementById('categoryInput').value = '';
    document.getElementById('hasImageFilter').checked = false;
    searchInput.value = '';
    fetchProducts(1);
  }

  // --- Event Listeners ---

  // Search
  let debounceTimeout;
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        currentSearchQuery = e.target.value.trim();
        currentPage = 1;
        fetchProducts();
      }, 500);
    });
  }


  // Go to Page
  function goToPage() {
    const val = parseInt(goToInput.value || '1');
    const totalPages = Math.ceil(currentTotal / itemsPerPage) || 1;
    if (val >= 1 && val <= totalPages) { currentPage = val; fetchProducts(); }
  }
  if (goToBtn) goToBtn.addEventListener('click', goToPage);
  if (goToInput) goToInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); goToPage(); } });

  // Select All
  if (selectAll) {
    selectAll.addEventListener('change', (e) => {
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.checked = e.target.checked;
        const bc = cb.dataset.barcode;
        if (e.target.checked) selectedBarcodes.add(bc); else selectedBarcodes.delete(bc);
      });
    });
  }

  // Toggle View
  if (toggleViewBtn) {
    // Set initial UI based on local storage
    if (viewMode === 'grid') {
      toggleViewBtn.dataset.mode = 'grid';
      toggleViewBtn.innerHTML = '<i class="bi bi-list-ul me-1"></i> Görünüm: Liste';
    }

    toggleViewBtn.addEventListener('click', () => {
      if (viewMode === 'list') {
        viewMode = 'grid';
        toggleViewBtn.dataset.mode = 'grid';
        toggleViewBtn.innerHTML = '<i class="bi bi-list-ul me-1"></i> Görünüm: Liste';
      } else {
        viewMode = 'list';
        toggleViewBtn.dataset.mode = 'list';
        toggleViewBtn.innerHTML = '<i class="bi bi-grid-3x3-gap me-1"></i> Görünüm: Grid';
      }
      localStorage.setItem('vidos_view_mode', viewMode);
      fetchProducts(); // Re-render logic handles container visibility
    });
  }

  // Change Source
  function chooseSource() {
    fetch('/api/xml_sources').then(r => r.json()).then(j => {
      const items = j.items || [];
      if (items.length === 0) { Swal.fire('Bilgi', 'Kayıtlı XML kaynağı yok. Ayarlar sayfasından ekleyin.', 'info'); return; }
      const opts = items.reduce((acc, it) => { acc[it.id] = `${it.name}`; return acc; }, {});
      Swal.fire({ title: 'XML Kaynağı Seçin', input: 'select', inputOptions: opts, showCancelButton: true, confirmButtonText: 'Seç' })
        .then(res => {
          if (!res.isConfirmed) return;
          selectedSourceId = res.value;
          localStorage.setItem('vidos_xml_source_id', String(selectedSourceId));
          currentPage = 1;
          fetchProducts();
        });
    });
  }
  if (changeSourceBtn) changeSourceBtn.addEventListener('click', chooseSource);

  // Send selected (other marketplaces)
  // New Individual Send Buttons Logic
  const sendTrendyolBtn = document.getElementById('sendTrendyolBtn');
  const sendHepsiburadaBtn = document.getElementById('sendHepsiburadaBtn');
  const sendPazaramaBtn = document.getElementById('sendPazaramaBtn');
  const sendIdefixBtn = document.getElementById('sendIdefixBtn');

  function sendToMarketplace(mp, mpName, color = '#primary') {
    const barcodes = Array.from(selectedBarcodes);
    if (barcodes.length === 0) { Swal.fire('Uyarı', 'Lütfen ürün seçin', 'warning'); return; }

    Swal.fire({
      title: `${mpName}'a Gönderilecek`,
      html: `<p class="fs-5 fw-bold" style="color:${color}">${barcodes.length} ürün ${mpName} pazaryerine gönderilecek.</p><p>Doğru pazaryerini seçtiğinizden emin misiniz?</p>`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Evet, Gönder',
      cancelButtonText: 'İptal',
      confirmButtonColor: color
    }).then(confirm => {
      if (!confirm.isConfirmed) return;

      function getOptions() {
        return {
          title_prefix: document.getElementById('titlePrefixInput')?.value || '',
          match_by: document.getElementById('optMatchByStockCode')?.checked ? 'stock_code' : 'barcode',
          price_multiplier: parseFloat(document.getElementById('priceMultiplierInput')?.value || '1.0'),
          default_price: parseFloat(document.getElementById('defaultPriceInput')?.value || '0'),
          skip_no_barcode: document.getElementById('optSkipNoBarcode')?.checked || false,
          skip_no_image: document.getElementById('optSkipNoImage')?.checked || false,
          zero_stock_as_one: document.getElementById('optZeroStockAsOne')?.checked || false
        };
      }

      function doSend(xml_source_id) {
        Swal.fire({ title: 'Gönderiliyor', text: 'İşlem biraz sürebilir...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const opts = getOptions();
        const payload = { barcodes, xml_source_id, ...opts };

        fetch(`/api/send_selected/${mp}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
          .then(r => r.json()).then(j => {
            if (j.success) { showSummaryAndRedirect(j); }
            else { Swal.fire('Hata', j.message || 'İşlem başarısız', 'error'); }
          }).catch(() => Swal.fire('Hata', 'API çağrısı sırasında bir sorun oluştu.', 'error'));
      }

      function doSendAuto(xml_source_id) {
        Swal.fire({ title: 'Gönderiliyor', text: 'Kategori eşlemesi yapılıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const opts = getOptions();
        const payload = { barcodes, xml_source_id, auto_match: true, ...opts };

        fetch(`/api/trendyol/send_auto`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
          .then(r => r.json()).then(j => {
            if (j.success) { showSummaryAndRedirect(j); }
            else { Swal.fire('Hata', j.message || 'İşlem başarısız', 'error'); }
          }).catch(() => Swal.fire('Hata', 'API çağrısı sırasında bir sorun oluştu.', 'error'));
      }

      if (mp === 'trendyol') {
        Swal.fire({
          title: 'Otomatik Kategori Eşleştirilsin mi?',
          text: 'Ürün adı ile en yakın kategori bulunup gönderilecek.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Evet, otomatik',
          cancelButtonText: 'Hayır, manuel'
        }).then(ans => {
          const proceedAuto = ans.isConfirmed;
          const doNext = (id) => proceedAuto ? doSendAuto(id) : doSend(id);
          doNext(selectedSourceId);
        });
      } else {
        doSend(selectedSourceId);
      }
    });
  }

  if (sendTrendyolBtn) sendTrendyolBtn.addEventListener('click', () => sendToMarketplace('trendyol', 'Trendyol', '#ffc107'));
  if (sendHepsiburadaBtn) sendHepsiburadaBtn.addEventListener('click', () => sendToMarketplace('hepsiburada', 'Hepsiburada', '#FF6000'));
  if (sendPazaramaBtn) sendPazaramaBtn.addEventListener('click', () => sendToMarketplace('pazarama', 'Pazarama', '#0d6efd'));
  if (sendIdefixBtn) sendIdefixBtn.addEventListener('click', () => sendToMarketplace('idefix', 'İdefix', '#0dcaf0'));
  if (document.getElementById('sendN11Btn')) document.getElementById('sendN11Btn').addEventListener('click', () => sendToMarketplace('n11', 'N11', '#5f259f'));

  // Hook into Send All button
  const sendAllBtn = document.getElementById('sendAllBtn');
  if (sendAllBtn) {
    sendAllBtn.addEventListener('click', async () => {
      const result = await Swal.fire({
        title: 'Tüm Ürünleri Gönder',
        html: `
          <div class="text-start">
            <p>Hangi pazaryerine göndermek istiyorsunuz?</p>
            <select id="marketplaceSelect" class="form-select">
              <option value="trendyol">Trendyol</option>
              <option value="hepsiburada">Hepsiburada</option>
              <option value="pazarama">Pazarama</option>
              <option value="idefix">İdefix</option>
              <option value="n11">N11</option>
            </select>
            </div>
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="autoMatchCheck" checked>
              <label class="form-check-label" for="autoMatchCheck">
                Otomatik kategori eşleştir (Varsayılan)
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="stockCodeMatchCheck">
              <label class="form-check-label" for="stockCodeMatchCheck">
                Stok Kodu İle Eşleştir (Barkod yerine)
              </label>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Başlat',
        cancelButtonText: 'İptal',
        preConfirm: () => {
          return {
            marketplace: document.getElementById('marketplaceSelect').value,
            autoMatch: document.getElementById('autoMatchCheck').checked,
            matchBy: document.getElementById('stockCodeMatchCheck').checked ? 'stock_code' : 'barcode'
          };
        }
      });
      if (result.isConfirmed) {
        const { marketplace, autoMatch, matchBy } = result.value;
        try {
          const response = await fetch(`/api/${marketplace}/send_all`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_id: selectedSourceId, auto_match: autoMatch, match_by: matchBy })
          });
          const data = await response.json();
          if (data.success && data.batch_id && window.showJobWidget) {
            window.showJobWidget(data.batch_id);
          } else {
            Swal.fire('Hata', data.message || 'Başlatılamadı', 'error');
          }
        } catch (error) { Swal.fire('Hata', error.message, 'error'); }
      }
    });
  }

  // Initial Load
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Initial UI Setup
    if (window.activeJobId && window.showJobWidget) {
      window.showJobWidget(window.activeJobId);
    }

    // 2. Logic: Priority to LocalStorage Source ID
    const savedPrefix = localStorage.getItem('xmlTitlePrefix');
    if (savedPrefix) {
      const inp = document.getElementById('titlePrefixInput');
      if (inp) inp.value = savedPrefix;
    }

    if (selectedSourceId) {
      // We have a stored ID, fetch immediately
      fetchProducts().catch(e => console.error("Initial fetch failed:", e));
    } else {
      // No source ever selected
      chooseSource();
    }
  });
</script>
{% endblock %}