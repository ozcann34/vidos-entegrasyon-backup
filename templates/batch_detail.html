{% extends "_base.html" %}
{% block title %}Batch Detay — VIDOS{% endblock %}
{% block page_title %}Batch Detay{% endblock %}

{% block content %}
<div class="card p-3 animate-fade-in">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <a href="{{ url_for('main.batch_logs') }}" class="btn btn-sm btn-outline-secondary btn-animated"><i
          class="bi bi-arrow-left me-2"></i> Loglara Geri Dön</a>
      {% if entry.job_type %}
      <span class="badge bg-info ms-2 text-uppercase" style="letter-spacing: 1px; font-size: 0.7rem;">{{
        entry.job_type.replace('_', ' ') }}</span>
      {% endif %}
    </div>
    <span class="badge bg-secondary font-monospace">{{ entry.batch_id }}</span>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="p-3 border rounded h-100" style="background: var(--bg) !important;">
        <small class="text-muted d-block mb-1">Pazar Yeri</small>
        <span class="badge bg-dark fs-6">{{ entry.marketplace | upper }}</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="p-3 border rounded h-100" style="background: var(--bg) !important;">
        <small class="text-muted d-block mb-1">Ürün Sayısı</small>
        <span class="fw-bold fs-5">{{ entry.product_count }}</span>
      </div>
    </div>
    <div class="col-md-4">
      <div class="p-3 border rounded h-100" style="background: var(--bg) !important;">
        <small class="text-muted d-block mb-1">Durum</small>
        {% if entry.success %}
        <span class="badge bg-success fs-6"><i class="bi bi-check-circle-fill me-1"></i> Başarılı</span>
        {% else %}
        <span class="badge bg-danger fs-6"><i class="bi bi-x-circle-fill me-1"></i> Hata</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="mb-3 text-muted small">
    <i class="bi bi-clock me-1"></i> {{ entry.timestamp }}
  </div>

  {% set d = entry.get_details() %}

  {% if d and d.error %}
  <div class="alert alert-danger shadow-sm">
    <h6 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Hata Mesajı</h6>
    <pre class="mb-0 mt-2" style="white-space: pre-wrap;">{{ d.error }}</pre>
  </div>
  {% endif %}

  {% if d and d.logs %}
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-terminal me-2"></i>İşlem Logları ({{ d.logs|length }})</h6>
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" type="checkbox" id="filterErrors">
        <label class="form-check-label small text-muted" for="filterErrors">Sadece Hatalıları Göster</label>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="list-group list-group-flush" id="logList" style="max-height: 400px; overflow-y: auto;">
        {% for log in d.logs %}
        <div class="list-group-item py-2 log-item" data-level="{{ log.level or 'info' }}"
          style="background: transparent; color: var(--text);">
          <div class="d-flex justify-content-between align-items-start">
            <span
              class="badge bg-{{ 'danger' if log.level == 'error' else 'warning' if log.level == 'warning' else 'info' }} me-2 text-uppercase"
              style="font-size: 0.65rem;">{{
              log.level or 'info' }}</span>
            <small class="text-muted ms-auto">{{ log.timestamp or '' }}</small>
          </div>
          <div class="mt-1 small">{{ log.message }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  {% if d and (d.summary and d.summary.failures) or (d.failures) %}
  {% set failures = d.summary.failures if d.summary and d.summary.failures else d.failures %}
  <div class="card mb-4 border-danger shadow-sm" style="background: var(--bg);">
    <div class="card-header bg-danger text-white">
      <h6 class="mb-0"><i class="bi bi-exclamation-octagon me-2"></i>Hata Detayları ({{ failures|length }})</h6>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0" style="color: var(--text);">
          <thead style="background: rgba(0,0,0,0.05);">
            <tr>
              <th class="ps-3">Barkod / ID</th>
              <th>Hata Nedeni</th>
            </tr>
          </thead>
          <tbody>
            {% for f in failures %}
            <tr>
              <td class="ps-3 fw-bold">{{ f.barcode or f.code or 'N/A' }}</td>
              <td class="text-danger small">{{ f.reason or f.error or 'Bilinmeyen hata' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  {% if d and d.response_body %}
  <div class="mb-4">
    <h6 class="mb-2"><i class="bi bi-code-square me-2"></i>API Hata Gövdesi</h6>
    <pre class="p-3 border rounded"
      style="max-height:300px; overflow:auto; white-space:pre-wrap; background: var(--bg); color: var(--text);">{{ d.response_body }}</pre>
  </div>
  {% endif %}

  {% if entry.success_count or entry.fail_count or (d and d.summary) %}
  {% set s_cnt = entry.success_count or (d.summary.success_count if d and d.summary else 0) %}
  {% set f_cnt = entry.fail_count or (d.summary.fail_count if d and d.summary else 0) %}
  <div class="card mb-4 border-0 shadow-sm" style="background: var(--bg);">
    <div class="card-header bg-transparent border-0 pt-3">
      <h6 class="mb-0 fw-bold"><i class="bi bi-list-check me-2 text-primary"></i> İşlem Özeti</h6>
    </div>
    <div class="card-body">
      <div class="row text-center">
        <div class="col-6 border-end">
          <div class="text-success fw-bold display-6">{{ s_cnt }}</div>
          <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Başarılı</small>
        </div>
        <div class="col-6">
          <div class="text-danger fw-bold display-6">{{ f_cnt }}</div>
          <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Hatalı / Atlanan</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if d and d.matched %}
  <div class="mb-3">
    <strong>Eşleşen ({{ d.matched|length }}):</strong>
    <div class="small text-muted mt-1 p-2 border rounded" style="background: var(--bg);">
      {{ d.matched|map(attribute='barcode')|list|join(', ') }}
    </div>
  </div>
  {% endif %}

  {% if d and d.skipped %}
  <div class="mb-3">
    <strong>Atlanan ({{ d.skipped|length }}):</strong>
    <div class="mt-1">
      {% for s in d.skipped %}
      <span class="badge bg-secondary me-1 mb-1" title="{{ s.reason }}">{{ s.barcode }}</span>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% if d and (d.status or d.raw) %}
  <h6 class="mt-4"><i class="bi bi-file-earmark-code me-2"></i>Trendyol API Cevabı</h6>
  <pre class="p-3 border rounded mb-0"
    style="background: var(--bg); color: var(--text);">{{ (d.status or d.raw) | tojson(indent=2) }}</pre>
  {% endif %}

  {% if entry.success %}
  <div class="alert alert-info mt-4 shadow-sm border-0"
    style="background: rgba(13, 202, 240, 0.15); color: var(--text);">
    <div class="d-flex">
      <i class="bi bi-info-circle-fill me-3 fs-4 text-info"></i>
      <div>
        <h6 class="alert-heading fw-bold">İşlem Tamamlandı</h6>
        <p class="mb-0">{{ entry.marketplace | capitalize }} Toplu Ürün Yükleme (Batch) işlemi başarıyla tamamlanmıştır.
          Detaylar ve ürün durumları
          için
          pazaryeri satıcı panelini kontrol ediniz.</p>
      </div>
    </div>
  </div>
  {% elif d and d.skipped and d.skipped|length > 0 %}
  <div class="mt-4 text-center">
    <div class="alert alert-warning mb-3">
      <i class="bi bi-exclamation-circle me-2"></i> {{ d.skipped|length }} ürün gönderilemedi veya atlandı.
    </div>
    <form action="{{ url_for('main.retry_batch', batch_id=entry.batch_id) }}" method="POST">
      <button type="submit" class="btn btn-warning btn-lg shadow-sm px-5 rounded-pill fw-bold">
        <i class="bi bi-arrow-clockwise me-2"></i> Hatalı Ürünleri Tekrar Gönder
      </button>
    </form>
  </div>
  {% endif %}
</div>
{% endblock %}