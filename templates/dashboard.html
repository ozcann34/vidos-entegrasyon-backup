{% extends "_base.html" %}
{% block title %}Panel — VIDOS{% endblock %}
{% block page_title %}Gösterge Paneli{% endblock %}

{% block content %}

{% if current_user.subscription and not current_user.subscription.is_approved %}
<div class="alert alert-warning border-0 shadow-sm mb-4" role="alert">
  <div class="d-flex align-items-center">
    <i class="bi bi-hourglass-split fs-4 me-3"></i>
    <div>
      <h5 class="alert-heading fw-bold mb-1">Hesap Onayı Bekleniyor</h5>
      <p class="mb-0">BUG-Z Bayilik başvurunuz alınmıştır. Yönetici onayı sonrası tüm özellikler aktif edilecektir.</p>
    </div>
  </div>
</div>
{% endif %}

<div class="d-flex flex-wrap gap-2 mb-4 align-items-center">
  <div class="btn-group btn-group-mobile">
    <a href="{{ url_for('main.settings_page') }}" class="btn btn-outline-secondary">
      <i class="bi bi-gear me-1"></i> Ayarlar
    </a>
    <a href="{{ url_for('main.user_manual') }}" class="btn btn-primary shadow-sm fw-bold">
      <i class="bi bi-book-half me-2"></i>Rehber
    </a>
  </div>

  <div class="btn-group btn-group-mobile">
    <a href="{{ url_for('main.dashboard', force_sync='true') }}"
      class="btn btn-outline-info shadow-sm fw-bold text-center">
      <i class="bi bi-arrow-clockwise me-1"></i> Verileri Güncelle
    </a>
  </div>
  {% if last_sync %}
  <div class="w-100 text-end mobile-hide">
    <span class="btn btn-light disabled text-muted small" style="font-size: 0.8rem;" id="last-sync-time">
      Son Güncelleme: {{ last_sync }}
    </span>
  </div>
  {% endif %}
</div>

<!-- Kritik Stok Butonu -->
{% if stats.critical_stock %}
<button type="button" class="btn btn-danger position-relative" data-bs-toggle="modal"
  data-bs-target="#criticalStockModal">
  <i class="bi bi-exclamation-triangle-fill"></i> Kritik Stok
  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light">
    {{ stats.critical_stock|length }}
  </span>
</button>
{% endif %}

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
  {{ message }}
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

<!-- Bildirimler ve Raporlar -->
{% if stats.announcements or stats.user_notifications %}
<div class="row g-3 mb-4">
  {# Kullanıcı Bildirimleri #}
  {% for notif in stats.user_notifications %}
  <div class="col-md-6 col-xxl-4">
    <div class="card h-100 border-0 shadow-sm border-start border-4 border-{{ notif.type }}"
      style="border-radius: 12px;">
      <div class="card-body p-3 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h6 class="card-title fw-bold mb-0 text-dark d-flex align-items-center gap-2">
            <i class="bi bi-info-circle-fill text-{{ notif.type }}"></i>
            <span class="text-truncate" style="max-width: 200px;">{{ notif.title }}</span>
          </h6>
          <button type="button" class="btn-close small" aria-label="Kapat" style="font-size: 0.7rem;"
            onclick="dismissNotification('{{ notif.id }}')"></button>
        </div>
        <div class="small text-muted flex-grow-1 mb-2">
          {{ notif.message }}
        </div>
        {% if 'Abonelik' in notif.title %}
        <a href="{{ url_for('payment.payment_page') }}"
          class="btn btn-sm btn-{{ notif.type }} w-100 rounded-pill fw-bold">
          <i class="bi bi-credit-card me-1"></i> Şimdi Yenile
        </a>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}

  {# Genel Duyurular #}
  {% for ann in stats.announcements if 'bakım' not in ann.title|lower %}
  {% set alert_class = 'danger' if ann.priority == 'critical' else 'warning' if ann.priority == 'high' else 'info' %}
  {% set icon_class = 'exclamation-triangle-fill' if ann.priority == 'critical' else 'exclamation-circle-fill' if
  ann.priority == 'high' else 'info-circle-fill' %}

  <div class="col-md-6 col-xxl-4">
    <div class="card h-100 border-0 shadow-sm border-start border-4 border-{{ alert_class }}"
      style="border-radius: 12px;">
      <div class="card-body p-3 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h6 class="card-title fw-bold mb-0 text-dark d-flex align-items-center gap-2">
            <i class="bi bi-{{ icon_class }} text-{{ alert_class }}"></i>
            <span class="text-truncate" style="max-width: 200px;">{{ ann.title }}</span>
          </h6>
          <button type="button" class="btn-close small" aria-label="Kapat" style="font-size: 0.7rem;"
            onclick="dismissAnnouncement('{{ ann.id }}')"></button>
        </div>
        <div class="small text-muted flex-grow-1 mb-2"
          style="display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
          {{ ann.content | striptags }}
        </div>
        <button class="btn btn-sm btn-outline-{{ alert_class }} w-100 rounded-pill fw-bold"
          style="border-style: dashed;" data-bs-toggle="modal" data-bs-target="#annDetailModal{{ ann.id }}">
          <i class="bi bi-eye me-1"></i> Detayı İncele
        </button>
      </div>
    </div>
  </div>

  <!-- Detay Modalı -->
  <div class="modal fade" id="annDetailModal{{ ann.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-{{ alert_class }} text-white">
          <h5 class="modal-title fs-6 fw-bold"><i class="bi bi-info-circle-fill me-2"></i>Bildirim Detayı: {{ ann.title
            }}</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body p-4 bg-light">
          <div class="card p-3 border-0 shadow-sm">
            <h6 class="fw-bold text-muted mb-2">İçerik</h6>
            {% if 'Traceback' in ann.content or 'Error' in ann.content or 'Exception' in ann.content %}
            <div class="alert alert-secondary mb-0 p-3"
              style="font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
              {{ ann.content | safe }}</div>
            {% else %}
            <div class="fs-6">{{ ann.content | safe }}</div>
            {% endif %}
          </div>
          <div class="text-end mt-3 text-muted small">
            Oluşturulma: {{ ann.created_at.strftime('%d.%m.%Y %H:%M') }}
          </div>
        </div>
        <div class="modal-footer bg-light border-0">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}



<!-- Financial & Usage Section -->
<div class="row g-4 mb-4">
  <!-- Financial Cards -->
  <!-- Financial Cards Removed per request -->

  <!-- Subscription Usage -->
  <div class="col-12">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="card-title text-muted fw-bold mb-0">Paket Kullanımı</h6>
          <span class="badge bg-light text-dark border">{{ current_user.subscription.plan_display_name }}</span>
        </div>

        <!-- Products -->
        <div class="mb-3">
          <div class="d-flex justify-content-between small mb-1">
            <span>Ürün Limiti</span>
            <span class="fw-bold">
              {{ stats.usage.products.used }} /
              {% if stats.usage.products.is_unlimited %}Sınırsız{% else %}{{ stats.usage.products.limit }}{% endif %}
            </span>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: {{ stats.usage.products.percent }}%">
            </div>
          </div>
        </div>

        <!-- XML Sources -->
        <div>
          <div class="d-flex justify-content-between small mb-1">
            <span>XML Kaynakları</span>
            <span class="fw-bold">
              {{ stats.usage.xml_sources.used }} /
              {% if stats.usage.xml_sources.is_unlimited %}Sınırsız{% else %}{{ stats.usage.xml_sources.limit }}{% endif
              %}
            </span>
          </div>
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-info" role="progressbar" style="width: {{ stats.usage.xml_sources.percent }}%">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mb-5">

  {# PAZAR YERLERİ STATİSTİKLERİ #}
  {% for mp in stats.marketplaces %}
  <div class="col-6 col-md-6 col-lg-3">
    {% set mkey = mp.key if mp.key is defined else mp.name|lower %}
    {% set color_class = 'warning' if mkey == 'trendyol' else mp.color %}
    <div class="card p-3 p-md-4 stat-card border-{{ color_class }} card-mobile-stack">
      <div class="d-flex align-items-center">
        <i class="bi bi-{{ mp.icon }} text-{{ color_class }} fs-3 me-3"></i>
        <div class="overflow-hidden">
          <p class="text-muted mb-0 small text-truncate">{{ mp.name }} Ürün Sayısı</p>
          <h4 class="mb-0 fw-bold text-{{ color_class }}" id="mp-count-{{ mkey }}">
            {% if mp.count is not none %}{{ mp.count }}{% else %}0{% endif %}
          </h4>
          <p class="text-muted mt-1 mb-0" style="font-size: 0.75rem;">
            Gönder: {{ mp.sent }} / Hata: {{ mp.failed }}
          </p>
        </div>
      </div>
      <div class="d-flex gap-2 mt-3 w-100">
        <a class="btn btn-xs btn-outline-primary btn-animated flex-grow-1" style="font-size: 0.7rem; padding: 0.25rem;"
          href="{{ url_for('main.marketplace_products_page', marketplace=mkey) }}">Ürünler</a>
        <a class="btn btn-xs btn-outline-secondary btn-animated flex-grow-1"
          style="font-size: 0.7rem; padding: 0.25rem;"
          href="{{ url_for('main.marketplace_products_page', marketplace=mkey) }}">Görüntüle</a>
      </div>
    </div>
  </div>
  {% endfor %}


  <div class="col-6 col-md-6 col-lg-3">
    <div class="card p-4 stat-card border-success">
      <div class="d-flex align-items-center">
        <i class="bi bi-cash-coin text-success fs-3 me-3"></i>
        <div>
          <p class="text-muted mb-0">Aylık Toplam Ciro</p>
          <h4 class="mb-0 fw-bold text-success" id="stat-monthly-revenue">{{ '%.2f' % stats.monthly_revenue }} TL</h4>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <p class="text-muted mb-0" style="font-size:.85rem;">Tüm pazar yerleri (Bu Ay)</p>
            <a href="{{ url_for('report.profit_loss_report') }}"
              class="text-success text-decoration-none small fw-bold">
              Detay <i class="bi bi-arrow-right"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="card p-4 stat-card border-primary">
      <div class="d-flex align-items-center">
        <i class="bi bi-basket text-primary fs-3 me-3"></i>
        <div>
          <p class="text-muted mb-0">Aylık Sipariş Adedi</p>
          <h4 class="mb-0 fw-bold text-primary" id="stat-monthly-orders">{{ stats.monthly_orders }}</h4>
          <p class="text-muted mt-1 mb-0" style="font-size:.85rem;">Toplam (Bu Ay)</p>
        </div>
      </div>
    </div>
  </div>
  <!-- Tahmini Net Kar Removed per request -->
  <div class="col-6 col-lg-3">
    <div class="card p-4 stat-card border-warning">
      <div class="d-flex align-items-center">
        <i class="bi bi-cart-plus text-warning fs-3 me-3"></i>
        <div>
          <p class="text-muted mb-0">Aylık Sepete Alınma</p>
          <h4 class="mb-0 fw-bold text-warning">0</h4>
          <p class="text-muted mt-1 mb-0" style="font-size:.85rem;">Veri Sağlanamıyor</p>
        </div>
      </div>
    </div>
  </div>

  {# YENİ KARTLAR: İade ve İptal #}
  <div class="col-6 col-lg-3 mt-4">
    <div class="card p-4 stat-card border-danger">
      <div class="d-flex align-items-center">
        <i class="bi bi-arrow-return-left text-danger fs-3 me-3"></i>
        <div>
          <p class="text-muted mb-0">Aylık İade Adedi</p>
          <h4 class="mb-0 fw-bold text-danger" id="stat-monthly-returns">{{ stats.returns_count|default(0) }}</h4>
          <p class="text-muted mt-1 mb-0" style="font-size:.85rem;">Toplam (Bu Ay)</p>
        </div>
      </div>
    </div>
  </div>
  <div class="col-6 col-lg-3 mt-4">
    <div class="card p-4 stat-card border-secondary">
      <div class="d-flex align-items-center">
        <i class="bi bi-x-circle text-secondary fs-3 me-3"></i>
        <div>
          <p class="text-muted mb-0">Aylık İptal Adedi</p>
          <h4 class="mb-0 fw-bold text-secondary" id="stat-monthly-cancels">{{ stats.cancel_count|default(0) }}</h4>
          <p class="text-muted mt-1 mb-0" style="font-size:.85rem;">Toplam (Bu Ay)</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Son Siparişler -->
  <div class="col-lg-7">
    <div class="card p-4 h-100">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="card-title mb-0">Son Siparişler</h5>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" onclick="fetchRecentOrders()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <a href="{{ url_for('main.orders_page') }}" class="btn btn-sm btn-outline-primary">Tümü</a>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle table-sm">
          <thead class="table-light">
            <tr>
              <th>Sipariş No</th>
              <th>Pazar Yeri</th>
              <th>Tutar</th>
              <th>Durum</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="recentOrdersTableBody">
            {% for order in stats.recent_orders %}
            <tr>
              <td>
                <span class="fw-bold">{{ order.order_number }}</span>
              </td>
              <td>
                {% if order.marketplace == 'trendyol' %}
                <span class="badge bg-warning text-dark">Trendyol</span>
                {% elif order.marketplace == 'pazarama' %}
                <span class="badge bg-primary">Pazarama</span>
                {% elif order.marketplace == 'hepsiburada' %}
                <span class="badge bg-success">Hepsiburada</span>
                {% else %}
                <span class="badge bg-secondary">{{ order.marketplace|capitalize }}</span>
                {% endif %}
              </td>
              <td>{{ '%.2f' % order.total_price }} TL</td>
              <td>
                {% if order.status in ['Delivered', 'Teslim Edildi'] %}
                <span class="badge bg-success">{{ order.status }}</span>
                {% elif order.status in ['Cancelled', 'İptal Edildi', 'Returned', 'İade Edildi'] %}
                <span class="badge bg-danger">{{ order.status }}</span>
                {% else %}
                <span class="badge bg-warning text-dark">{{ order.status }}</span>
                {% endif %}
              </td>
              <td>
                <a href="{{ url_for('main.order_detail', order_id=order.id) }}"
                  class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-eye"></i>
                </a>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center py-4 text-muted">
                <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                Sipariş yok.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- En Çok Satanlar -->
  <div class="col-lg-5">
    <div class="card p-4 h-100 border-info border-start-4 border-top-0 border-end-0 border-bottom-0">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="card-title mb-0 text-info">
          <i class="bi bi-trophy-fill me-2"></i>En Çok Satanlar
        </h5>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Barkod</th>
              <th>Ürün</th>
              <th class="text-center">Adet</th>
              <th class="text-end">Ciro</th>
            </tr>
          </thead>
          <tbody>
            {% for item in stats.bestsellers %}
            <tr>
              <td class="font-monospace small fw-bold text-secondary">{{ item.barcode }}</td>
              <td>
                <div class="d-flex align-items-center">
                  <div class="rounded bg-light p-1 me-2"
                    style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;">
                    <i class="bi bi-box-seam text-muted"></i>
                  </div>
                  <span class="small fw-semibold text-truncate" style="max-width: 120px;"
                    title="{{ item.product_name }}">
                    {{ item.product_name }}
                  </span>
                </div>
              </td>
              <td class="text-center fw-bold text-dark">{{ item.total_qty }}</td>
              <td class="text-end text-success">{{ '%.2f' % (item.total_rev or 0) }} TL</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4" class="text-center text-muted py-4">Veri yok.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Critical Stock Modal -->
<div class="modal fade" id="criticalStockModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Kritik Stok Uyarısı (Altı: {{
          stats.critical_stock_limit }})</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body p-0">
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th>Barkod</th>
                <th>Ürün Adı</th>
                <th class="text-center">Stok</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for p in stats.critical_stock %}
              <td class="font-monospace small">{{ p.barcode }}</td>
              <td>{{ p.title }}</td>
              <td class="text-center fw-bold text-danger">{{ p.quantity }}</td>
              <td class="text-end">
                <a href="{{ url_for('main.marketplace_products_page', marketplace='trendyol') }}"
                  class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-pencil-square"></i>
                </a>
              </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>



{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    {% if stats and stats.charts %}
    const chartData = {{ stats.charts | tojson | safe
  }};

  // --- Sales Chart (Line) ---
  const ctxSales = document.getElementById('salesChart').getContext('2d');

  // Gradient
  let gradient = ctxSales.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(13, 110, 253, 0.5)'); // Bootstrap Primary
  gradient.addColorStop(1, 'rgba(13, 110, 253, 0.0)');

  new Chart(ctxSales, {
    type: 'line',
    data: {
      labels: chartData.dates,
      datasets: [{
        label: 'Günlük Ciro (TL)',
        data: chartData.sales_revenues,
        borderColor: '#0d6efd',
        backgroundColor: gradient,
        borderWidth: 2,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#0d6efd',
        pointRadius: 4,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function (context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(context.parsed.y);
              }
              return label;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(255, 255, 255, 0.1)' },
          ticks: { color: '#adb5bd' }
        },
        x: {
          grid: { display: false },
          ticks: { color: '#adb5bd' }
        }
      }
    }
  });

  // --- Marketplace Chart (Doughnut) ---
  if (chartData.mp_data && chartData.mp_data.length > 0) {
    const ctxMp = document.getElementById('marketplaceChart').getContext('2d');
    new Chart(ctxMp, {
      type: 'doughnut',
      data: {
        labels: chartData.mp_labels,
        datasets: [{
          data: chartData.mp_data,
          backgroundColor: ['#f0ad4e', '#FF6000', '#0d6efd', '#20c997', '#dc3545', '#6610f2'],
          borderWidth: 0,
          hoverOffset: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#adb5bd', boxWidth: 12 } }
        },
        cutout: '70%'
      }
    });
  } else {
    const container = document.getElementById('marketplaceChart').parentElement;
    container.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-inbox fs-1 d-block mb-2"></i>Veri Yok</div>';
  }
  {% endif %}

  // --- Live Order Polling ---
  window.fetchRecentOrders = function () {
    const btn = document.querySelector('button[onclick="fetchRecentOrders()"]');
    const originalIcon = btn ? btn.innerHTML : '';

    if (btn) {
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Yükleniyor...';
      btn.disabled = true;
    }

    fetch('/api/orders/recent')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const tbody = document.getElementById('recentOrdersTableBody');
          if (data.orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted"><i class="bi bi-inbox fs-4 d-block mb-2"></i>Henüz sipariş bulunmuyor.</td></tr>';
            return;
          }

          let html = '';
          data.orders.forEach(order => {
            html += `
              <tr>
                <td>
                  <span class="fw-bold">${order.order_number}</span>
                  <div class="small text-muted" style="font-size: 0.75rem;">${order.marketplace}</div>
                </td>
                <td>
                  <span class="badge bg-${order.color}">${order.marketplace.charAt(0).toUpperCase() + order.marketplace.slice(1)}</span>
                </td>
                <td>
                  ${order.customer}
                </td>
                <td>${order.amount}</td>
                <td>
                  <span class="badge bg-secondary">${order.status}</span>
                </td>
                <td>${new Date(order.time).toLocaleString('tr-TR')}</td>
                <td>
                  <a href="/orders/detail/${order.id}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              `;
          });
          tbody.innerHTML = html;
        }
      })
      .catch(err => console.error('Polling error:', err))
      .finally(() => {
        if (btn) {
          btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Yenile';
          btn.disabled = false;
        }
      });
  }

  // Poll every 30 seconds
  setInterval(fetchRecentOrders, 30000);

  // --- Live Stats Polling ---
  window.fetchDashboardStats = function () {
    fetch('/api/dashboard/stats')
      .then(r => r.json())
      .then(data => {
        if (data) {
          const revEl = document.getElementById('stat-monthly-revenue');
          if (revEl) revEl.innerText = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(data.monthly_revenue);

          const ordEl = document.getElementById('stat-monthly-orders');
          if (ordEl) ordEl.innerText = data.monthly_orders;

          const retEl = document.getElementById('stat-monthly-returns');
          if (retEl) retEl.innerText = data.monthly_returns !== undefined ? data.monthly_returns : '-';

          const canEl = document.getElementById('stat-monthly-cancels');
          if (canEl) canEl.innerText = data.monthly_cancels !== undefined ? data.monthly_cancels : '-';

          // Update Marketplace Counts
          if (data.mp_counts) {
            for (const [key, count] of Object.entries(data.mp_counts)) {
              const el = document.getElementById(`mp-count-${key}`);
              if (el) el.innerText = count;
            }
          }

          // Update Last Sync Time
          if (data.last_sync) {
            const syncEl = document.getElementById('last-sync-time');
            if (syncEl) syncEl.innerText = `Son Güncelleme: ${data.last_sync}`;
          }
        }
      })
      .catch(e => console.error("Stats poll error:", e));
  }
  // Poll stats every 60 seconds
  setInterval(fetchDashboardStats, 60000);


  // --- Announcement Dismiss ---
  window.dismissAnnouncement = function (id) {
    if (!confirm('Bu bildirimi kaldırmak istediğinize emin misiniz?')) return;

    fetch(`/api/announcement/${id}/dismiss`, { method: 'POST' })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          location.reload();
        } else {
          alert('Hata: ' + d.message);
        }
      })
      .catch(e => console.error(e));
  };

  // --- Notification Dismiss ---
  window.dismissNotification = function (id) {
    fetch(`/api/notification/${id}/read`, { method: 'POST' })
      .then(r => r.json())
      .then(d => {
        if (d.success) {
          location.reload();
        }
      })
      .catch(e => console.error(e));
  };

  });
</script>
{% endblock %}