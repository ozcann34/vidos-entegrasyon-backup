{% extends "_base.html" %}
{% block title %}Otomatik Senkronizasyon Ayarları{% endblock %}

{% block content %}
<div class="row g-4">
    {% for key, name in marketplaces.items() %}
    <div class="col-md-6 col-xl-4">
        <div class="card h-100 border-0 marketplace-card" data-marketplace="{{ key }}">
            <div class="card-header d-flex justify-content-between align-items-center py-3">
                <h6 class="card-title mb-0">
                    <i class="bi bi-shop me-2"></i> {{ name }}
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="form-check form-switch custom-switch-lg">
                        <input class="form-check-input sync-enable" type="checkbox" id="enable_{{ key }}"
                            data-marketplace="{{ key }}">
                        <label class="form-check-label fw-bold ms-2" for="enable_{{ key }}">
                            Otomatik Senkronizasyon
                        </label>
                    </div>
                    <div class="text-end">
                        <div class="text-end">
                            <div class="text-end">
                                <select
                                    class="form-select form-select-sm border-0 bg-light text-secondary fw-bold interval-select"
                                    data-marketplace="{{ key }}"
                                    style="width: 100%; display: inline-block; {{ 'cursor: pointer;' if current_user.has_permission('adjust_sync_interval') else 'cursor: not-allowed;' }}"
                                    {{ ' ' if current_user.has_permission('adjust_sync_interval') else 'disabled' }}>
                                    <option value="15">Her 15 Dakikada Bir</option>
                                    <option value="30">Her 30 Dakikada Bir</option>
                                    <option value="60" selected>Her 1 Saatte Bir</option>
                                    <option value="180">Her 3 Saatte Bir</option>
                                    <option value="360">Her 6 Saatte Bir</option>
                                    <option value="720">Her 12 Saatte Bir</option>
                                    <option value="1440">Günde Bir Kez</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label text-muted small text-uppercase fw-bold">XML Kaynağı</label>
                    <select class="form-select xml-source-select" data-marketplace="{{ key }}">
                        <option value="">Seçiniz...</option>
                        {% for src in xml_sources %}
                        <option value="{{ src.id }}">{{ src.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text small mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        Eşleşme Otomatik Olarak Yapılır: <strong>Stok Kodu > Barkod</strong>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="form-check mb-2">
                        <input class="form-check-input random-barcode-check" type="checkbox"
                            id="random_barcode_{{ key }}" data-marketplace="{{ key }}">
                        <label class="form-check-label small text-muted" for="random_barcode_{{ key }}">
                            Barkodu olmayan ürünler için <strong>13 haneli Rastgele Barkod</strong> oluştur
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input override-barcode-check" type="checkbox"
                            id="override_barcode_{{ key }}" data-marketplace="{{ key }}">
                        <label class="form-check-label small text-muted" for="override_barcode_{{ key }}">
                            Tüm ürünler için <strong>13 haneli Rastgele Barkod</strong> oluştur
                        </label>
                    </div>
                </div>

                <div class="alert alert-light border-0 small text-muted mb-3">
                    <i class="bi bi-shield-check me-2 text-success"></i>
                    <a href="{{ url_for('sync_exceptions.index') }}" class="text-decoration-none fw-bold">İstisna
                        Listesi</a>'ndeki ürünlere dokunulmaz.
                </div>


                <div class="d-grid">
                    <button class="btn btn-outline-primary manual-sync-btn" data-marketplace="{{ key }}">
                        <i class="bi bi-arrow-repeat me-1"></i> Test: Şimdi Senkronize Et
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row pt-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header border-bottom-0 py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold text-dark">
                    <i class="bi bi-list-ul me-2 text-primary"></i> Senkronizasyon Logları
                </h5>
                <div style="width: 200px;">
                    <select class="form-select form-select-sm" id="logMarketplaceFilter">
                        <option value="">Tüm Pazaryerleri</option>
                        {% for key, name in marketplaces.items() %}
                        <option value="{{ key }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="syncLogsTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Pazaryeri</th>
                                <th>Zaman</th>
                                <th class="text-center">Güncellenen Ürün</th>
                                <th class="text-center">Stok Değişikliği</th>
                                <th class="text-center">Fiyat Değişikliği</th>
                                <th>Durum</th>
                                <th class="text-end pe-4">Detay</th>
                            </tr>
                        </thead>
                        <tbody id="syncLogsTableBody" class="border-top-0">
                            <tr>
                                <td colspan="7" class="text-center py-5 text-muted">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    Loglar yükleniyor...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white py-3 border-top-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="small text-muted">
                        Her 30 saniyede bir otomatik güncellenir.
                    </div>
                    <div id="syncLogsPagination">
                        <!-- Pagination will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
    (function () {
        const marketplaces = {{ marketplaces | tojson | safe
    }};
    let syncSettings = {};
    let activeJobs = {};


    // --- Order Sync Functions ---
    async function loadOrderSettings() {
        try {
            const response = await fetch('/api/auto_sync/orders/settings');
            const data = await response.json();
            if (data.success) {
                const settings = data.settings;
                const toggle = document.getElementById('order-sync-toggle');
                const interval = document.getElementById('order-sync-interval');
                if (toggle) toggle.checked = settings.enabled;
                if (interval) interval.value = settings.interval;
            }
        } catch (error) {
            console.error("Order settings load error:", error);
        }
    }

    async function saveOrderSettings() {
        const toggle = document.getElementById('order-sync-toggle');
        const interval = document.getElementById('order-sync-interval');
        if (!toggle || !interval) return;

        const enabled = toggle.checked;
        const intervalVal = interval.value;

        try {
            const response = await fetch('/api/auto_sync/orders/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled, interval: intervalVal })
            });
            const data = await response.json();

            if (data.success) {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                Toast.fire({
                    icon: 'success',
                    title: enabled ? 'Otomatik sipariş çekme aktif edildi' : 'Otomatik sipariş çekme durduruldu'
                });
            } else {
                Swal.fire('Hata', data.message || 'Ayarlar kaydedilemedi', 'error');
                toggle.checked = !enabled;
            }
        } catch (error) {
            console.error("Save error:", error);
            Swal.fire('Hata', 'Sunucu hatası', 'error');
        }
    }

    // --- Product Sync Functions ---
    async function loadSettings() {
        try {
            const resp = await fetch('/api/auto_sync/settings');
            const data = await resp.json();

            if (data.success && data.settings) {
                data.settings.forEach(setting => {
                    syncSettings[setting.marketplace] = setting;
                    const card = document.querySelector(`.marketplace-card[data-marketplace="${setting.marketplace}"]`);
                    if (!card) return;

                    const toggleEl = card.querySelector('.sync-enable');
                    const xmlSelect = card.querySelector('.xml-source-select');
                    const intervalSelect = card.querySelector('.interval-select');
                    const rndBarcodeCheck = card.querySelector('.random-barcode-check');
                    const overrideBarcodeCheck = card.querySelector('.override-barcode-check');

                    if (toggleEl) toggleEl.checked = setting.enabled;
                    if (xmlSelect) xmlSelect.value = setting.xml_source_id || '';
                    if (intervalSelect) intervalSelect.value = setting.sync_interval_minutes || 15;

                    if (rndBarcodeCheck) {
                        rndBarcodeCheck.checked = setting.use_random_barcode === 'true' || setting.use_random_barcode === true;
                    }
                    if (overrideBarcodeCheck) {
                        overrideBarcodeCheck.checked = setting.use_override_barcode === 'true' || setting.use_override_barcode === true;
                    }
                });
            }
        } catch (err) {
            console.error('Error loading settings:', err);
        }
    }

    async function toggleSync(marketplace, enabled) {
        const card = document.querySelector(`.marketplace-card[data-marketplace="${marketplace}"]`);
        const xmlSelect = card ? card.querySelector('.xml-source-select') : null;
        const xmlSourceId = xmlSelect ? xmlSelect.value : null;

        if (enabled && !xmlSourceId) {
            Swal.fire('Uyarı', 'Lütfen senkronizasyon için bir XML kaynağı seçiniz.', 'warning');
            const toggleEl = document.getElementById(`enable_${marketplace}`);
            if (toggleEl) toggleEl.checked = false;
            return;
        }

        try {
            const intervalSelect = card ? card.querySelector('.interval-select') : null;
            const rndBarcodeCheck = card ? card.querySelector('.random-barcode-check') : null;
            const overrideBarcodeCheck = card ? card.querySelector('.override-barcode-check') : null;

            const intervalVal = intervalSelect ? parseInt(intervalSelect.value) : 15;
            const useRandomBarcode = rndBarcodeCheck ? rndBarcodeCheck.checked : false;
            const useOverrideBarcode = overrideBarcodeCheck ? overrideBarcodeCheck.checked : false;

            const resp = await fetch('/api/auto_sync/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    marketplace,
                    enabled,
                    interval_minutes: intervalVal,
                    xml_source_id: xmlSourceId,
                    match_by: 'auto',
                    use_random_barcode: useRandomBarcode,
                    use_override_barcode: useOverrideBarcode
                })
            });
            const data = await resp.json();

            if (data.success) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: data.message,
                    showConfirmButton: false,
                    timer: 3000
                });
                loadSettings();
            } else {
                throw new Error(data.message || 'İşlem başarısız');
            }
        } catch (err) {
            console.error('Toggle error:', err);
            Swal.fire('Hata', err.message, 'error');
            const toggleEl = document.getElementById(`enable_${marketplace}`);
            if (toggleEl) toggleEl.checked = !enabled;
        }
    }


    async function triggerManualSync(marketplace) {
        const card = document.querySelector(`.marketplace-card[data-marketplace="${marketplace}"]`);
        const xmlSelect = card ? card.querySelector('.xml-source-select') : null;
        const xmlSourceId = xmlSelect ? xmlSelect.value : null;

        if (!xmlSourceId) {
            Swal.fire('Uyarı', 'Lütfen önce bir XML kaynağı seçiniz.', 'warning');
            return;
        }

        try {
            const resp = await fetch(`/api/auto_sync/trigger/${marketplace}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ xml_source_id: xmlSourceId })
            });
            const data = await resp.json();

            if (data.success && data.job_id) {
                if (typeof window.showJobWidget === 'function') {
                    window.showJobWidget(data.job_id);
                }
                setTimeout(loadLogs, 5000);
            } else {
                throw new Error(data.message || 'İşlem başarısız');
            }
        } catch (err) {
            console.error('Manual sync error:', err);
            Swal.fire('Hata', err.message, 'error');
        }
    }


    let currentLogPage = 1;
    let totalLogPages = 1;

    async function loadLogs(marketplace = null, page = 1) {
        currentLogPage = page;
        try {
            const url = marketplace
                ? `/api/auto_sync/logs?marketplace=${marketplace}&page=${page}&per_page=20`
                : `/api/auto_sync/logs?page=${page}&per_page=20`;
            const resp = await fetch(url);
            const data = await resp.json();
            const tbody = document.getElementById('syncLogsTableBody');

            if (!data.success || !data.logs || data.logs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-inbox"></i> Henüz log kaydı yok</td></tr>`;
                renderPagination(0, 0);
                return;
            }

            totalLogPages = data.pages;

            tbody.innerHTML = data.logs.map(log => {
                const date = new Date(log.timestamp);
                const statusBadge = log.success ? '<span class="badge bg-success-subtle text-success border border-success-subtle px-3 rounded-pill">Başarılı</span>' : '<span class="badge bg-danger-subtle text-danger border border-danger-subtle px-3 rounded-pill">Hatalı</span>';

                let details = log.details_json;
                if (typeof details === 'string') {
                    try { details = JSON.parse(details); } catch (e) { }
                }

                const hasDetails = details && details.details && details.details.length > 0;
                const detailBtn = hasDetails
                    ? `<button class="btn btn-sm btn-outline-info rounded-pill px-3" onclick='showLogDetails(${JSON.stringify(details.details).replace(/'/g, "&#39;")})'><i class="bi bi-eye me-1"></i> Detay</button>`
                    : '<span class="text-muted small">Detay Yok</span>';

                return `<tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-primary-subtle text-primary border border-primary-subtle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                    <i class="bi bi-shop"></i>
                                </span>
                                <span class="fw-bold">${marketplaces[log.marketplace] || log.marketplace}</span>
                            </div>
                        </td>
                        <td><div class="small text-muted mb-1"><i class="bi bi-calendar3 me-1"></i>${date.toLocaleDateString('tr-TR')}</div><div class="small fw-bold"><i class="bi bi-clock me-1"></i>${date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}</div></td>
                        <td class="text-center"><span class="badge bg-light text-dark border rounded-pill px-3">${log.products_updated}</span></td>
                        <td class="text-center"><span class="text-primary fw-bold">${log.stock_changes}</span></td>
                        <td class="text-center"><span class="text-success fw-bold">${log.price_changes}</span></td>
                        <td>${statusBadge}</td>
                        <td class="text-end pe-3">${detailBtn}</td>
                    </tr>`;
            }).join('');

            renderPagination(data.current_page, data.pages);

        } catch (err) {
            console.error('Error loading logs:', err);
        }
    }

    function renderPagination(current, total) {
        const container = document.getElementById('syncLogsPagination');
        if (!container) return;

        if (total <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = `<ul class="pagination pagination-sm mb-0 justify-content-end">`;

        // Prev
        html += `<li class="page-item ${current === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadLogs(document.getElementById('logMarketplaceFilter').value, ${current - 1}); return false;"><i class="bi bi-chevron-left"></i></a>
                 </li>`;

        // Pages
        for (let i = 1; i <= total; i++) {
            if (i === 1 || i === total || (i >= current - 2 && i <= current + 2)) {
                html += `<li class="page-item ${i === current ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadLogs(document.getElementById('logMarketplaceFilter').value, ${i}); return false;">${i}</a>
                         </li>`;
            } else if (i === current - 3 || i === current + 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        // Next
        html += `<li class="page-item ${current === total ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadLogs(document.getElementById('logMarketplaceFilter').value, ${current + 1}); return false;"><i class="bi bi-chevron-right"></i></a>
                 </li>`;

        html += `</ul>`;
        container.innerHTML = html;
    }

    window.loadLogs = loadLogs;

    window.showLogDetails = function (details) {
        const tbody = document.getElementById('logDetailsTableBody');
        if (!tbody) return;
        if (!details || details.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Detay bulunamadı</td></tr>';
        } else {
            tbody.innerHTML = details.map(d => {
                const stockClass = d.stock_changed ? 'text-danger fw-bold' : '';
                const priceClass = d.price_changed ? 'text-danger fw-bold' : '';
                return `<tr>
                        <td>${d.barcode}</td>
                        <td>${d.old_stock} <i class="bi bi-arrow-right small text-muted"></i> <span class="${stockClass}">${d.new_stock}</span></td>
                        <td>${d.old_price} <i class="bi bi-arrow-right small text-muted"></i> <span class="${priceClass}">${d.new_price}</span></td>
                        <td>${d.stock_changed ? '<span class="badge bg-warning text-dark">Stok</span>' : ''}</td>
                        <td>${d.price_changed ? '<span class="badge bg-info text-dark">Fiyat</span>' : ''}</td>
                    </tr>`;
            }).join('');
        }
        const modal = document.getElementById('logDetailsModal');
        if (modal) new bootstrap.Modal(modal).show();
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Sync toggles
        document.querySelectorAll('.sync-enable').forEach(toggle => {
            toggle.addEventListener('change', (e) => toggleSync(e.target.dataset.marketplace, e.target.checked));
        });

        // Interval changes
        document.querySelectorAll('.interval-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const mp = e.target.dataset.marketplace;
                const toggleEl = document.getElementById(`enable_${mp}`);
                if (toggleEl && toggleEl.checked) {
                    toggleSync(mp, true);
                }
            });
        });

        // XML source changes
        document.querySelectorAll('.xml-source-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const mp = e.target.dataset.marketplace;
                const toggleEl = document.getElementById(`enable_${mp}`);
                if (toggleEl && toggleEl.checked) {
                    toggleSync(mp, true);
                }
            });
        });

        // Manual sync buttons
        document.querySelectorAll('.manual-sync-btn').forEach(btn => {
            btn.addEventListener('click', (e) => triggerManualSync(e.target.closest('button').dataset.marketplace));
        });

        const logFilter = document.getElementById('logMarketplaceFilter');
        if (logFilter) {
            logFilter.addEventListener('change', (e) => loadLogs(e.target.value || null));
        }

        // Order sync toggles
        const orderToggle = document.getElementById('order-sync-toggle');
        if (orderToggle) orderToggle.addEventListener('change', saveOrderSettings);

        const orderInterval = document.getElementById('order-sync-interval');
        if (orderInterval) orderInterval.addEventListener('change', saveOrderSettings);

        // Initialize
        loadOrderSettings();
        loadSettings();
        loadLogs();

        // Auto refresh logs
        setInterval(() => {
            const filter = document.getElementById('logMarketplaceFilter');
            loadLogs(filter ? filter.value : null);
        }, 30000);
    });
}) ();
</script>

<style>
    .sync-toggle:checked+label {
        background-color: var(--primary);
    }

    .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
</style>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Senkronizasyon Detayları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Barkod</th>
                                <th>Stok (Eski -> Yeni)</th>
                                <th>Fiyat (Eski -> Yeni)</th>
                                <th>Stok Değ.</th>
                                <th>Fiyat Değ.</th>
                            </tr>
                        </thead>
                        <tbody id="logDetailsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}