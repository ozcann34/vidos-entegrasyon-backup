{% extends "_base.html" %}
{% block title %}Otomatik Senkronizasyon Ayarları{% endblock %}

{% block content %}
<div class="row g-4">
    {% for key, name in marketplaces.items() %}
    <div class="col-md-6 col-xl-4">
        <div class="card h-100 border-0 marketplace-card" data-marketplace="{{ key }}">
            <div class="card-header d-flex justify-content-between align-items-center py-3">
                <h6 class="card-title mb-0">
                    <i class="bi bi-shop me-2"></i> {{ name }}
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="form-check form-switch custom-switch-lg">
                        <input class="form-check-input sync-enable" type="checkbox" id="enable_{{ key }}"
                            data-marketplace="{{ key }}">
                        <label class="form-check-label fw-bold ms-2" for="enable_{{ key }}">
                            Otomatik Senkronizasyon
                        </label>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-light text-secondary border rounded-pill px-3 py-2">
                            <i class="bi bi-clock-history me-1"></i> Her 3 Saatte Bir
                        </span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label text-muted small text-uppercase fw-bold">XML Kaynağı</label>
                    <select class="form-select xml-source-select" data-marketplace="{{ key }}">
                        <option value="">Seçiniz...</option>
                        {% for src in xml_sources %}
                        <option value="{{ src.id }}">{{ src.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text small mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        Eşleşme Otomatik Olarak Yapılır: <strong>Stok Kodu > Barkod</strong>
                    </div>
                </div>

                <div class="alert alert-light border-0 small text-muted mb-3">
                    <i class="bi bi-shield-check me-2 text-success"></i>
                    <a href="{{ url_for('sync_exceptions.index') }}" class="text-decoration-none fw-bold">İstisna
                        Listesi</a>'ndeki ürünlere dokunulmaz.
                </div>

                <div class="d-grid">
                    <button class="btn btn-outline-primary manual-sync-btn" data-marketplace="{{ key }}">
                        <i class="bi bi-arrow-repeat me-1"></i> Test: Şimdi Senkronize Et
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
</div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-list-ul me-2"></i> Senkronizasyon Logları
        </h5>
        <div>
            <select class="form-select form-select-sm" id="logMarketplaceFilter">
                <option value="">Tüm Pazaryerleri</option>
                {% for key, name in marketplaces.items() %}
                <option value="{{ key }}">{{ name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="syncLogsTable">
                <thead>
                    <tr>
                        <th>Pazaryeri</th>
                        <th>Zaman</th>
                        <th>Güncellenen Ürün</th>
                        <th>Stok Değişikliği</th>
                        <th>Fiyat Değişikliği</th>
                        <th>Durum</th>
                        <th>Detay</th>
                    </tr>
                </thead>
                <tbody id="syncLogsTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i> Loglar yükleniyor...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    (function () {
        const marketplaces = {{ marketplaces | tojson | safe
    }};
    let syncSettings = {};
    let activeJobs = {}; // Track active job IDs per marketplace

    // --- Order Sync Functions ---
    async function loadOrderSettings() {
        try {
            const response = await fetch('/api/auto_sync/orders/settings');
            const data = await response.json();
            if (data.success) {
                const settings = data.settings;
                document.getElementById('order-sync-toggle').checked = settings.enabled;
                document.getElementById('order-sync-interval').value = settings.interval;
            }
        } catch (error) {
            console.error("Order settings load error:", error);
        }
    }

    async function saveOrderSettings() {
        const enabled = document.getElementById('order-sync-toggle').checked;
        const interval = document.getElementById('order-sync-interval').value;

        try {
            const response = await fetch('/api/auto_sync/orders/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled, interval })
            });
            const data = await response.json();

            if (data.success) {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                });
                Toast.fire({
                    icon: 'success',
                    title: enabled ? 'Otomatik sipariş çekme aktif edildi' : 'Otomatik sipariş çekme durduruldu'
                });
            } else {
                Swal.fire('Hata', data.message || 'Ayarlar kaydedilemedi', 'error');
                document.getElementById('order-sync-toggle').checked = !enabled;
            }
        } catch (error) {
            console.error("Save error:", error);
            Swal.fire('Hata', 'Sunucu hatası', 'error');
        }
    }

    // --- Product Sync Functions ---
    async function loadSettings() {
        try {
            const resp = await fetch('/api/auto_sync/settings');
            const data = await resp.json();

            if (data.success && data.settings) {
                data.settings.forEach(setting => {
                    syncSettings[setting.marketplace] = setting;
                    const card = document.querySelector(`.marketplace-card[data-marketplace="${setting.marketplace}"]`);
                    if (!card) return;

                    const toggleEl = card.querySelector('.sync-enable');
                    const xmlSelect = card.querySelector('.xml-source-select');

                    if (toggleEl) toggleEl.checked = setting.enabled;
                    if (xmlSelect) xmlSelect.value = setting.xml_source_id || '';
                });
            }
        } catch (err) {
            console.error('Error loading settings:', err);
        }
    }

    async function toggleSync(marketplace, enabled) {
        const card = document.querySelector(`.marketplace-card[data-marketplace="${marketplace}"]`);
        const xmlSelect = card ? card.querySelector('.xml-source-select') : null;
        const xmlSourceId = xmlSelect ? xmlSelect.value : null;

        if (enabled && !xmlSourceId) {
            Swal.fire('Uyarı', 'Lütfen senkronizasyon için bir XML kaynağı seçiniz.', 'warning');
            const toggleEl = document.getElementById(`enable_${marketplace}`);
            if (toggleEl) toggleEl.checked = false;
            return;
        }

        try {
            const resp = await fetch('/api/auto_sync/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    marketplace,
                    enabled,
                    interval_minutes: 180, // Fixed 3 hours
                    xml_source_id: xmlSourceId,
                    match_by: 'auto'
                })
            });
            const data = await resp.json();

            if (data.success) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: data.message,
                    showConfirmButton: false,
                    timer: 3000
                });
                loadSettings();
            } else {
                throw new Error(data.message || 'İşlem başarısız');
            }
        } catch (err) {
            console.error('Toggle error:', err);
            Swal.fire('Hata', err.message, 'error');
            const toggleEl = document.getElementById(`enable_${marketplace}`);
            if (toggleEl) toggleEl.checked = !enabled;
        }
    }

    async function triggerManualSync(marketplace) {
        const card = document.querySelector(`.marketplace-card[data-marketplace="${marketplace}"]`);
        const xmlSelect = card ? card.querySelector('.xml-source-select') : null;
        const xmlSourceId = xmlSelect ? xmlSelect.value : null;

        if (!xmlSourceId) {
            Swal.fire('Uyarı', 'Lütfen önce bir XML kaynağı seçiniz.', 'warning');
            return;
        }

        try {
            const resp = await fetch(`/api/auto_sync/trigger/${marketplace}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ xml_source_id: xmlSourceId })
            });
            const data = await resp.json();

            if (data.success) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Senkronizasyon başlatıldı',
                    showConfirmButton: false,
                    timer: 2000
                });
                // Refresh logs after a short delay
                setTimeout(loadLogs, 3000);
            } else {
                throw new Error(data.message || 'İşlem başarısız');
            }
        } catch (err) {
            console.error('Manual sync error:', err);
            Swal.fire('Hata', err.message, 'error');
        }
    }

    async function loadLogs(marketplace = null) {
        try {
            const url = marketplace ? `/api/auto_sync/logs?marketplace=${marketplace}&limit=50` : '/api/auto_sync/logs?limit=50';
            const resp = await fetch(url);
            const data = await resp.json();
            const tbody = document.getElementById('syncLogsTableBody');

            if (!data.success || !data.logs || data.logs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted"><i class="bi bi-inbox"></i> Henüz log kaydı yok</td></tr>`;
                return;
            }

            tbody.innerHTML = data.logs.map(log => {
                const date = new Date(log.timestamp);
                const statusBadge = log.success ? '<span class="badge bg-success">Başarılı</span>' : '<span class="badge bg-danger">Hatalı</span>';

                let details = log.details_json;
                if (typeof details === 'string') {
                    try { details = JSON.parse(details); } catch (e) { }
                }

                const hasDetails = details && details.details && details.details.length > 0;
                const detailBtn = hasDetails
                    ? `<button class="btn btn-sm btn-outline-info" onclick='showLogDetails(${JSON.stringify(details.details).replace(/'/g, "&#39;")})'><i class="bi bi-eye"></i> Detay</button>`
                    : '<span class="text-muted">-</span>';

                return `<tr>
                        <td><strong>${marketplaces[log.marketplace] || log.marketplace}</strong></td>
                        <td><small>${date.toLocaleString('tr-TR')}</small></td>
                        <td class="text-center">${log.products_updated}</td>
                        <td class="text-center">${log.stock_changes}</td>
                        <td class="text-center">${log.price_changes}</td>
                        <td>${statusBadge}</td>
                        <td class="text-center">${detailBtn}</td>
                    </tr>`;
            }).join('');
        } catch (err) {
            console.error('Error loading logs:', err);
        }
    }

    window.showLogDetails = function (details) {
        const tbody = document.getElementById('logDetailsTableBody');
        if (!details || details.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Detay bulunamadı</td></tr>';
        } else {
            tbody.innerHTML = details.map(d => {
                const stockClass = d.stock_changed ? 'text-danger fw-bold' : '';
                const priceClass = d.price_changed ? 'text-danger fw-bold' : '';
                return `<tr>
                        <td>${d.barcode}</td>
                        <td>${d.old_stock} <i class="bi bi-arrow-right small text-muted"></i> <span class="${stockClass}">${d.new_stock}</span></td>
                        <td>${d.old_price} <i class="bi bi-arrow-right small text-muted"></i> <span class="${priceClass}">${d.new_price}</span></td>
                        <td>${d.stock_changed ? '<span class="badge bg-warning text-dark">Stok</span>' : ''}</td>
                        <td>${d.price_changed ? '<span class="badge bg-info text-dark">Fiyat</span>' : ''}</td>
                    </tr>`;
            }).join('');
        }
        new bootstrap.Modal(document.getElementById('logDetailsModal')).show();
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Sync toggles
        document.querySelectorAll('.sync-enable').forEach(toggle => {
            toggle.addEventListener('change', (e) => toggleSync(e.target.dataset.marketplace, e.target.checked));
        });

        // XML source changes
        document.querySelectorAll('.xml-source-select').forEach(select => {
            select.addEventListener('change', (e) => {
                const mp = e.target.dataset.marketplace;
                const toggleEl = document.getElementById(`enable_${mp}`);
                if (toggleEl && toggleEl.checked) {
                    toggleSync(mp, true);
                }
            });
        });

        // Manual sync buttons
        document.querySelectorAll('.manual-sync-btn').forEach(btn => {
            btn.addEventListener('click', (e) => triggerManualSync(e.target.closest('button').dataset.marketplace));
        });

        const logFilter = document.getElementById('logMarketplaceFilter');
        if (logFilter) {
            logFilter.addEventListener('change', (e) => loadLogs(e.target.value || null));
        }

        // Order sync toggles
        const orderToggle = document.getElementById('order-sync-toggle');
        if (orderToggle) orderToggle.addEventListener('change', saveOrderSettings);

        const orderInterval = document.getElementById('order-sync-interval');
        if (orderInterval) orderInterval.addEventListener('change', saveOrderSettings);

        // Initialize
        loadOrderSettings();
        loadSettings();
        loadLogs();

        // Auto refresh logs
        setInterval(() => {
            const filter = document.getElementById('logMarketplaceFilter');
            loadLogs(filter ? filter.value : null);
        }, 30000);
    });
    }) ();
</script>

<style>
    .sync-toggle:checked+label {
        background-color: var(--primary);
    }

    .form-check-input:checked {
        background-color: var(--primary);
        border-color: var(--primary);
    }
</style>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Senkronizasyon Detayları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Barkod</th>
                                <th>Stok (Eski -> Yeni)</th>
                                <th>Fiyat (Eski -> Yeni)</th>
                                <th>Stok Değ.</th>
                                <th>Fiyat Değ.</th>
                            </tr>
                        </thead>
                        <tbody id="logDetailsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}