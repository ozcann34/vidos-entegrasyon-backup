{% extends "_base.html" %}
{% block title %}Excel √úr√ºnleri{% endblock %}
{% block page_title %}üìä Excel √úr√ºnleri{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
        <h4 class="mb-0">Excel ve √úr√ºn Y√∂netimi</h4>
        <div>
            <a href="{{ url_for('products.create_product') }}" class="btn btn-success shadow-sm">
                <i class="bi bi-plus-lg me-1"></i>Manuel √úr√ºn Ekle
            </a>
        </div>
    </div>

    <!-- Saved Files Section -->
    <div class="card mb-4 border-0 shadow-sm" style="background: var(--card);">
        <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-folder2-open me-2"></i>Kayƒ±tlƒ± Excel Dosyalarƒ±</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshFileList()">
                <i class="bi bi-arrow-clockwise me-1"></i>Yenile
            </button>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <select id="savedFileSelect" class="form-select">
                        <option value="">-- Dosya Se√ßin --</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex gap-2 mt-2 mt-md-0">
                    <button class="btn btn-primary flex-grow-1" onclick="loadSelectedFile()">
                        <i class="bi bi-folder2-open me-1"></i>Y√ºkle
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteSelectedFile()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="card mb-4 border-0 shadow-sm" style="background: var(--card);">
        <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>Excel Dosyasƒ± Y√ºkle</h5>
            <a href="{{ url_for('products.download_template') }}" class="btn btn-sm btn-outline-success">
                <i class="bi bi-file-earmark-excel me-1"></i>√ñrnek ≈ûablon ƒ∞ndir
            </a>
        </div>
        <div class="card-body">
            <div id="dropZone" class="border border-2 border-dashed rounded-3 p-5 text-center"
                style="border-color: var(--border) !important; cursor: pointer; transition: all 0.3s;">
                <i class="bi bi-file-earmark-excel display-4 text-success mb-3"></i>
                <p class="mb-2">Dosyayƒ± s√ºr√ºkleyip bƒ±rakƒ±n veya tƒ±klayarak se√ßin</p>
                <small class="text-muted">.xlsx, .xls, .csv desteklenir</small>
                <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" class="d-none">
            </div>
            <div id="uploadProgress" class="mt-3 d-none">
                <div class="progress" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%">
                    </div>
                </div>
                <small class="text-muted mt-1 d-block">Y√ºkleniyor...</small>
            </div>
        </div>
    </div>

    <!-- File Info Section -->
    <div id="fileInfoSection" class="card mb-4 border-0 shadow-sm d-none" style="background: var(--card);">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-1"><i class="bi bi-file-earmark-check text-success me-2"></i><span
                            id="fileName">dosya.xlsx</span></h6>
                    <small class="text-muted"><span id="productCount">0</span> √ºr√ºn y√ºklendi</small>
                </div>
                <div class="col-md-6 text-md-end">
                    <span class="badge bg-success me-2"><span id="matchedCols">0</span>/<span id="totalCols">0</span>
                        kolon e≈üle≈üti</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="showColumnMapping()">
                        <i class="bi bi-list-check me-1"></i>Kolon E≈üle≈ümesi
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div id="actionSection" class="card mb-4 border-0 shadow-sm d-none" style="background: var(--card);">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-3"><i class="bi bi-send me-2"></i>Pazaryerine G√∂nder</h6>
                    <div class="btn-group flex-wrap gap-2">
                        <button class="btn btn-outline-warning btn-sm" onclick="sendToMarketplace('trendyol')">
                            <i class="bi bi-shop me-1"></i>Trendyol'a G√∂nder
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="sendToMarketplace('pazarama')">
                            <i class="bi bi-shop me-1"></i>Pazarama'ya G√∂nder
                        </button>
                        <!-- N11 Button Added -->
                        <button class="btn btn-outline-danger btn-sm" onclick="sendToMarketplace('n11')">
                            <i class="bi bi-shop me-1"></i>N11'e G√∂nder
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="sendToMarketplace('idefix')">
                            <i class="bi bi-shop me-1"></i>ƒ∞defix'e G√∂nder
                        </button>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-primary" onclick="sendAllToTrendyol()">
                            <i class="bi bi-send-fill me-1"></i>Hepsini Trendyol'a G√∂nder
                        </button>
                    </div>
                    <div class="mt-3 d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-secondary" disabled
                            title="Otomatik e≈üle≈ütirme g√∂nderim sƒ±rasƒ±nda yapƒ±lƒ±r">
                            <i class="bi bi-tags me-1"></i>Markalarƒ± E≈üle≈ütir
                        </button>
                        <button class="btn btn-outline-info" onclick="showCategoryMatchingModal()">
                            <i class="bi bi-folder me-1"></i>Kategorileri E≈üle≈ütir
                        </button>
                    </div>
                </div>
                <div class="col-md-6 mt-3 mt-md-0">
                    <h6 class="mb-3"><i class="bi bi-gear me-2"></i>G√∂nderim Se√ßenekleri</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-check">
                                <input type="checkbox" id="optZeroStock" class="form-check-input">
                                <label class="form-check-label small" for="optZeroStock">Stok 0 olanlarƒ± 1 olarak
                                    g√∂nder</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input type="checkbox" id="optSkipNoImage" class="form-check-input">
                                <label class="form-check-label small" for="optSkipNoImage">G√∂rselsiz √ºr√ºnleri
                                    atla</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input type="checkbox" id="optPriceMultiplier" class="form-check-input">
                                <label class="form-check-label small" for="optPriceMultiplier">Fiyat √ßarpanƒ±
                                    uygula</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input type="checkbox" id="optSkipNoBarcode" class="form-check-input" checked>
                                <label class="form-check-label small" for="optSkipNoBarcode">Barkodsuz √ºr√ºnleri
                                    atla</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input type="checkbox" id="optMatchByStockCode" class="form-check-input">
                                <label class="form-check-label small fw-bold text-primary" for="optMatchByStockCode">
                                    <i class="bi bi-upc-scan me-1"></i>Stok Kodu ƒ∞le E≈üle≈ütir (Barkod yerine)
                                </label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text small">Fiyat 0 ise:</span>
                                <input type="text" id="optDefaultPrice" class="form-control" placeholder="0.00">
                                <button class="btn btn-success btn-sm" type="button" onclick="saveDefaultPrice()">
                                    <i class="bi bi-check"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode/Stock Code Generator -->
    <div id="codeGeneratorSection" class="card mb-4 border-0 shadow-sm d-none" style="background: var(--card);">
        <div class="card-body">
            <h6 class="mb-3"><i class="bi bi-upc-scan me-2"></i>Barkod / Stok Kodu Olu≈üturucu</h6>
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label small">√ñn Ek (2 harf)</label>
                    <input type="text" id="codePrefix" class="form-control" maxlength="2" placeholder="VD"
                        style="text-transform: uppercase;">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Olu≈üturulacak Kod</label>
                    <select id="codeType" class="form-select">
                        <option value="both">Barkod + Stok Kodu</option>
                        <option value="barcode">Sadece Barkod</option>
                        <option value="stock">Sadece Stok Kodu</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small"><i class="bi bi-tag me-1"></i>√úr√ºn ƒ∞smi √ñneki</label>
                    <input type="text" id="titlePrefix" class="form-control" placeholder="√ñrn: [KAMPANYA] "
                        onchange="localStorage.setItem('excelTitlePrefix', this.value)">
                    <small class="text-muted">G√∂nderimde √ºr√ºn isminin ba≈üƒ±na eklenir</small>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">&nbsp;</label>
                    <button class="btn btn-warning w-100" onclick="generateRandomCodes()">
                        <i class="bi bi-shuffle me-1"></i>Random Olu≈ütur
                    </button>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" onclick="showCustomCodeModal()">
                        <i class="bi bi-pencil me-1"></i>√ñzel Kod Gir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div id="productsSection" class="card border-0 shadow-sm d-none" style="background: var(--card);">
        <div class="card-header bg-transparent border-0 py-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0"
                            placeholder="Barkod, √ºr√ºn adƒ± ara...">
                    </div>
                </div>
                <div class="col-md-4 text-center">
                    <span class="text-muted">Se√ßili: <strong id="selectedCount">0</strong> √ºr√ºn</span>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="selectAll()">
                        <i class="bi bi-check-all me-1"></i>T√ºm√ºn√º Se√ß
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
                        <i class="bi bi-x-lg me-1"></i>Se√ßimi Kaldƒ±r
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="productsTable">
                    <thead style="background: var(--bg);">
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAllCheck"
                                    class="form-check-input">
                            </th>
                            <th style="width: 50px;">G√∂rsel</th>
                            <th>Barkod</th>
                            <th>Stok Kodu</th>
                            <th>√úr√ºn Adƒ±</th>
                            <th>Marka</th>
                            <th class="text-end">Fiyat</th>
                            <th class="text-center">Stok</th>
                            <th class="text-center" style="width: 100px;">ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-transparent border-0 py-3">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <small class="text-muted">Toplam: <strong id="totalProducts">0</strong> √ºr√ºn / <strong
                            id="totalPages">0</strong> sayfa</small>
                </div>
                <div class="col-md-4">
                    <nav>
                        <ul class="pagination justify-content-center mb-0" id="pagination"></ul>
                    </nav>
                </div>
                <div class="col-md-4 text-end">
                    <div class="input-group input-group-sm" style="max-width: 150px; display: inline-flex;">
                        <input type="number" id="goToPageInput" class="form-control" placeholder="Sayfa" min="1">
                        <button class="btn btn-outline-secondary" onclick="goToPage()">Git</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--card);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>√úr√ºn Detayƒ±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img id="detailImage" src="" class="img-fluid rounded mb-3" style="max-height: 200px;">
                    </div>
                    <div class="col-md-8">
                        <table class="table table-sm" id="detailTable">
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Column Mapping Modal -->
<div class="modal fade" id="columnMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--card);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-list-check me-2"></i>Kolon E≈üle≈ümesi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Sistem Alanƒ±</th>
                                <th>Excel Kolonu</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="columnMappingBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Code Modal -->
<div class="modal fade" id="customCodeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: var(--card);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>√ñzel Kod Gir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Barkod</label>
                    <input type="text" id="customBarcode" class="form-control" placeholder="8680000123456">
                </div>
                <div class="mb-3">
                    <label class="form-label">Stok Kodu</label>
                    <input type="text" id="customStockCode" class="form-control" placeholder="VD123456">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                <button type="button" class="btn btn-primary" onclick="applyCustomCodes()">Uygula</button>
            </div>
        </div>
    </div>
</div>

<!-- Brand Matching Modal -->
<div class="modal fade" id="brandMatchingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="background: var(--card);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-tags me-2"></i>Marka E≈üle≈ütirme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Excel'deki markalar otomatik olarak Trendyol'daki markalarla e≈üle≈ütirilmeye √ßalƒ±≈üƒ±lacak.
                    E≈üle≈üemeyen markalar i√ßin manuel se√ßim yapabilirsiniz.
                </div>
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="brandSearchInput" class="form-control" placeholder="Marka ara...">
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead style="position: sticky; top: 0; background: var(--card);">
                            <tr>
                                <th>Excel'deki Marka</th>
                                <th>√úr√ºn Sayƒ±sƒ±</th>
                                <th>Trendyol E≈üle≈ümesi</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="brandMatchingBody">
                            <!-- Brand rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-muted small">
                    <span id="brandMatchStats">Y√ºkleniyor...</span>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-between">
                <div class="d-flex align-items-center">
                    <span id="cacheStatusBadge" class="badge bg-secondary me-2">√ñnbellek: Kontrol...</span>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshBrandCache()">
                        <i class="bi bi-arrow-clockwise"></i> Yenile
                    </button>
                </div>
                <button type="button" class="btn btn-outline-danger" onclick="resetBrandMappings()">
                    <i class="bi bi-trash me-1"></i>Sƒ±fƒ±rla
                </button>
                <button type="button" class="btn btn-primary" onclick="resolveUnmatchedBrandsViaAPI()">
                    <i class="bi bi-cloud-check me-1"></i>Akƒ±llƒ± E≈üle≈ütir / Ba≈üarƒ±sƒ±zlarƒ± Dene
                </button>
                <button type="button" class="btn btn-outline-info" onclick="matchBrandsViaTFIDF()">
                    <i class="bi bi-magic me-1"></i>TF-IDF ile E≈üle≈ütir
                </button>
                <!-- REMOVED Auto Match Button -->
                <!-- button type="button" class="btn btn-outline-warning" onclick="autoMatchBrands()">
                    <i class="bi bi-magic me-1"></i>Otomatik E≈üle≈ütir
                </button -->
                <button type="button" class="btn btn-success" onclick="saveBrandMappings()">
                    <i class="bi bi-check-lg me-1"></i>Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Category Matching Modal -->
<div class="modal fade" id="categoryMatchingModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="background: var(--card);">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="bi bi-folder me-2"></i>Kategori E≈üle≈ütirme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    Excel'deki kategoriler Trendyol kategori aƒüacƒ±ndaki kategorilerle e≈üle≈ütirilecek.
                    Otomatik e≈üle≈ütir butonunu kullanarak benzer isimlere g√∂re e≈üle≈ütirme yapabilirsiniz.
                </div>
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="categorySearchInput" class="form-control" placeholder="Kategori ara...">
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead style="position: sticky; top: 0; background: var(--card);">
                            <tr>
                                <th>Excel'deki Kategori</th>
                                <th>√úr√ºn Sayƒ±sƒ±</th>
                                <th>Trendyol Kategori ID</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="categoryMatchingBody">
                            <!-- Category rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-muted small">
                    <span id="categoryMatchStats">Y√ºkleniyor...</span>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-info" onclick="fetchCategoriesFromAPI()">
                    <i class="bi bi-cloud-download me-1"></i>API'den √áek
                </button>
                <button type="button" class="btn btn-primary" onclick="autoMatchCategories()">
                    <i class="bi bi-magic me-1"></i>Otomatik E≈üle≈ütir (TF-IDF)
                </button>
                <button type="button" class="btn btn-success" onclick="saveCategoryMappings()">
                    <i class="bi bi-check-lg me-1"></i>Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    #dropZone.drag-over {
        border-color: var(--bs-success) !important;
        background: rgba(25, 135, 84, 0.1);
    }

    #productsTable tbody tr.selected {
        background: rgba(13, 110, 253, 0.1);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('excelFileInput');
    const searchInput = document.getElementById('searchInput');
    const savedFileSelect = document.getElementById('savedFileSelect');

    let currentFileId = null;
    let currentPage = 1;
    let selectedIndices = new Set();
    let columnMapping = {};

    // Load saved file list on page load
    document.addEventListener('DOMContentLoaded', () => {
        refreshFileList();
        restoreFromLocalStorage();
    });

    function refreshFileList() {
        fetch('/api/excel/list')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    savedFileSelect.innerHTML = '<option value="">-- Dosya Se√ßin (' + data.files.length + ' kayƒ±tlƒ±) --</option>';
                    savedFileSelect.innerHTML += '<option value="manual" class="fw-bold text-primary">üìù Manuel Eklenenler (Veritabanƒ±)</option>';
                    data.files.forEach(f => {
                        const date = new Date(f.created_at).toLocaleDateString('tr-TR');
                        savedFileSelect.innerHTML += `<option value="${f.file_id}">${f.original_filename} (${f.total_products} √ºr√ºn - ${date})</option>`;
                    });
                    // Restore selection from localStorage
                    const savedId = localStorage.getItem('excel_current_file_id');
                    if (savedId) {
                        savedFileSelect.value = savedId;
                    }
                }
            })
            .catch(e => console.error('Failed to load file list:', e));
    }

    function loadSelectedFile() {
        const fileId = savedFileSelect.value;
        if (!fileId) {
            Swal.fire('Uyarƒ±', '√ñnce dosya se√ßin', 'warning');
            return;
        }

        if (fileId === 'manual') {
            currentFileId = 'manual';
            columnMapping = {};
            saveToLocalStorage();
            showFileInfo({
                filename: 'Manuel Eklenen √úr√ºnler',
                total_products: '‚àû',
                matched_columns: '-',
                total_columns: '-'
            });
            loadProducts();
            // Hide irrelevant sections for manual
            document.getElementById('codeGeneratorSection').classList.add('d-none'); // Maybe keep?
            return;
        }

        Swal.fire({ title: 'Y√ºkleniyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        fetch(`/api/excel/load/${fileId}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                Swal.close();
                if (data.success) {
                    currentFileId = data.file_id;
                    columnMapping = data.column_mapping || {};
                    saveToLocalStorage();
                    showFileInfo(data);
                    loadProducts();
                } else {
                    Swal.fire('Hata', data.message || 'Dosya y√ºklenemedi', 'error');
                }
            })
            .catch(() => Swal.fire('Hata', 'Dosya y√ºklenirken hata olu≈ütu', 'error'));
    }

    function deleteSelectedFile() {
        const fileId = savedFileSelect.value;
        if (!fileId) {
            Swal.fire('Uyarƒ±', '√ñnce dosya se√ßin', 'warning');
            return;
        }

        Swal.fire({
            title: 'Dosyayƒ± Sil',
            text: 'Bu dosyayƒ± kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Evet, Sil',
            cancelButtonText: 'ƒ∞ptal',
            confirmButtonColor: '#dc3545'
        }).then(res => {
            if (res.isConfirmed) {
                fetch(`/api/excel/delete/${fileId}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Silindi', 'Dosya silindi', 'success');
                            if (currentFileId === fileId) {
                                clearCurrentFile();
                            }
                            refreshFileList();
                        } else {
                            Swal.fire('Hata', data.message, 'error');
                        }
                    });
            }
        });
    }

    function clearCurrentFile() {
        currentFileId = null;
        columnMapping = {};
        selectedIndices.clear();
        localStorage.removeItem('excel_current_file_id');
        document.getElementById('fileInfoSection').classList.add('d-none');
        document.getElementById('actionSection').classList.add('d-none');
        document.getElementById('codeGeneratorSection').classList.add('d-none');
        document.getElementById('productsSection').classList.add('d-none');
    }

    function saveToLocalStorage() {
        if (currentFileId) {
            localStorage.setItem('excel_current_file_id', currentFileId);
        }
    }

    function restoreFromLocalStorage() {
        const savedId = localStorage.getItem('excel_current_file_id');
        if (savedId) {
            // Try to load the saved file
            fetch(`/api/excel/load/${savedId}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        currentFileId = data.file_id;
                        columnMapping = data.column_mapping || {};
                        showFileInfo(data);
                        loadProducts();
                    }
                })
                .catch(() => localStorage.removeItem('excel_current_file_id'));
        }

        // Load saved send options
        const savedDefaultPrice = localStorage.getItem('optDefaultPrice');
        if (savedDefaultPrice) {
            document.getElementById('optDefaultPrice').value = savedDefaultPrice;
        }

        // Load saved title prefix
        const savedTitlePrefix = localStorage.getItem('excelTitlePrefix');
        if (savedTitlePrefix) {
            document.getElementById('titlePrefix').value = savedTitlePrefix;
        }
    }

    // Drag and drop
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) uploadFile(file);
    });
    fileInput.addEventListener('change', () => {
        if (fileInput.files[0]) uploadFile(fileInput.files[0]);
    });

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        document.getElementById('uploadProgress').classList.remove('d-none');
        const progressBar = document.querySelector('#uploadProgress .progress-bar');
        progressBar.style.width = '30%';

        fetch('/api/excel/upload', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    document.getElementById('uploadProgress').classList.add('d-none');
                    progressBar.style.width = '0%';
                }, 500);

                if (data.success) {
                    currentFileId = data.file_id;
                    columnMapping = data.column_mapping || {};
                    saveToLocalStorage();
                    showFileInfo(data);
                    loadProducts();
                    refreshFileList(); // Refresh dropdown
                } else {
                    Swal.fire('Hata', data.message || 'Dosya y√ºklenemedi', 'error');
                }
            })
            .catch(() => Swal.fire('Hata', 'Y√ºkleme sƒ±rasƒ±nda hata olu≈ütu', 'error'));
    }

    // Save default price to localStorage
    function saveDefaultPrice() {
        const price = document.getElementById('optDefaultPrice')?.value?.trim() || '';
        localStorage.setItem('optDefaultPrice', price);
        Swal.fire({
            icon: 'success',
            title: 'Kaydedildi',
            text: 'Varsayƒ±lan fiyat: ‚Ç∫' + (parseFloat(price) || 0),
            timer: 1500,
            showConfirmButton: false
        });
    }

    function getSendOptions() {
        // Get default price from localStorage (more reliable)
        const savedDefaultPrice = localStorage.getItem('optDefaultPrice') || '';
        const inputDefaultPrice = document.getElementById('optDefaultPrice')?.value?.trim() || '';
        const defaultPriceStr = inputDefaultPrice || savedDefaultPrice;

        return {
            zeroStockAsOne: document.getElementById('optZeroStock')?.checked || false,
            skipNoImage: document.getElementById('optSkipNoImage')?.checked || false,
            applyMultiplier: document.getElementById('optPriceMultiplier')?.checked || false,
            skipNoBarcode: document.getElementById('optSkipNoBarcode')?.checked || false,
            defaultPrice: parseFloat(defaultPriceStr.replace(',', '.')) || 0,
            titlePrefix: document.getElementById('titlePrefix')?.value || '',
            matchBy: document.getElementById('optMatchByStockCode')?.checked ? 'stock_code' : 'barcode'
        };
    }

    function showFileInfo(data) {
        document.getElementById('fileName').textContent = data.filename;
        document.getElementById('productCount').textContent = data.total_products;
        document.getElementById('matchedCols').textContent = data.matched_columns;
        document.getElementById('totalCols').textContent = data.total_columns;

        document.getElementById('fileInfoSection').classList.remove('d-none');
        document.getElementById('actionSection').classList.remove('d-none');
        document.getElementById('codeGeneratorSection').classList.remove('d-none');
        document.getElementById('productsSection').classList.remove('d-none');
    }

    function loadProducts(page = 1) {
        if (!currentFileId) return;
        currentPage = page;
        const search = searchInput.value.trim();

        let url = `/api/excel/products?file_id=${currentFileId}&page=${page}&search=${encodeURIComponent(search)}`;
        if (currentFileId === 'manual') {
            url = `/api/manual/products?page=${page}&search=${encodeURIComponent(search)}`;
        }

        const tbody = document.getElementById('productsBody');
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div> Y√ºkleniyor...</td></tr>';

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    totalProductCount = data.total;
                    totalPageCount = data.total_pages;
                    document.getElementById('totalProducts').textContent = data.total;
                    document.getElementById('totalPages').textContent = data.total_pages;
                    document.getElementById('goToPageInput').max = data.total_pages;
                    allProducts = data.products; // Store for detail view

                    if (data.products.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-muted">√úr√ºn bulunamadƒ±.</td></tr>';
                    } else {
                        renderProducts(data.products);
                    }
                    renderPagination(data.page, data.total_pages);
                } else {
                    tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-danger">Hata: ${data.message || 'Y√ºklenemedi'}</td></tr>`;
                    Swal.fire('Hata', data.message || '√úr√ºnler y√ºklenirken bir sorun olu≈ütu.', 'error');
                }
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-danger">Baƒülantƒ± Hatasƒ±: ${err.message}</td></tr>`;
                console.error('Load products error:', err);
            });
    }

    let allProducts = [];
    let totalProductCount = 0;
    let totalPageCount = 0;

    function renderProducts(products) {
        allProducts = products; // Store for detail view
        const tbody = document.getElementById('productsBody');
        tbody.innerHTML = products.map(p => {
            const imgUrl = getProductImage(p);
            return `
      <tr data-index="${p._index - 1}" class="${selectedIndices.has(p._index - 1) ? 'selected' : ''}">
        <td><input type="checkbox" class="form-check-input product-check" ${selectedIndices.has(p._index - 1) ? 'checked' : ''}></td>
        <td>${imgUrl ? `<img src="${imgUrl}" class="rounded" style="width:40px;height:40px;object-fit:cover;" onerror="this.style.display='none'">` : '<i class="bi bi-image text-muted"></i>'}</td>
        <td><code>${p.barcode || '-'}</code></td>
        <td><small class="text-muted">${p.stock_code || '-'}</small></td>
        <td>${(p.title || '').substring(0, 40)}${(p.title || '').length > 40 ? '...' : ''}</td>
        <td><span class="badge bg-secondary">${p.brand || '-'}</span></td>
        <td class="text-end">${formatPrice(p.sale_price || p.price)}</td>
        <td class="text-center"><span class="badge ${parseInt(p.quantity) > 0 ? 'bg-success' : 'bg-danger'}">${p.quantity || 0}</span></td>
        <td class="text-center">
          <button class="btn btn-sm btn-outline-info me-1" onclick="showProductDetail(${p._index - 1})" title="Detay">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${p._index - 1})" title="D√ºzenle">
            <i class="bi bi-pencil"></i>
          </button>
        </td>
      </tr>
    `}).join('');

        // Add checkbox listeners
        tbody.querySelectorAll('.product-check').forEach(cb => {
            cb.addEventListener('change', function () {
                const row = this.closest('tr');
                const idx = parseInt(row.dataset.index);
                if (this.checked) {
                    selectedIndices.add(idx);
                    row.classList.add('selected');
                } else {
                    selectedIndices.delete(idx);
                    row.classList.remove('selected');
                }
                updateSelectedCount();
            });
        });
    }

    function renderPagination(current, total) {
        const ul = document.getElementById('pagination');
        if (total <= 1) { ul.innerHTML = ''; return; }

        let html = `<li class="page-item ${current === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadProducts(${current - 1}); return false;">¬´</a></li>`;

        for (let i = Math.max(1, current - 2); i <= Math.min(total, current + 2); i++) {
            html += `<li class="page-item ${i === current ? 'active' : ''}">
        <a class="page-link" href="#" onclick="loadProducts(${i}); return false;">${i}</a></li>`;
        }

        html += `<li class="page-item ${current === total ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="loadProducts(${current + 1}); return false;">¬ª</a></li>`;

        ul.innerHTML = html;
    }

    function formatPrice(val) {
        const num = parseFloat(val);
        return isNaN(num) ? '-' : num.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
    }

    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = selectedIndices.size;
    }

    function selectAll() {
        document.querySelectorAll('.product-check').forEach(cb => {
            cb.checked = true;
            const row = cb.closest('tr');
            const idx = parseInt(row.dataset.index);
            selectedIndices.add(idx);
            row.classList.add('selected');
        });
        updateSelectedCount();
    }

    function deselectAll() {
        selectedIndices.clear();
        document.querySelectorAll('.product-check').forEach(cb => {
            cb.checked = false;
            cb.closest('tr').classList.remove('selected');
        });
        updateSelectedCount();
    }

    // Search with debounce
    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => loadProducts(1), 300);
    });

    // Select all checkbox
    document.getElementById('selectAllCheck').addEventListener('change', function () {
        if (this.checked) selectAll(); else deselectAll();
    });

    // Column mapping modal
    function showColumnMapping() {
        const fields = {
            barcode: 'Barkod', title: '√úr√ºn Adƒ±', description: 'A√ßƒ±klama', price: 'Fiyat',
            sale_price: 'Satƒ±≈ü Fiyatƒ±', quantity: 'Stok', brand: 'Marka', category: 'Kategori',
            stock_code: 'Stok Kodu', color: 'Renk', size: 'Beden', image1: 'G√∂rsel 1'
        };
        const tbody = document.getElementById('columnMappingBody');
        tbody.innerHTML = Object.entries(fields).map(([key, label]) => {
            const mapped = columnMapping[key];
            return `<tr>
        <td>${label}</td>
        <td>${mapped || '-'}</td>
        <td>${mapped ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}</td>
      </tr>`;
        }).join('');
        new bootstrap.Modal(document.getElementById('columnMappingModal')).show();
    }

    // Code generator
    function generateRandomCodes() {
        if (selectedIndices.size === 0) {
            Swal.fire('Uyarƒ±', '√ñnce √ºr√ºn se√ßin', 'warning');
            return;
        }
        const prefix = document.getElementById('codePrefix').value.toUpperCase();
        const codeType = document.getElementById('codeType').value;

        fetch('/api/excel/generate_codes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                file_id: currentFileId,
                indices: Array.from(selectedIndices),
                prefix: prefix,
                generate_barcode: codeType === 'both' || codeType === 'barcode',
                generate_stock: codeType === 'both' || codeType === 'stock'
            })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Ba≈üarƒ±lƒ±', `${data.updated} √ºr√ºn i√ßin kod olu≈üturuldu`, 'success');
                    loadProducts(currentPage);
                } else {
                    Swal.fire('Hata', data.message, 'error');
                }
            });
    }

    function showCustomCodeModal() {
        if (selectedIndices.size === 0) {
            Swal.fire('Uyarƒ±', '√ñnce √ºr√ºn se√ßin', 'warning');
            return;
        }
        document.getElementById('customBarcode').value = '';
        document.getElementById('customStockCode').value = '';
        new bootstrap.Modal(document.getElementById('customCodeModal')).show();
    }

    function applyCustomCodes() {
        const barcode = document.getElementById('customBarcode').value.trim();
        const stockCode = document.getElementById('customStockCode').value.trim();

        if (!barcode && !stockCode) {
            Swal.fire('Uyarƒ±', 'En az bir kod girin', 'warning');
            return;
        }

        fetch('/api/excel/update_codes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                file_id: currentFileId,
                indices: Array.from(selectedIndices),
                barcode: barcode || null,
                stock_code: stockCode || null
            })
        })
            .then(r => r.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('customCodeModal')).hide();
                if (data.success) {
                    Swal.fire('Ba≈üarƒ±lƒ±', `${data.updated} √ºr√ºn g√ºncellendi`, 'success');
                    loadProducts(currentPage);
                } else {
                    Swal.fire('Hata', data.message, 'error');
                }
            });
    }

    // Generate random codes for ALL products
    function generateRandomCodes() {
        if (!currentFileId) {
            Swal.fire('Uyarƒ±', '√ñnce bir Excel dosyasƒ± y√ºkleyin', 'warning');
            return;
        }

        const prefix = document.getElementById('codePrefix')?.value?.toUpperCase() || '';
        const codeType = document.getElementById('codeType')?.value || 'both';

        // Prefix can be empty now (user request)
        // if (prefix.length < 2) { ... }

        Swal.fire({
            title: 'T√ºm √úr√ºnlere Kod Olu≈ütur',
            html: `<p><strong>${totalProducts} √ºr√ºn</strong> i√ßin random kod olu≈üturulacak</p>
                   <p>√ñn ek: <strong>${prefix}</strong></p>
                   <p>Kod tipi: <strong>${codeType === 'both' ? 'Barkod + Stok Kodu' : codeType === 'barcode' ? 'Sadece Barkod' : 'Sadece Stok Kodu'}</strong></p>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Olu≈ütur',
            cancelButtonText: 'ƒ∞ptal'
        }).then(result => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Kodlar Olu≈üturuluyor...',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => Swal.showLoading()
                });

                fetch('/api/excel/generate_all_codes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: currentFileId,
                        prefix: prefix,
                        code_type: codeType,
                        title_prefix: document.getElementById('titlePrefix')?.value || ''
                    })
                })
                    .then(r => r.json())
                    .then(data => {
                        Swal.close();
                        if (data.success) {
                            Swal.fire('Ba≈üarƒ±lƒ±', data.message, 'success');
                            loadProducts(currentPage);
                        } else {
                            Swal.fire('Hata', data.message || 'Kod olu≈üturma ba≈üarƒ±sƒ±z', 'error');
                        }
                    });
            }
        });
    }

    // Send to marketplace
    function sendToMarketplace(marketplace) {
        const indices = selectedIndices.size > 0 ? Array.from(selectedIndices) : null;
        const options = getSendOptions();

        Swal.fire({
            title: `${marketplace.charAt(0).toUpperCase() + marketplace.slice(1)}'a G√∂nder`,
            html: `${indices ? `<p>${indices.length} se√ßili √ºr√ºn g√∂nderilecek</p>` : '<p>T√ºm √ºr√ºnler g√∂nderilecek</p>'}
                   <small class="text-muted d-block mt-2">
                   ${options.zeroStockAsOne ? '‚úì Stok 0‚Üí1<br>' : ''}
                   ${options.skipNoImage ? '‚úì G√∂rselsiz atla<br>' : ''}
                   ${options.applyMultiplier ? '‚úì Fiyat √ßarpanƒ±<br>' : ''}
                   ${options.skipNoBarcode ? '‚úì Barkodsuz atla<br>' : ''}
                   ${options.defaultPrice > 0 ? '‚úì Fiyat 0 ise: ‚Ç∫' + options.defaultPrice + '<br>' : ''}
                   ${options.titlePrefix ? '‚úì √úr√ºn ismi √∂neki: "' + options.titlePrefix + '"<br>' : ''}
                   </small>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'G√∂nder',
            cancelButtonText: 'ƒ∞ptal'
        }).then(res => {
            if (res.isConfirmed) {
                Swal.fire({ title: 'G√∂nderiliyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                fetch(`/api/excel/send/${marketplace}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: currentFileId,
                        indices: indices,
                        options: options
                    })
                })
                    .then(r => r.json())
                    .then(data => {
                        Swal.close();
                        if (data.success && data.job_id) {
                            window.showJobWidget(data.job_id);
                        } else {
                            Swal.fire('Hata', data.message || 'G√∂nderim ba≈üarƒ±sƒ±z', 'error');
                        }
                    });
            }
        });
    }

    // Send ALL products to Trendyol
    function sendAllToTrendyol() {
        if (!currentFileId) {
            Swal.fire('Uyarƒ±', '√ñnce bir Excel dosyasƒ± y√ºkleyin', 'warning');
            return;
        }

        const options = getSendOptions();

        Swal.fire({
            title: "T√ºm √úr√ºnleri Trendyol'a G√∂nder",
            html: `<p><strong>${totalProducts} √ºr√ºn</strong> Trendyol'a g√∂nderilecek</p>
                   <hr>
                   <div class="text-start small">
                       <p>‚úì Stok 0 olanlarƒ± 1 yap: ${options.zeroStockAsOne ? 'Evet' : 'Hayƒ±r'}</p>
                       <p>‚úì G√∂rselsiz √ºr√ºnleri atla: ${options.skipNoImage ? 'Evet' : 'Hayƒ±r'}</p>
                       <p>‚úì Fiyat √ßarpanƒ±: ${options.applyMultiplier ? 'Evet' : 'Hayƒ±r'}</p>
                       <p>‚úì Fiyat 0 ise: ‚Ç∫${options.defaultPrice || 0}</p>
                       <p>‚úì √úr√ºn ismi √∂neki: ${options.titlePrefix || '(yok)'}</p>
                       <p>‚úì E≈üle≈ütirme: ${options.matchBy === 'stock_code' ? '<strong>STOK KODU</strong>' : 'Barkod'}</p>
                   </div>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'G√∂nder',
            cancelButtonText: 'ƒ∞ptal'
        }).then(result => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'G√∂nderiliyor...',
                    html: 'T√ºm √ºr√ºnler kuyruƒüa alƒ±nƒ±yor',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => Swal.showLoading()
                });

                // Send ALL products (indices = null means all)
                fetch('/api/excel/send/trendyol', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: currentFileId,
                        indices: null,  // null = ALL products
                        options: options
                    })
                })
                    .then(r => r.json())
                    .then(data => {
                        Swal.close();
                        if (data.success && data.job_id) {
                            window.showJobWidget(data.job_id);
                        } else {
                            Swal.fire('Hata', data.message || 'G√∂nderim ba≈üarƒ±sƒ±z', 'error');
                        }
                    });
            }
        });
    }

    function sendAllSelected() {
        Swal.fire('Bilgi', 'Pazaryeri se√ßerek g√∂nderim yapabilirsiniz', 'info');
    }

    function editProduct(index) {
        // For now, just select the product
        if (!selectedIndices.has(index)) {
            selectedIndices.add(index);
            document.querySelector(`tr[data-index="${index}"] .product-check`).checked = true;
            document.querySelector(`tr[data-index="${index}"]`).classList.add('selected');
            updateSelectedCount();
        }
        showCustomCodeModal();
    }

    // Helper: Get product image URL
    function getProductImage(product) {
        // Check image1-8 fields from raw data
        const raw = product._raw || product;
        for (let i = 1; i <= 8; i++) {
            for (const key of [`image${i}`, `Image${i}`, `G√∂rsel ${i}`, `Resim ${i}`]) {
                if (raw[key] && raw[key].toString().startsWith('http')) {
                    return raw[key];
                }
            }
        }
        // Check images array
        if (product.images && product.images.length > 0) {
            const img = product.images[0];
            return typeof img === 'string' ? img : (img.url || '');
        }
        return null;
    }

    // Show product detail modal
    function showProductDetail(index) {
        // Find product in allProducts array
        const product = allProducts.find(p => (p._index - 1) === index);
        if (!product) return;

        try {
            const raw = product._raw || product;

            // Set image
            const imgUrl = getProductImage(product);
            const detailImg = document.getElementById('detailImage');
            if (imgUrl) {
                detailImg.src = imgUrl;
                detailImg.style.display = 'block';
            } else {
                detailImg.style.display = 'none';
            }

            // Build detail table
            const fields = {
                'Barkod': product.barcode,
                'Stok Kodu': product.stock_code,
                '√úr√ºn Adƒ±': product.title,
                'Marka': product.brand,
                'Kategori': product.category,
                'Fiyat': formatPrice(product.price),
                'Satƒ±≈ü Fiyatƒ±': formatPrice(product.sale_price),
                'Stok': product.quantity,
                'Renk': product.color,
                'Beden': product.size,
                'Cinsiyet': product.gender,
                'Desi': product.desi,
                'KDV Oranƒ±': product.vat_rate,
            };

            // Add any extra raw fields not in standard mapping
            const standardKeys = ['barcode', 'stock_code', 'title', 'brand', 'category', 'price', 'sale_price', 'quantity', 'color', 'size', 'gender', 'desi', 'vat_rate', '_index', '_raw'];
            for (const [key, value] of Object.entries(raw)) {
                if (!standardKeys.includes(key) && value && !key.toLowerCase().includes('image') && !key.toLowerCase().includes('g√∂rsel')) {
                    fields[key] = value;
                }
            }

            const tbody = document.querySelector('#detailTable tbody');
            tbody.innerHTML = Object.entries(fields)
                .filter(([k, v]) => v !== null && v !== undefined && v !== '')
                .map(([k, v]) => `<tr><th class="text-muted" style="width:35%">${k}</th><td>${v}</td></tr>`)
                .join('');

            new bootstrap.Modal(document.getElementById('productDetailModal')).show();
        } catch (e) {
            console.error('Error showing detail:', e);
        }
    }

    // Go to specific page
    function goToPage() {
        const input = document.getElementById('goToPageInput');
        const page = parseInt(input.value);
        if (page && page >= 1 && page <= totalPageCount) {
            loadProducts(page);
            input.value = '';
        } else {
            Swal.fire('Uyarƒ±', `1-${totalPageCount} arasƒ± bir sayfa girin`, 'warning');
        }
    }

    // ========== BRAND MATCHING FUNCTIONS ==========
    let brandMappings = {}; // {excelBrand: trendyolBrandId}
    let excelBrands = []; // [{name, count, matched, trendyolId, trendyolName}]
    let trendyolBrands = []; // [{id, name}]

    function showBrandMatchingModal() {
        if (!currentFileId) {
            Swal.fire('Uyarƒ±', '√ñnce bir Excel dosyasƒ± y√ºkleyin', 'warning');
            return;
        }

        // Load brand mappings from localStorage
        const savedMappings = localStorage.getItem('excelBrandMappings');
        if (savedMappings) {
            try {
                brandMappings = JSON.parse(savedMappings);
            } catch (e) { }
        }

        new bootstrap.Modal(document.getElementById('brandMatchingModal')).show();
        loadBrandList();
    }

    async function loadBrandList() {
        const tbody = document.getElementById('brandMatchingBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div> Y√ºkleniyor...</td></tr>';

        try {
            // Get unique brands from Excel
            const excelResp = await fetch(`/api/excel/brands?file_id=${currentFileId}`);
            const excelData = await excelResp.json();

            if (!excelData.success) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-danger">Excel markalarƒ± y√ºklenemedi</td></tr>';
                return;
            }

            excelBrands = excelData.brands;

            // Get Trendyol brands from cache
            const trendyolResp = await fetch('/api/trendyol/brands');
            const trendyolData = await trendyolResp.json();
            trendyolBrands = trendyolData.brands || [];

            renderBrandTable();

        } catch (e) {
            console.error('Brand loading error:', e);
            tbody.innerHTML = '<tr><td colspan="4" class="text-danger">Hata olu≈ütu</td></tr>';
        }
    }

    function renderBrandTable() {
        const tbody = document.getElementById('brandMatchingBody');
        let matchedCount = 0;
        let unmatchedCount = 0;

        // Custom Sort: 
        // 1. Matched brands (Green) first
        // 2. Then Unmatched brands (Red/Warning)
        // Within each group, sort alphabetically by name
        excelBrands.sort((a, b) => {
            const isMatchedA = !!brandMappings[a.name.toLowerCase()];
            const isMatchedB = !!brandMappings[b.name.toLowerCase()];

            if (isMatchedA && !isMatchedB) return -1; // A comes first
            if (!isMatchedA && isMatchedB) return 1;  // B comes first

            // If both matched or both unmatched, sort by name
            return a.name.localeCompare(b.name, 'tr');
        });

        tbody.innerHTML = excelBrands.map(b => {
            // Check if already mapped
            const mappedId = brandMappings[b.name.toLowerCase()];
            let matchedBrand = null;
            let statusHtml = '';

            if (mappedId) {
                matchedBrand = trendyolBrands.find(t => t.id === mappedId);
                if (matchedBrand) {
                    matchedCount++;
                    statusHtml = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> E≈üle≈üti</span>';
                }
            }

            // Try auto-match by name - REMOVED PER USER REQUEST
            // if (!matchedBrand) {
            //     matchedBrand = trendyolBrands.find(t => t.name.toLowerCase() === b.name.toLowerCase());
            //     if (matchedBrand) {
            //         brandMappings[b.name.toLowerCase()] = matchedBrand.id;
            //         matchedCount++;
            //         statusHtml = '<span class="badge bg-info"><i class="bi bi-magic"></i> Otomatik</span>';
            //     } else {
            //         unmatchedCount++;
            //         statusHtml = '<span class="badge bg-warning text-dark"><i class="bi bi-question-circle"></i> E≈üle≈ümedi</span>';
            //     }
            // }

            if (!matchedBrand) {
                unmatchedCount++;
                statusHtml = '<span class="badge bg-warning text-dark"><i class="bi bi-question-circle"></i> E≈üle≈ümedi</span>';
            }

            return `<tr data-brand="${escapeHtml(b.name)}">
                <td><strong>${escapeHtml(b.name)}</strong></td>
                <td><span class="badge bg-secondary">${b.count} √ºr√ºn</span></td>
                <td>
                    <select class="form-select form-select-sm brand-select" data-brand="${escapeHtml(b.name)}" 
                            onchange="updateBrandMapping(this)">
                        <option value="">-- Se√ß --</option>
                        ${trendyolBrands.slice(0, 100).map(t =>
                `<option value="${t.id}" ${matchedBrand && matchedBrand.id === t.id ? 'selected' : ''}>${escapeHtml(t.name)}</option>`
            ).join('')}
                    </select>
                </td>
                <td>${statusHtml}</td>
            </tr>`;
        }).join('');

        document.getElementById('brandMatchStats').textContent =
            `Toplam: ${excelBrands.length} marka | E≈üle≈üen: ${matchedCount} | E≈üle≈ümeyen: ${unmatchedCount}`;

        // Add search filter
        document.getElementById('brandSearchInput').oninput = function () {
            const search = this.value.toLowerCase();
            document.querySelectorAll('#brandMatchingBody tr').forEach(row => {
                const brand = row.dataset.brand.toLowerCase();
                row.style.display = brand.includes(search) ? '' : 'none';
            });
        };
    }

    function updateBrandMapping(select) {
        const brand = select.dataset.brand;
        const trendyolId = parseInt(select.value) || 0;

        if (trendyolId) {
            brandMappings[brand.toLowerCase()] = trendyolId;
        } else {
            delete brandMappings[brand.toLowerCase()];
        }

        // Update status
        const row = select.closest('tr');
        const statusCell = row.querySelector('td:last-child');
        if (trendyolId) {
            statusCell.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> E≈üle≈üti</span>';
        } else {
            statusCell.innerHTML = '<span class="badge bg-warning text-dark"><i class="bi bi-question-circle"></i> E≈üle≈ümedi</span>';
        }
    }

    // function autoMatchBrands() REMOVED PER USER REQUEST
    // async function autoMatchBrands() { ... }


    // ========== CACHE MANAGEMENT ==========
    function checkBrandCacheStatus() {
        const badge = document.getElementById('cacheStatusBadge');
        if (!badge) return;

        badge.className = 'badge bg-secondary me-2';
        badge.innerText = '√ñnbellek: Kontrol ediliyor...';

        fetch('/api/trendyol/brands/cache_status')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    if (data.status === 'OK') {
                        badge.className = 'badge bg-success me-2';
                        badge.innerText = `√ñnbellek: ${data.mem_count} marka (Aktif)`;
                    } else {
                        badge.className = 'badge bg-danger me-2';
                        badge.innerText = `√ñnbellek: BO≈û (${data.mem_count})`;
                    }
                } else {
                    badge.innerText = '√ñnbellek: Hata';
                }
            })
            .catch(() => {
                badge.innerText = '√ñnbellek: Baƒülantƒ± Hatasƒ±';
            });
    }

    function refreshBrandCache() {
        Swal.fire({
            title: '√ñnbellek Yenileniyor...',
            text: 'Trendyol\'dan markalar tekrar √ßekiliyor, bu i≈ülem biraz s√ºrebilir.',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        fetch('/api/trendyol/brands/refresh_cache', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                Swal.close();
                if (data.success) {
                    Swal.fire('Ba≈üarƒ±lƒ±', data.message, 'success');
                    checkBrandCacheStatus();
                } else {
                    Swal.fire('Hata', data.message, 'error');
                }
            })
            .catch(e => {
                Swal.fire('Hata', 'Yenileme sƒ±rasƒ±nda hata olu≈ütu', 'error');
            });
    }

    // Clear all brand mappings
    function resetBrandMappings() {
        Swal.fire({
            title: 'Sƒ±fƒ±rlamak istediƒüinize emin misiniz?',
            text: "T√ºm marka e≈üle≈ütirmeleri silinecek ve en ba≈ütan ba≈ülanacak!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet, Sil',
            cancelButtonText: 'ƒ∞ptal'
        }).then((result) => {
            if (result.isConfirmed) {
                // Clear local object
                brandMappings = {};
                // Clear local storage
                localStorage.removeItem('excel_brand_mappings');
                // Re-render table
                renderBrandTable();
                Swal.fire('Silindi', 'Marka e≈üle≈ütirmeleri sƒ±fƒ±rlandƒ±.', 'success');
            }
        });
    }

    // Call check on modal open
    const brandModalEl = document.getElementById('brandMatchingModal');
    if (brandModalEl) {
        brandModalEl.addEventListener('shown.bs.modal', function () {
            checkBrandCacheStatus();
        });
    }

    // Helper for generating multiple normalization variants to handle Turkish I/ƒ∞ ambiguity
    function getNormalizationVariants(name) {
        if (!name) return [];
        const variants = new Set();
        const clean = (s) => s.replace(/['".,/\\#!$%^&*;:{}=\-_`~()]/g, "").replace(/\s+/g, "").trim();

        // 1. Turkish Locale Lowercase
        variants.add(clean(name.toLocaleLowerCase('tr')));

        // 2. Standard Lowercase (fallback for systems where locale might differ)
        variants.add(clean(name.toLowerCase()));

        // 3. ASCII-fied (Aggressive: ƒ∞->i, ƒ±->i, etc)
        const trMap = { 'ƒ∞': 'i', 'I': 'i', 'ƒ±': 'i', '≈û': 's', '≈ü': 's', 'ƒû': 'g', 'ƒü': 'g', '√ú': 'u', '√º': 'u', '√ñ': 'o', '√∂': 'o', '√á': 'c', '√ß': 'c' };
        const asciiName = name.split('').map(c => trMap[c] || c).join('');
        variants.add(clean(asciiName.toLowerCase()));

        return Array.from(variants).filter(x => x.length > 0);
    }

    // Improved resolve function: Prioritizes Local Cache with Robust Matching
    async function resolveUnmatchedBrandsViaAPI() {
        if (trendyolBrands.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: '√ñnbellek Bo≈ü',
                text: 'Trendyol markalarƒ± hen√ºz y√ºklenmemi≈ü. L√ºtfen sayfayƒ± yenileyin veya "Sƒ±fƒ±rla" yapƒ±p tekrar deneyin.',
                confirmButtonText: 'Tamam'
            });
            return;
        }

        const unmatched = excelBrands.filter(b => {
            const mappedId = brandMappings[b.name.toLowerCase()];
            const isValidRef = mappedId && trendyolBrands.find(t => t.id === mappedId);
            return !isValidRef;
        });

        if (unmatched.length === 0) {
            Swal.fire('Bilgi', 'T√ºm markalar zaten e≈üle≈ümi≈ü!', 'info');
            return;
        }

        Swal.fire({
            title: 'Akƒ±llƒ± E≈üle≈ütirme (Geli≈ümi≈ü)',
            html: `<p>Markalar yerel √∂nbellekte taranƒ±yor...</p>
                   <div class="progress mb-2"><div id="smartMatchProgress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div></div>
                   <div class="text-muted small">ƒ∞≈üleniyor: <span id="currentSmartMatchBrand">...</span></div>`,
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        // Build a robust lookup map
        // key: variant string -> value: brand object
        const trendyolMap = new Map();
        trendyolBrands.forEach(t => {
            const variants = getNormalizationVariants(t.name);
            variants.forEach(v => {
                // If collision, we keep the existing one. 
                // Since specific brands are usually better than generic ones, this is generally safe enough.
                if (!trendyolMap.has(v)) {
                    trendyolMap.set(v, t);
                }
            });
        });

        let resolvedCount = 0;
        let failedCount = 0;
        const total = unmatched.length;
        const CHUNK_SIZE = 50;

        for (let i = 0; i < total; i += CHUNK_SIZE) {
            const chunk = unmatched.slice(i, i + CHUNK_SIZE);
            await new Promise(r => setTimeout(r, 10));

            chunk.forEach(b => {
                document.getElementById('currentSmartMatchBrand').textContent = b.name;

                // Try to match any variant of the excel brand
                const variants = getNormalizationVariants(b.name);
                let match = null;

                for (const v of variants) {
                    if (trendyolMap.has(v)) {
                        match = trendyolMap.get(v);
                        break;
                    }
                }

                if (match) {
                    brandMappings[b.name.toLowerCase()] = match.id;
                    resolvedCount++;
                } else {
                    failedCount++;
                }
            });

            const percent = Math.round(((i + chunk.length) / total) * 100);
            const bar = document.getElementById('smartMatchProgress');
            if (bar) bar.style.width = `${percent}%`;
        }

        Swal.close();
        renderBrandTable();

        if (resolvedCount > 0) {
            Swal.fire({
                icon: 'success',
                title: 'E≈üle≈ütirme Tamamlandƒ±',
                html: `<p><strong>${resolvedCount}</strong> marka ba≈üarƒ±yla e≈üle≈üti.</p>
                       <p><strong>${failedCount}</strong> marka e≈üle≈üemedi.</p>
                       ${failedCount > 0 ? '<p class="small text-muted">Kalanlar i√ßin "TF-IDF ile E≈üle≈ütir" deneyebilirsiniz.</p>' : ''}`
            });
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'E≈üle≈üme Bulunamadƒ±',
                html: '√ñnbellekte uygun e≈üle≈üme bulunamadƒ±.<br>Marka isimlerini kontrol edin veya <b>TF-IDF</b> butonunu deneyin.'
            });
        }
    }

    async function matchBrandsViaTFIDF() {
        const unmatched = excelBrands.filter(b => {
            const mappedId = brandMappings[b.name.toLowerCase()];
            const isValidRef = mappedId && trendyolBrands.find(t => t.id === mappedId);
            return !isValidRef;
        }).map(b => b.name);

        if (unmatched.length === 0) {
            Swal.fire('Bilgi', 'T√ºm markalar zaten e≈üle≈ümi≈ü!', 'info');
            return;
        }

        // Initialize Progress Modal
        Swal.fire({
            title: 'TF-IDF ile E≈üle≈ütiriliyor...',
            html: `
                <div class="mb-2">Analiz ediliyor: <span id="currentTfidfBrand" class="fw-bold">Ba≈ülƒ±yor...</span></div>
                <div class="progress mb-2" style="height: 25px;">
                    <div id="tfidfProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
                </div>
                <div class="d-flex justify-content-between text-muted small">
                    <span id="tfidfProgressCount">0 / ${unmatched.length}</span>
                    <span>L√ºtfen bekleyin...</span>
                </div>
            `,
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        const batchSize = 50; // Batch size: 50 brands per request
        let totalResolved = 0;
        let totalFailed = 0;
        let allResolvedMap = {};

        try {
            for (let i = 0; i < unmatched.length; i += batchSize) {
                const batch = unmatched.slice(i, i + batchSize);

                // Update UI: Show the first brand of the current batch as "Processing..."
                const currentBrand = batch[0] + (batch.length > 1 ? ` ve ${batch.length - 1} diƒüer...` : '');
                const progressPct = Math.round((i / unmatched.length) * 100);

                const brandEl = document.getElementById('currentTfidfBrand');
                const barEl = document.getElementById('tfidfProgressBar');
                const countEl = document.getElementById('tfidfProgressCount');

                if (brandEl) brandEl.textContent = currentBrand;
                if (barEl) {
                    barEl.style.width = `${progressPct}%`;
                    barEl.textContent = `${progressPct}%`;
                }
                if (countEl) countEl.textContent = `${i} / ${unmatched.length}`;

                // Fetch
                const resp = await fetch('/api/trendyol/brands/match_tfidf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ brands: batch })
                });
                const data = await resp.json();

                if (data.success) {
                    totalResolved += data.resolved_count || 0;
                    totalFailed += data.failed_count || 0;
                    Object.assign(allResolvedMap, data.resolved || {});
                } else {
                    console.error('TF-IDF batch failed:', data.message);
                    totalFailed += batch.length;
                }

                // Small delay to ensure UI renders
                await new Promise(r => setTimeout(r, 10));
            }

            // Final Progress Update
            const barEl = document.getElementById('tfidfProgressBar');
            if (barEl) {
                barEl.style.width = '100%';
                barEl.textContent = '100%';
            }

            // Process collected results
            for (const [excelBrand, match] of Object.entries(allResolvedMap)) {
                brandMappings[excelBrand.toLowerCase()] = match.id;
                if (!trendyolBrands.find(t => t.id === match.id)) {
                    trendyolBrands.push({ id: match.id, name: match.name });
                }
            }

            renderBrandTable();

            // Show Success/Result Modal with Details
            Swal.fire({
                icon: 'success',
                title: 'TF-IDF E≈üle≈ütirme Tamamlandƒ±',
                html: `<p><strong>${totalResolved}</strong> marka e≈üle≈ütirildi.</p>
                       <p><strong>${totalFailed}</strong> marka bulunamadƒ±.</p>
                       <hr>
                       <h6 class="text-start">E≈üle≈üme Detaylarƒ±:</h6>
                       ${function () {
                        let h = '<div class="table-responsive" style="max-height: 300px; text-align: left;"><table class="table table-sm table-striped"><thead><tr><th>Excel</th><th>Trendyol</th></tr></thead><tbody>';
                        for (const [k, v] of Object.entries(allResolvedMap)) {
                            h += `<tr><td>${k}</td><td><span class="text-success">${v.name}</span></td></tr>`;
                        }
                        h += '</tbody></table></div>';
                        return totalResolved > 0 ? h : '<p class="text-muted text-start small">Detay yok</p>';
                    }()}`,
                width: '600px'
            });

        } catch (e) {
            console.error(e);
            Swal.fire('Hata', 'ƒ∞≈ülem sƒ±rasƒ±nda sunucu hatasƒ± olu≈ütu', 'error');
        }
    }

    function saveBrandMappings() {
        localStorage.setItem('excelBrandMappings', JSON.stringify(brandMappings));

        // Also save to server
        fetch('/api/excel/brand_mappings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mappings: brandMappings })
        }).then(r => r.json()).then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Kaydedildi!',
                    text: `${Object.keys(brandMappings).length} marka e≈üle≈ümesi kaydedildi`,
                    timer: 1500,
                    showConfirmButton: false
                });
                bootstrap.Modal.getInstance(document.getElementById('brandMatchingModal')).hide();
            } else {
                Swal.fire('Hata', data.message || 'Kayƒ±t ba≈üarƒ±sƒ±z', 'error');
            }
        });
    }

    // ========== CATEGORY MATCHING FUNCTIONS ==========
    let categoryMappings = {}; // {excelCategory: trendyolCategoryId}
    let excelCategories = []; // [{name, count}]

    function showCategoryMatchingModal() {
        if (!currentFileId) {
            Swal.fire('Uyarƒ±', '√ñnce bir Excel dosyasƒ± y√ºkleyin', 'warning');
            return;
        }

        // Load category mappings from localStorage
        const savedMappings = localStorage.getItem('excelCategoryMappings');
        if (savedMappings) {
            try {
                categoryMappings = JSON.parse(savedMappings);
            } catch (e) { }
        }

        new bootstrap.Modal(document.getElementById('categoryMatchingModal')).show();
        loadCategoryList();
    }

    async function loadCategoryList() {
        const tbody = document.getElementById('categoryMatchingBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div> Y√ºkleniyor...</td></tr>';

        try {
            // Get unique categories from Excel
            const resp = await fetch(`/api/excel/categories?file_id=${currentFileId}`);
            const data = await resp.json();

            console.log('Category API response:', data);

            if (!data.success) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-danger">Excel kategorileri y√ºklenemedi: ' + (data.message || '') + '</td></tr>';
                return;
            }

            if (!data.categories || data.categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-warning">Excel dosyasƒ±nda kategori s√ºtunu bulunamadƒ± veya bo≈ü. S√ºtun e≈üle≈ümelerini kontrol edin.</td></tr>';
                return;
            }

            excelCategories = data.categories;
            console.log('Loaded excelCategories:', excelCategories.length);
            renderCategoryTable();

        } catch (e) {
            console.error('Category loading error:', e);
            tbody.innerHTML = '<tr><td colspan="4" class="text-danger">Hata olu≈ütu</td></tr>';
        }
    }

    function renderCategoryTable() {
        const tbody = document.getElementById('categoryMatchingBody');
        let matchedCount = 0;
        let unmatchedCount = 0;

        tbody.innerHTML = excelCategories.map(c => {
            const mappedId = categoryMappings[c.name.toLowerCase()];
            let statusHtml = '';

            if (mappedId) {
                matchedCount++;
                statusHtml = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> E≈üle≈üti</span>';
            } else {
                unmatchedCount++;
                statusHtml = '<span class="badge bg-warning text-dark"><i class="bi bi-question-circle"></i> E≈üle≈ümedi</span>';
            }

            return `<tr data-category="${escapeHtml(c.name)}">
                <td><strong>${escapeHtml(c.name)}</strong></td>
                <td><span class="badge bg-secondary">${c.count} √ºr√ºn</span></td>
                <td>
                    <input type="number" class="form-control form-control-sm category-id-input" 
                           data-category="${escapeHtml(c.name)}" 
                           value="${mappedId || ''}"
                           placeholder="Kategori ID"
                           onchange="updateCategoryMapping(this)">
                </td>
                <td>${statusHtml}</td>
            </tr>`;
        }).join('');

        document.getElementById('categoryMatchStats').textContent =
            `Toplam: ${excelCategories.length} kategori | E≈üle≈üen: ${matchedCount} | E≈üle≈ümeyen: ${unmatchedCount}`;

        // Add search filter
        document.getElementById('categorySearchInput').oninput = function () {
            const search = this.value.toLowerCase();
            document.querySelectorAll('#categoryMatchingBody tr').forEach(row => {
                const cat = row.dataset.category.toLowerCase();
                row.style.display = cat.includes(search) ? '' : 'none';
            });
        };
    }

    function updateCategoryMapping(input) {
        const category = input.dataset.category;
        const categoryId = parseInt(input.value) || 0;

        if (categoryId) {
            categoryMappings[category.toLowerCase()] = categoryId;
        } else {
            delete categoryMappings[category.toLowerCase()];
        }

        // Update status
        const row = input.closest('tr');
        const statusCell = row.querySelector('td:last-child');
        if (categoryId) {
            statusCell.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> E≈üle≈üti</span>';
        } else {
            statusCell.innerHTML = '<span class="badge bg-warning text-dark"><i class="bi bi-question-circle"></i> E≈üle≈ümedi</span>';
        }
    }

    async function fetchCategoriesFromAPI() {
        Swal.fire({
            title: 'Trendyol Kategorileri √áekiliyor...',
            html: 'Bu i≈ülem birka√ß saniye s√ºrebilir',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const resp = await fetch('/settings/fetch_trendyol_categories', { method: 'POST' });
            const data = await resp.json();

            Swal.close();

            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Ba≈üarƒ±lƒ±!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire('Hata', data.message || 'Kategori √ßekme ba≈üarƒ±sƒ±z', 'error');
            }
        } catch (e) {
            console.error('Category fetch error:', e);
            Swal.fire('Hata', 'Bir hata olu≈ütu', 'error');
        }
    }

    async function autoMatchCategories() {
        Swal.fire({
            title: 'Kategoriler E≈üle≈ütiriliyor...',
            html: 'T√ºm kategoriler cache\'den e≈üle≈ütiriliyor...',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            // Get ALL categories (force re-match)
            const allCategories = excelCategories.map(c => c.name);

            if (allCategories.length === 0) {
                Swal.fire('Bilgi', 'E≈üle≈ütirilecek kategori yok!', 'info');
                return;
            }

            // Clear existing mappings to force re-match
            categoryMappings = {};

            // Call API to match ALL categories using cached Trendyol categories
            const resp = await fetch('/api/trendyol/categories/match', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categories: allCategories })
            });
            const data = await resp.json();

            if (data.success) {
                let matched = 0;
                let failed = 0;

                for (const catName of allCategories) {
                    const catId = data.matches ? data.matches[catName] : null;
                    if (catId) {
                        categoryMappings[catName.toLowerCase()] = catId;
                        matched++;
                    } else {
                        failed++;
                    }
                }

                Swal.close();
                renderCategoryTable();

                Swal.fire({
                    icon: matched > 0 ? 'success' : 'warning',
                    title: 'E≈üle≈ütirme Tamamlandƒ±',
                    html: `<p><strong>${matched}</strong> kategori e≈üle≈ütirildi</p>
                           <p><strong>${failed}</strong> kategori e≈üle≈ütirilemedi</p>
                           <hr>
                           <small class="text-muted">E≈üle≈üemeyenler i√ßin manuel ID giri≈üi yapabilirsiniz</small>`
                });
            } else {
                Swal.fire('Hata', data.message || 'E≈üle≈ütirme ba≈üarƒ±sƒ±z', 'error');
            }
        } catch (e) {
            console.error('Category match error:', e);
            Swal.fire('Hata', 'Bir hata olu≈ütu', 'error');
        }
    }

    function saveCategoryMappings() {
        localStorage.setItem('excelCategoryMappings', JSON.stringify(categoryMappings));

        // Also save to server
        fetch('/api/excel/category_mappings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mappings: categoryMappings })
        }).then(r => r.json()).then(data => {
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Kaydedildi!',
                    text: `${Object.keys(categoryMappings).length} kategori e≈üle≈ümesi kaydedildi`,
                    timer: 1500,
                    showConfirmButton: false
                });
                bootstrap.Modal.getInstance(document.getElementById('categoryMatchingModal')).hide();
            } else {
                Swal.fire('Hata', data.message || 'Kayƒ±t ba≈üarƒ±sƒ±z', 'error');
            }
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

</script>
{% endblock %}