{% extends "_base.html" %}

{% block title %}SipariÅŸler - VIDOS YÃ¶netimi{% endblock %}

{% block page_title %}ðŸ“¦ SipariÅŸler{% endblock %}

{% block content %}
<div class="card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h5 class="mb-1">SipariÅŸ Listesi</h5>
            <p class="text-muted small mb-0">TÃ¼m pazaryerlerinden gelen sipariÅŸleri gÃ¶rÃ¼ntÃ¼leyin</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <select class="form-select form-select-sm" id="perPageSelect" style="width: auto;">
                <option value="5">5 sipariÅŸ</option>
                <option value="10">10 sipariÅŸ</option>
                <option value="20">20 sipariÅŸ</option>
                <option value="50">50 sipariÅŸ</option>
            </select>
        </div>
    </div>

    <!-- Filters Form -->
    <form id="filterForm" method="GET" action="{{ url_for('main.orders_page') }}">
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <select class="form-select" name="marketplace" id="marketplaceFilter" onchange="this.form.submit()">
                    <option value="">TÃ¼m Pazaryerleri</option>
                    <option value="trendyol">Trendyol</option>
                    <option value="pazarama">Pazarama</option>
                    <option value="n11">N11</option>
                    <option value="idefix">Ä°defix</option>
                    <option value="hepsiburada">Hepsiburada</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="status" id="statusFilter" onchange="this.form.submit()">
                    <option value="">TÃ¼m Durumlar</option>
                    <option value="OluÅŸturuldu">OluÅŸturuldu</option>
                    <option value="HazÄ±rlanÄ±yor">HazÄ±rlanÄ±yor</option>
                    <option value="FaturalandÄ±">FaturalandÄ±</option>
                    <option value="Kargoya Verildi">Kargoya Verildi</option>
                    <option value="Teslim Edildi">Teslim Edildi</option>
                    <option value="Ä°ptal Edildi">Ä°ptal Edildi</option>
                    <option value="Teslim Edilemedi">Teslim Edilemedi</option>
                    <option value="Ä°ade Edildi">Ä°ade Edildi</option>
                    <option value="Beklemede">Beklemede</option>
                </select>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" name="search" id="searchInput"
                        placeholder="SipariÅŸ no, mÃ¼ÅŸteri adÄ±..." value="{{ request.args.get('search', '') }}">
                    <button class="btn btn-outline-secondary" type="submit">Ara</button>
                </div>
            </div>
            <!-- Hidden inputs to persist params -->
            <input type="hidden" name="per_page" id="hiddenPerPage" value="{{ request.args.get('per_page', 20) }}">
            <input type="hidden" name="sort_by" id="hiddenSortBy" value="{{ request.args.get('sort_by', '') }}">
            <input type="hidden" name="order" id="hiddenOrder" value="{{ request.args.get('order', 'desc') }}">
        </div>
    </form>

    <!-- Orders Table -->
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>SipariÅŸ No</th>
                    <th style="cursor: pointer;" onclick="toggleSort('marketplace')">
                        Pazaryeri
                        {% if request.args.get('sort_by') == 'marketplace' %}
                        <i class="bi bi-arrow-{{ 'up' if request.args.get('order') == 'asc' else 'down' }}"></i>
                        {% endif %}
                    </th>
                    <th>MÃ¼ÅŸteri</th>
                    <th style="cursor: pointer;" onclick="toggleSort('total_price')">
                        Tutar
                        {% if request.args.get('sort_by') == 'total_price' %}
                        <i class="bi bi-arrow-{{ 'up' if request.args.get('order') == 'asc' else 'down' }}"></i>
                        {% endif %}
                    </th>
                    <th>Durum</th>
                    <th>Tarih</th>
                    <th>Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody>
                {% if orders.items %}
                {% for order in orders.items %}
                <tr>
                    <td><strong>{{ order.order_number }}</strong></td>
                    <td>
                        {% if order.marketplace == 'trendyol' %}
                        <span class="badge bg-success">Trendyol</span>
                        {% else %}
                        <span class="badge bg-primary">{{ order.marketplace|title }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.customer %}
                        {{ order.customer.first_name }} {{ order.customer.last_name }}
                        {% else %}
                        <span class="text-muted">â€”</span>
                        {% endif %}
                    </td>
                    <td>{{ "%.2f"|format(order.total_price) }} {{ order.currency }}</td>
                    <td>
                        {% if 'Teslim Edildi' in order.status %}
                        <span class="badge bg-success">{{ order.status }}</span>
                        {% elif 'Kargoya Verildi' in order.status %}
                        <span class="badge bg-info">{{ order.status }}</span>
                        {% elif 'Ä°ptal' in order.status %}
                        <span class="badge bg-danger">{{ order.status }}</span>
                        {% else %}
                        <span class="badge bg-warning">{{ order.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ order.created_at.strftime('%d.%m.%Y %H:%M') if order.created_at else 'â€”' }}</td>
                    <td>
                        <div class="btn-group">
                            <a href="{{ url_for('main.order_detail', order_id=order.id) }}"
                                class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-secondary"
                                onclick="window.printOrderLabel('{{ order.id }}')" title="Kargo Etiketi YazdÄ±r">
                                <i class="bi bi-printer"></i>
                            </button>
                            {% if order.marketplace == 'trendyol' and order.status not in ['Teslim Edildi', 'Ä°ptal
                            Edildi', 'Ä°ade Edildi'] %}
                            <button type="button"
                                class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Ä°ÅŸlemler</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <h6 class="dropdown-header">Durum GÃ¼ncelle</h6>
                                </li>
                                {% if order.status == 'OluÅŸturuldu' %}
                                <li><a class="dropdown-item" href="#"
                                        onclick="updateOrderStatus('{{ order.shipment_package_id or order.id }}', 'Picking')">
                                        <i class="bi bi-box-seam text-warning me-2"></i>HazÄ±rlanÄ±yor
                                    </a></li>
                                {% endif %}
                                {% if order.status in ['OluÅŸturuldu', 'HazÄ±rlanÄ±yor'] %}
                                <li><a class="dropdown-item" href="#"
                                        onclick="updateOrderStatus('{{ order.shipment_package_id or order.id }}', 'Invoiced')">
                                        <i class="bi bi-receipt text-info me-2"></i>FaturalandÄ±
                                    </a></li>
                                {% endif %}
                                {% if order.status in ['OluÅŸturuldu', 'HazÄ±rlanÄ±yor', 'FaturalandÄ±'] %}
                                <li><a class="dropdown-item" href="#"
                                        onclick="openShippingModal('{{ order.shipment_package_id or order.id }}', '{{ order.order_number }}')">
                                        <i class="bi bi-truck text-success me-2"></i>Kargoya Ver
                                    </a></li>
                                {% endif %}
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="#"
                                        onclick="openInvoiceModal('{{ order.shipment_package_id or order.id }}', '{{ order.order_number }}')">
                                        <i class="bi bi-file-pdf text-primary me-2"></i>Fatura GÃ¶nder
                                    </a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item text-danger" href="#"
                                        onclick="markUnsupplied('{{ order.shipment_package_id or order.id }}')">
                                        <i class="bi bi-x-circle me-2"></i>Tedarik Edilemedi
                                    </a></li>
                            </ul>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4 d-block mb-2"></i>
                        Kriterlere uygun sipariÅŸ bulunamadÄ±.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if orders.pages > 1 %}
    <nav>
        <ul class="pagination justify-content-center">
            {% if orders.has_prev %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('main.orders_page', page=orders.prev_num, per_page=request.args.get('per_page', 20), marketplace=request.args.get('marketplace'), status=request.args.get('status'), search=request.args.get('search'), sort_by=request.args.get('sort_by'), order=request.args.get('order')) }}">Ã–nceki</a>
            </li>
            {% endif %}

            {% for page_num in orders.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
            {% if page_num %}
            <li class="page-item {% if page_num == orders.page %}active{% endif %}">
                <a class="page-link"
                    href="{{ url_for('main.orders_page', page=page_num, per_page=request.args.get('per_page', 20), marketplace=request.args.get('marketplace'), status=request.args.get('status'), search=request.args.get('search'), sort_by=request.args.get('sort_by'), order=request.args.get('order')) }}">{{
                    page_num }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
            {% endfor %}

            {% if orders.has_next %}
            <li class="page-item">
                <a class="page-link"
                    href="{{ url_for('main.orders_page', page=orders.next_num, per_page=request.args.get('per_page', 20), marketplace=request.args.get('marketplace'), status=request.args.get('status'), search=request.args.get('search'), sort_by=request.args.get('sort_by'), order=request.args.get('order')) }}">Sonraki</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function syncOrders(marketplace) {
        Swal.fire({ title: 'Ã‡ekiliyor...', showConfirmButton: false, didOpen: () => Swal.showLoading() });
        fetch(`/api/orders/sync/${marketplace}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    Swal.fire('BaÅŸarÄ±lÄ±!', `${d.synced || 0} sipariÅŸ`, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Hata!', d.message || 'Bir hata oluÅŸtu', 'error');
                }
            });
    }

    // Set initial values from URL params
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const mp = urlParams.get('marketplace');
        const st = urlParams.get('status');
        const pp = urlParams.get('per_page') || '20';

        if (mp) document.getElementById('marketplaceFilter').value = mp;
        if (st) document.getElementById('statusFilter').value = st;
        document.getElementById('perPageSelect').value = pp;
    });

    // Per page change handler
    document.getElementById('perPageSelect').addEventListener('change', function () {
        document.getElementById('hiddenPerPage').value = this.value;
        document.getElementById('filterForm').submit();
    });

    // Sorting handler
    function toggleSort(field) {
        const currentSort = document.getElementById('hiddenSortBy').value;
        const currentOrder = document.getElementById('hiddenOrder').value;

        let newOrder = 'desc';
        if (currentSort === field && currentOrder === 'desc') {
            newOrder = 'asc';
        }

        document.getElementById('hiddenSortBy').value = field;
        document.getElementById('hiddenOrder').value = newOrder;
        document.getElementById('filterForm').submit();
    }

    // ============================================================
    // Trendyol Order Actions
    // ============================================================

    async function updateOrderStatus(packageId, status) {
        const result = await Swal.fire({
            title: 'Emin misiniz?',
            text: `SipariÅŸ durumunu "${status}" olarak gÃ¼ncellemek istediÄŸinize emin misiniz?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Evet, GÃ¼ncelle',
            cancelButtonText: 'Ä°ptal'
        });

        if (!result.isConfirmed) return;

        Swal.fire({ title: 'GÃ¼ncelleniyor...', showConfirmButton: false, didOpen: () => Swal.showLoading() });

        try {
            const res = await fetch(`/api/trendyol/order/${packageId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: status })
            });
            const json = await res.json();

            if (json.success) {
                Swal.fire('BaÅŸarÄ±lÄ±!', json.message, 'success').then(() => location.reload());
            } else {
                Swal.fire('Hata!', json.message, 'error');
            }
        } catch (err) {
            Swal.fire('Hata!', err.message, 'error');
        }
    }

    let currentShippingPackageId = null;
    let currentInvoicePackageId = null;

    function openShippingModal(packageId, orderNumber) {
        currentShippingPackageId = packageId;
        document.getElementById('shippingOrderNumber').textContent = orderNumber;
        document.getElementById('trackingNumber').value = '';
        document.getElementById('cargoProviderId').value = '';

        const modal = new bootstrap.Modal(document.getElementById('shippingModal'));
        modal.show();
    }

    async function submitShipping() {
        const trackingNumber = document.getElementById('trackingNumber').value.trim();
        const cargoProviderId = parseInt(document.getElementById('cargoProviderId').value);

        if (!trackingNumber) {
            Swal.fire('UyarÄ±', 'Kargo takip numarasÄ± zorunludur.', 'warning');
            return;
        }

        Swal.fire({ title: 'GÃ¶nderiliyor...', showConfirmButton: false, didOpen: () => Swal.showLoading() });

        try {
            const res = await fetch(`/api/trendyol/order/${currentShippingPackageId}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: 'Shipped',
                    tracking_number: trackingNumber,
                    cargo_provider_id: cargoProviderId || null
                })
            });
            const json = await res.json();

            if (json.success) {
                bootstrap.Modal.getInstance(document.getElementById('shippingModal')).hide();
                Swal.fire('BaÅŸarÄ±lÄ±!', 'SipariÅŸ kargoya verildi.', 'success').then(() => location.reload());
            } else {
                Swal.fire('Hata!', json.message, 'error');
            }
        } catch (err) {
            Swal.fire('Hata!', err.message, 'error');
        }
    }

    function openInvoiceModal(packageId, orderNumber) {
        currentInvoicePackageId = packageId;
        document.getElementById('invoiceOrderNumber').textContent = orderNumber;
        document.getElementById('invoiceLink').value = '';

        const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
        modal.show();
    }

    async function submitInvoice() {
        const invoiceLink = document.getElementById('invoiceLink').value.trim();

        if (!invoiceLink) {
            Swal.fire('UyarÄ±', 'Fatura linki zorunludur.', 'warning');
            return;
        }

        Swal.fire({ title: 'GÃ¶nderiliyor...', showConfirmButton: false, didOpen: () => Swal.showLoading() });

        try {
            const res = await fetch(`/api/trendyol/order/${currentInvoicePackageId}/invoice`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ invoice_link: invoiceLink })
            });
            const json = await res.json();

            if (json.success) {
                bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
                Swal.fire('BaÅŸarÄ±lÄ±!', 'Fatura linki gÃ¶nderildi.', 'success');
            } else {
                Swal.fire('Hata!', json.message, 'error');
            }
        } catch (err) {
            Swal.fire('Hata!', err.message, 'error');
        }
    }

    async function markUnsupplied(packageId) {
        const result = await Swal.fire({
            title: 'Tedarik Edilemedi',
            text: 'Bu sipariÅŸi tedarik edilemedi olarak iÅŸaretlemek istediÄŸinize emin misiniz?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Evet, Ä°ÅŸaretle',
            cancelButtonText: 'Ä°ptal'
        });

        if (!result.isConfirmed) return;

        Swal.fire({ title: 'Ä°ÅŸleniyor...', showConfirmButton: false, didOpen: () => Swal.showLoading() });

        try {
            // Note: This sends an empty line_items list which may need to be adjusted
            // based on actual order items. In a full implementation, you'd get the line items first.
            const res = await fetch(`/api/trendyol/order/${packageId}/unsupplied`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ line_items: [] })
            });
            const json = await res.json();

            if (json.success) {
                Swal.fire('BaÅŸarÄ±lÄ±!', 'SipariÅŸ tedarik edilemedi olarak iÅŸaretlendi.', 'success').then(() => location.reload());
            } else {
                Swal.fire('Hata!', json.message, 'error');
            }
        } catch (err) {
            Swal.fire('Hata!', err.message, 'error');
        }
    }

</script>

<script>
    window.printOrderLabel = function (orderId) {
        // Open print label in a new popup window
        const width = 600;
        const height = 800;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;

        window.open(
            `/order/${orderId}/print_label`,
            'KargoEtiketi',
            `width=${width},height=${height},top=${top},left=${left},scrollbars=yes`
        );
    }
</script>

<!-- Shipping Modal -->
<div class="modal fade" id="shippingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-truck me-2 text-success"></i>Kargoya Ver</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">SipariÅŸ: <strong id="shippingOrderNumber"></strong></p>
                <div class="mb-3">
                    <label class="form-label">Kargo Takip NumarasÄ± <span class="text-danger">*</span></label>
                    <input type="text" id="trackingNumber" class="form-control" placeholder="Takip numarasÄ±...">
                </div>
                <div class="mb-3">
                    <label class="form-label">Kargo FirmasÄ±</label>
                    <select id="cargoProviderId" class="form-select">
                        <option value="">SeÃ§iniz...</option>
                        <option value="10">Aras Kargo</option>
                        <option value="19">YurtiÃ§i Kargo</option>
                        <option value="17">MNG Kargo</option>
                        <option value="4">PTT Kargo</option>
                        <option value="6">SÃ¼rat Kargo</option>
                        <option value="9">UPS Kargo</option>
                        <option value="20">Trendyol Express</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                <button type="button" class="btn btn-success" onclick="submitShipping()">
                    <i class="bi bi-truck me-1"></i>Kargoya Ver
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-pdf me-2 text-primary"></i>Fatura GÃ¶nder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">SipariÅŸ: <strong id="invoiceOrderNumber"></strong></p>
                <div class="mb-3">
                    <label class="form-label">Fatura PDF Linki <span class="text-danger">*</span></label>
                    <input type="url" id="invoiceLink" class="form-control"
                        placeholder="https://example.com/fatura.pdf">
                    <small class="text-muted">Fatura PDF dosyasÄ±nÄ±n eriÅŸilebilir URL'si</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                <button type="button" class="btn btn-primary" onclick="submitInvoice()">
                    <i class="bi bi-send me-1"></i>Fatura GÃ¶nder
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}