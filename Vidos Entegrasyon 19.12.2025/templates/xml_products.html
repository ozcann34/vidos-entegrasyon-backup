{% extends "_base.html" %}
{% block title %}XML Ürün Listesi — VIDOS{% endblock %}
{% block page_title %}Tedarikçi XML'den Gelen Ürünler{% endblock %}

{% block content %}
<div class="animate-fade-in">
  <div class="card mb-4 border-0 shadow-sm">
    <div class="card-body p-3">
      <div class="row g-3 align-items-center">
        <div class="col-lg-4">
          <div class="input-group">
            <span class="input-group-text border-end-0"
              style="background: var(--input-bg); border-color: var(--input-border); color: var(--muted);"><i
                class="bi bi-search"></i></span>
            <input type="text" id="searchInput" class="form-control border-start-0 ps-0"
              style="background: var(--input-bg); border-color: var(--input-border); color: var(--text);"
              placeholder="Ürün Adı veya Barkod ile ara...">
          </div>
        </div>
        <div class="col-lg-8">
          <div class="d-flex flex-wrap justify-content-lg-end gap-2 align-items-center">
            <div class="d-flex align-items-center gap-2 me-2">
              <div class="input-group input-group-sm" style="width: 120px;">
                <input id="goToInput" type="number" min="1" class="form-control" placeholder="Sayfa">
                <button id="goToBtn" class="btn btn-outline-secondary">Git</button>
              </div>
            </div>

            <div class="vr mx-1 d-none d-lg-block"></div>

            <div class="btn-group" role="group">
              <button id="sendTrendyolBtn" class="btn btn-sm btn-outline-warning text-dark fw-bold"
                title="Seçili ürünleri Trendyol'a gönder">
                <i class="bi bi-shop"></i><span class="d-none d-xl-inline ms-1">Trendyol</span>
              </button>
              <button id="sendHepsiburadaBtn" class="btn btn-sm btn-outline-warning fw-bold"
                style="color:#FF6000; border-color:#FF6000;" title="Seçili ürünleri Hepsiburada'ya gönder">
                <i class="bi bi-bag-fill"></i><span class="d-none d-xl-inline ms-1">Hepsiburada</span>
              </button>
              <button id="sendPazaramaBtn" class="btn btn-sm btn-outline-primary fw-bold"
                title="Seçili ürünleri Pazarama'ya gönder">
                <i class="bi bi-credit-card-fill"></i><span class="d-none d-xl-inline ms-1">Pazarama</span>
              </button>
              <button id="sendIdefixBtn" class="btn btn-sm btn-outline-info fw-bold"
                title="Seçili ürünleri İdefix'e gönder">
                <i class="bi bi-box-seam-fill"></i><span class="d-none d-xl-inline ms-1">İdefix</span>
              </button>
              <button id="sendN11Btn" class="btn btn-sm btn-outline-danger fw-bold"
                style="color:#5f259f; border-color:#5f259f;" title="Seçili ürünleri N11'e gönder">
                <i class="bi bi-shop-window"></i><span class="d-none d-xl-inline ms-1">N11</span>
              </button>
            </div>

            <button id="sendAllBtn" class="btn btn-success btn-sm fw-bold btn-animated" title="Tüm ürünleri gönder">
              <i class="bi bi-send-fill me-1"></i>Tümünü Gönder
            </button>

            <div class="btn-group ms-2">
              <button id="changeSourceBtn" class="btn btn-outline-secondary btn-sm" title="XML Kaynağını Değiştir">
                <i class="bi bi-shuffle"></i>
              </button>
              <button id="toggleViewBtn" class="btn btn-outline-primary btn-sm" data-mode="list"
                title="Görünümü Değiştir">
                <i class="bi bi-grid-3x3-gap"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-12 text-end">
          <span id="productCount" class="badge bg-light text-dark border p-2">Toplam 0 ürün</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tools & Options -->
  <div class="card mb-4 border-0 shadow-sm animate-fade-in" style="background: var(--card);">
    <div class="card-body p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0 text-secondary"><i class="bi bi-sliders me-2"></i>Gönderim Ayarları</h6>
        <span class="badge text-muted border" style="background: var(--input-bg);">Seçimleriniz gönderim anında
          uygulanır (Sayfa yenilenince
          sıfırlanır)</span>
      </div>
      <div class="row g-3">
        <div class="col-md-4 col-lg-3">
          <label class="form-label small fw-bold mb-1">Ürün İsmi Öneki (Prefix)</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text border-end-0"
              style="background: var(--input-bg); border-color: var(--input-border); color: var(--muted);"><i
                class="bi bi-fonts"></i></span>
            <input type="text" id="titlePrefixInput" class="form-control border-start-0"
              style="background: var(--input-bg); border-color: var(--input-border); color: var(--text);"
              placeholder="Örn: [KAMPANYA] ">
          </div>
          <div class="form-text small mt-0" style="font-size: 0.75rem;">Başlığın önüne eklenir. Boş bırakılabilir.</div>
        </div>
        <div class="col-md-8 col-lg-9">
          <label class="form-label small fw-bold mb-1">Seçenekler</label>
          <div class="d-flex flex-wrap gap-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="optMatchByStockCode">
              <label class="form-check-label small" for="optMatchByStockCode">Stok Kodu İle Eşleştir (Barkod
                yerine)</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="optZeroStockAsOne">
              <label class="form-check-label small" for="optZeroStockAsOne">Stok 0 ise 1 gönder</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-responsive shadow-sm card border-0 mb-4" id="listContainer">
    <table class="table table-hover align-middle mb-0">
      <thead class="bg-light">
        <tr>
          <th style="width: 40px;" class="ps-3"><input id="selectAll" type="checkbox" class="form-check-input"></th>
          <th style="width: 70px;">Görsel</th>
          <th style="width: 30%;">Ürün Adı</th>
          <th>Barkod</th>
          <th>Kategori Yolu</th>
          <th>Fiyat / Stok</th>
          <th>Durum</th>
        </tr>
      </thead>
      <tbody id="productListBody"></tbody>
    </table>
  </div>

  <div id="gridContainer" class="d-none mb-4">
    <div id="productGrid" class="row g-3"></div>
  </div>

  <nav class="pb-4">
    <ul class="pagination justify-content-center shadow-sm" id="pagination"></ul>
  </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Global Variables
  let currentPage = 1;
  let itemsPerPage = 5000;
  let currentSearchQuery = '';
  let currentTotal = 0;
  let selectedSourceId = localStorage.getItem('vidos_xml_source_id') || null;
  const selectedBarcodes = new Set();
  let viewMode = localStorage.getItem('vidos_view_mode') || 'list';

  // DOM Elements
  const productListBody = document.getElementById('productListBody');
  const pagination = document.getElementById('pagination');
  const productCountSpan = document.getElementById('productCount');
  const searchInput = document.getElementById('searchInput');
  const perPageSelect = document.getElementById('perPageSelect');
  const goToInput = document.getElementById('goToInput');
  const goToBtn = document.getElementById('goToBtn');
  const selectAll = document.getElementById('selectAll');
  const changeSourceBtn = document.getElementById('changeSourceBtn');
  const toggleViewBtn = document.getElementById('toggleViewBtn');

  // --- Helper Functions ---

  function showSummaryAndRedirect(j) {
    try { Swal.close(); } catch (e) { }
    const m = j.matched || [];
    const sk = j.skipped || [];
    const s = j.summary || { success_count: 0, fail_count: 0, failures: [] };
    const failures = (s.failures || []).slice(0, 3).map(f => `<div><code>${f.barcode || '-'}</code> — ${(Array.isArray(f.reasons) ? f.reasons.join(', ') : f.reasons) || '-'}</div>`).join('') || '<div>—</div>';
    const skippedList = sk.slice(0, 3).map(x => `<div><code>${x.barcode || '-'}</code> — ${x.reason || '-'}</div>`).join('') || '<div>—</div>';
    const html = `
    <div class="text-start">
      <div><strong>Toplam Gönderim:</strong> ${j.count || (m.length)}</div>
      <div><strong>Eşleşen Kategori:</strong> ${m.length}</div>
      <div><strong>Atlanan:</strong> ${sk.length}</div>
      <div class="mt-2"><strong>Başarılı:</strong> ${s.success_count} — <strong>Hatalı:</strong> ${s.fail_count}</div>
      <div class="mt-2"><strong>Batch ID:</strong> <code>${j.batch_id || '-'}</code></div>
      <hr />
      <div class="mb-1"><strong>Örnek Hatalar:</strong></div>
      ${failures}
      <hr />
      <div class="mb-1"><strong>Atlanan Örnekler:</strong></div>
      ${skippedList}
    </div>`;
    Swal.fire({ title: 'Gönderim Özeti', html, icon: 'info', showCancelButton: true, confirmButtonText: 'Detaya Git', cancelButtonText: 'Kapat', didOpen: () => { setTimeout(() => { if (Swal.isVisible()) { window.location.href = j.batch_id ? `/batch/${j.batch_id}` : '/batch_logs'; } }, 3000); } }).then(res => { if (res.isConfirmed) { window.location.href = j.batch_id ? `/batch/${j.batch_id}` : '/batch_logs'; } });
  }

  function renderProducts(products) {
    try {
      const listContainer = document.getElementById('listContainer');
      const gridContainer = document.getElementById('gridContainer');
      const grid = document.getElementById('productGrid');

      if (!listContainer || !gridContainer || !productListBody) return;

      if (viewMode === 'list') {
        listContainer.classList.remove('d-none');
        gridContainer.classList.add('d-none');
        productListBody.innerHTML = '';

        if (!products || products.length === 0) {
          productListBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Hiç ürün bulunamadı.</td></tr>';
          return;
        }

        products.forEach(product => {
          const checked = selectedBarcodes.has(product.barcode) ? 'checked' : '';
          const imgUrl = (product.images && product.images[0] && (product.images[0].url || product.images[0])) || 'https://via.placeholder.com/120x120?text=IMG';
          const row = `
              <tr class="animate-fade-in">
                  <td class="ps-3"><input type="checkbox" class="form-check-input row-check" data-barcode="${product.barcode}" ${checked}></td>
                  <td><img src="${imgUrl}" alt="${product.title}" class="img-thumbnail border-0 shadow-sm" style="width: 50px; height: 50px; object-fit: cover;"></td>
                  <td class="text-truncate" style="max-width: 250px;" title="${product.title}">${product.title}</td>
                  <td><span class="badge bg-secondary font-monospace">${product.barcode}</span></td>
                  <td style="font-size: 0.85rem;" class="text-muted text-truncate" style="max-width: 150px;">${product.category || '---'}</td>
                  <td>
                    <div class="d-flex flex-column">
                      <span class="fw-bold">${Number(product.price || 0).toFixed(2)} TL</span>
                      <span class="small text-success fw-bold">Stok: ${parseInt(product.quantity || 0)}</span>
                    </div>
                  </td>
                  <td><span class="badge bg-info bg-opacity-10 text-info border border-info">Hazır</span></td>
              </tr>
          `;
          productListBody.insertAdjacentHTML('beforeend', row);
        });

      } else {
        // Grid View
        listContainer.classList.add('d-none');
        gridContainer.classList.remove('d-none');
        grid.innerHTML = '';

        if (!products || products.length === 0) {
          grid.innerHTML = '<div class="col-12 text-center p-5 text-muted">Hiç ürün bulunamadı.</div>';
          return;
        }

        products.forEach(product => {
          const checked = selectedBarcodes.has(product.barcode) ? 'checked' : '';
          const imgUrl = (product.images && product.images[0] && (product.images[0].url || product.images[0])) || 'https://via.placeholder.com/300x200?text=IMG';
          const card = `
              <div class="col-12 col-sm-6 col-md-4 col-lg-3 animate-fade-in">
                <div class="card h-100 border-0 shadow-sm product-card">
                  <div class="card-body p-2 d-flex flex-column">
                    <div class="d-flex align-items-start justify-content-between mb-2">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input row-check" data-barcode="${product.barcode}" ${checked}>
                      </div>
                      <span class="badge bg-secondary font-monospace small">${product.barcode}</span>
                    </div>
                    <div class="text-center mb-2" style="height: 160px; overflow: hidden; border-radius: 8px; background: #f8f9fa;">
                      <img src="${imgUrl}" class="h-100 w-100" style="object-fit: contain;">
                    </div>
                    <div class="fw-semibold text-truncate mb-1" title="${product.title}">${product.title}</div>
                    <div class="text-muted small mb-2 text-truncate">${product.category_path || '---'}</div>
                    <div class="mt-auto d-flex justify-content-between align-items-center pt-2 border-top">
                      <div class="fw-bold fs-5 text-primary">${Number(product.price || 0).toFixed(2)} TL</div>
                      <div class="badge bg-success bg-opacity-10 text-success">Stok: ${parseInt(product.quantity || 0)}</div>
                    </div>
                  </div>
                </div>
              </div>`;
          grid.insertAdjacentHTML('beforeend', card);
        });
      }

      // Re-attach event listeners
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const bc = e.target.dataset.barcode;
          if (e.target.checked) selectedBarcodes.add(bc); else selectedBarcodes.delete(bc);
        });
      });
    } catch (err) {
      console.error("Render error:", err);
    }
  }

  function addPageItem(num, active = false, disabled = false, text = null) {
    const li = document.createElement('li');
    li.className = `page-item ${active ? 'active' : ''} ${disabled ? 'disabled' : ''}`;
    const label = text || num;
    li.innerHTML = `<a class="page-link" href="#" data-page="${num}">${label}</a>`;
    if (!disabled) {
      li.addEventListener('click', (e) => { e.preventDefault(); currentPage = parseInt(e.target.dataset.page); fetchProducts(); });
    }
    pagination.appendChild(li);
  }

  function renderPagination(total, current) {
    const totalPages = Math.ceil(total / itemsPerPage) || 1;
    pagination.innerHTML = '';
    addPageItem(Math.max(1, current - 1), false, current === 1, '«');
    const windowSize = 2;
    const pages = [];
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= current - windowSize && i <= current + windowSize)) pages.push(i);
    }
    let last = 0;
    pages.forEach(p => {
      if (p - last > 1) {
        const li = document.createElement('li'); li.className = 'page-item disabled'; li.innerHTML = '<span class="page-link">…</span>'; pagination.appendChild(li);
      }
      addPageItem(p, p === current);
      last = p;
    });
    addPageItem(Math.min(totalPages, current + 1), false, current === totalPages, '»');
  }

  function fetchProducts() {
    if (!selectedSourceId) {
      productListBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-muted">Lütfen bir XML kaynağı seçin.</td></tr>';
      return Promise.resolve();
    }

    if (viewMode === 'list') {
      productListBody.innerHTML = '<tr><td colspan="7" class="text-center p-5 text-primary"><div class="spinner-border spinner-border-sm me-2"></div> Ürünler yükleniyor...</td></tr>';
    } else {
      const grid = document.getElementById('productGrid');
      if (grid) grid.innerHTML = '<div class="col-12 text-center p-5 text-primary"><div class="spinner-border spinner-border-sm me-2"></div> Ürünler yükleniyor...</div>';
    }

    const url = `/api/xml_source_products?source_id=${selectedSourceId}&page=${currentPage}&per_page=${itemsPerPage}&q=${encodeURIComponent(currentSearchQuery)}`;

    return fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error("API Hatası: " + response.status);
        }
        return response.json();
      })
      .then(data => {
        if (!data || !Array.isArray(data.items)) {
          throw new Error("Veri formatı geçersiz");
        }
        currentTotal = data.total || 0;
        productCountSpan.textContent = `Toplam ${currentTotal} ürün (${currentPage}/${Math.ceil(currentTotal / itemsPerPage) || 1} sayfa)`;
        renderProducts(data.items);
        renderPagination(currentTotal, currentPage);
      })
      .catch((err) => {
        console.error("Fetch error:", err);
        const errorMsg = '<tr><td colspan="7" class="text-center p-5 text-danger">Ürünler yüklenemedi. Lütfen sayfayı yenileyin.</td></tr>';
        if (viewMode === 'list') productListBody.innerHTML = errorMsg;
        else {
          const grid = document.getElementById('productGrid');
          if (grid) grid.innerHTML = '<div class="col-12 text-center p-5 text-danger">Ürünler yüklenemedi.</div>';
        }
        productCountSpan.textContent = 'Toplam 0 ürün';
      });
  }

  // --- Event Listeners ---

  // Search
  let debounceTimeout;
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(() => {
        currentSearchQuery = e.target.value.trim();
        currentPage = 1;
        fetchProducts();
      }, 500);
    });
  }


  // Go to Page
  function goToPage() {
    const val = parseInt(goToInput.value || '1');
    const totalPages = Math.ceil(currentTotal / itemsPerPage) || 1;
    if (val >= 1 && val <= totalPages) { currentPage = val; fetchProducts(); }
  }
  if (goToBtn) goToBtn.addEventListener('click', goToPage);
  if (goToInput) goToInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); goToPage(); } });

  // Select All
  if (selectAll) {
    selectAll.addEventListener('change', (e) => {
      document.querySelectorAll('.row-check').forEach(cb => {
        cb.checked = e.target.checked;
        const bc = cb.dataset.barcode;
        if (e.target.checked) selectedBarcodes.add(bc); else selectedBarcodes.delete(bc);
      });
    });
  }

  // Toggle View
  if (toggleViewBtn) {
    // Set initial UI based on local storage
    if (viewMode === 'grid') {
      toggleViewBtn.dataset.mode = 'grid';
      toggleViewBtn.innerHTML = '<i class="bi bi-list-ul me-1"></i> Görünüm: Liste';
    }

    toggleViewBtn.addEventListener('click', () => {
      if (viewMode === 'list') {
        viewMode = 'grid';
        toggleViewBtn.dataset.mode = 'grid';
        toggleViewBtn.innerHTML = '<i class="bi bi-list-ul me-1"></i> Görünüm: Liste';
      } else {
        viewMode = 'list';
        toggleViewBtn.dataset.mode = 'list';
        toggleViewBtn.innerHTML = '<i class="bi bi-grid-3x3-gap me-1"></i> Görünüm: Grid';
      }
      localStorage.setItem('vidos_view_mode', viewMode);
      fetchProducts(); // Re-render logic handles container visibility
    });
  }

  // Change Source
  function chooseSource() {
    fetch('/api/xml_sources').then(r => r.json()).then(j => {
      const items = j.items || [];
      if (items.length === 0) { Swal.fire('Bilgi', 'Kayıtlı XML kaynağı yok. Ayarlar sayfasından ekleyin.', 'info'); return; }
      const opts = items.reduce((acc, it) => { acc[it.id] = `${it.name}`; return acc; }, {});
      Swal.fire({ title: 'XML Kaynağı Seçin', input: 'select', inputOptions: opts, showCancelButton: true, confirmButtonText: 'Seç' })
        .then(res => {
          if (!res.isConfirmed) return;
          selectedSourceId = res.value;
          localStorage.setItem('vidos_xml_source_id', String(selectedSourceId));
          currentPage = 1;
          fetchProducts();
        });
    });
  }
  if (changeSourceBtn) changeSourceBtn.addEventListener('click', chooseSource);

  // Send selected (other marketplaces)
  // New Individual Send Buttons Logic
  const sendTrendyolBtn = document.getElementById('sendTrendyolBtn');
  const sendHepsiburadaBtn = document.getElementById('sendHepsiburadaBtn');
  const sendPazaramaBtn = document.getElementById('sendPazaramaBtn');
  const sendIdefixBtn = document.getElementById('sendIdefixBtn');

  function sendToMarketplace(mp, mpName, color = '#primary') {
    const barcodes = Array.from(selectedBarcodes);
    if (barcodes.length === 0) { Swal.fire('Uyarı', 'Lütfen ürün seçin', 'warning'); return; }

    Swal.fire({
      title: `${mpName}'a Gönderilecek`,
      html: `<p class="fs-5 fw-bold" style="color:${color}">${barcodes.length} ürün ${mpName} pazaryerine gönderilecek.</p><p>Doğru pazaryerini seçtiğinizden emin misiniz?</p>`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Evet, Gönder',
      cancelButtonText: 'İptal',
      confirmButtonColor: color
    }).then(confirm => {
      if (!confirm.isConfirmed) return;

      function getOptions() {
        const titlePrefix = document.getElementById('titlePrefixInput')?.value || '';
        const matchBy = document.getElementById('optMatchByStockCode')?.checked ? 'stock_code' : 'barcode';
        // Note: API send_selected extraction looks for title_prefix in payload root, not nested
        // We will put them in root
        return {
          title_prefix: titlePrefix,
          match_by: matchBy,
          // Some services might need send_options dict? api.py currently ignores it in lambda but we can try passing it if we update api.py later. 
          // Currently I updated API to extract title_prefix and match_by.
          // I did NOT update api.py to pass 'zero_stock_as_one' etc to lambda for ALL services, only some?
          // Actually api.py lambda signatures I updated only added title_prefix.
          // So zero stock options might not work yet unless I update api.py/services more.
          // But Title Prefix is the main goal.
        };
      }

      function doSend(xml_source_id) {
        Swal.fire({ title: 'Gönderiliyor', text: 'İşlem biraz sürebilir...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const opts = getOptions();
        const payload = { barcodes, xml_source_id, ...opts };

        fetch(`/api/send_selected/${mp}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
          .then(r => r.json()).then(j => {
            if (j.success) { showSummaryAndRedirect(j); }
            else { Swal.fire('Hata', j.message || 'İşlem başarısız', 'error'); }
          }).catch(() => Swal.fire('Hata', 'API çağrısı sırasında bir sorun oluştu.', 'error'));
      }

      function doSendAuto(xml_source_id) {
        Swal.fire({ title: 'Gönderiliyor', text: 'Kategori eşlemesi yapılıyor...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const opts = getOptions();
        const payload = { barcodes, xml_source_id, auto_match: true, ...opts };

        fetch(`/api/trendyol/send_auto`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
          .then(r => r.json()).then(j => {
            if (j.success) { showSummaryAndRedirect(j); }
            else { Swal.fire('Hata', j.message || 'İşlem başarısız', 'error'); }
          }).catch(() => Swal.fire('Hata', 'API çağrısı sırasında bir sorun oluştu.', 'error'));
      }

      if (mp === 'trendyol') {
        Swal.fire({
          title: 'Otomatik Kategori Eşleştirilsin mi?',
          text: 'Ürün adı ile en yakın kategori bulunup gönderilecek.',
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'Evet, otomatik',
          cancelButtonText: 'Hayır, manuel'
        }).then(ans => {
          const proceedAuto = ans.isConfirmed;
          const doNext = (id) => proceedAuto ? doSendAuto(id) : doSend(id);
          doNext(selectedSourceId);
        });
      } else {
        doSend(selectedSourceId);
      }
    });
  }

  if (sendTrendyolBtn) sendTrendyolBtn.addEventListener('click', () => sendToMarketplace('trendyol', 'Trendyol', '#ffc107'));
  if (sendHepsiburadaBtn) sendHepsiburadaBtn.addEventListener('click', () => sendToMarketplace('hepsiburada', 'Hepsiburada', '#FF6000'));
  if (sendPazaramaBtn) sendPazaramaBtn.addEventListener('click', () => sendToMarketplace('pazarama', 'Pazarama', '#0d6efd'));
  if (sendIdefixBtn) sendIdefixBtn.addEventListener('click', () => sendToMarketplace('idefix', 'İdefix', '#0dcaf0'));
  if (document.getElementById('sendN11Btn')) document.getElementById('sendN11Btn').addEventListener('click', () => sendToMarketplace('n11', 'N11', '#5f259f'));

  // Hook into Send All button
  const sendAllBtn = document.getElementById('sendAllBtn');
  if (sendAllBtn) {
    sendAllBtn.addEventListener('click', async () => {
      const result = await Swal.fire({
        title: 'Tüm Ürünleri Gönder',
        html: `
          <div class="text-start">
            <p>Hangi pazaryerine göndermek istiyorsunuz?</p>
            <select id="marketplaceSelect" class="form-select">
              <option value="trendyol">Trendyol</option>
              <option value="hepsiburada">Hepsiburada</option>
              <option value="pazarama">Pazarama</option>
              <option value="idefix">İdefix</option>
              <option value="n11">N11</option>
            </select>
            </div>
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="autoMatchCheck" checked>
              <label class="form-check-label" for="autoMatchCheck">
                Otomatik kategori eşleştir (Varsayılan)
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="stockCodeMatchCheck">
              <label class="form-check-label" for="stockCodeMatchCheck">
                Stok Kodu İle Eşleştir (Barkod yerine)
              </label>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Başlat',
        cancelButtonText: 'İptal',
        preConfirm: () => {
          return {
            marketplace: document.getElementById('marketplaceSelect').value,
            autoMatch: document.getElementById('autoMatchCheck').checked,
            matchBy: document.getElementById('stockCodeMatchCheck').checked ? 'stock_code' : 'barcode'
          };
        }
      });
      if (result.isConfirmed) {
        const { marketplace, autoMatch, matchBy } = result.value;
        try {
          const response = await fetch(`/api/${marketplace}/send_all`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_id: selectedSourceId, auto_match: autoMatch, match_by: matchBy })
          });
          const data = await response.json();
          if (data.success && data.batch_id && window.showJobWidget) {
            window.showJobWidget(data.batch_id);
          } else {
            Swal.fire('Hata', data.message || 'Başlatılamadı', 'error');
          }
        } catch (error) { Swal.fire('Hata', error.message, 'error'); }
      }
    });
  }

  // Initial Load
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Initial UI Setup
    if (window.activeJobId && window.showJobWidget) {
      window.showJobWidget(window.activeJobId);
    }

    // 2. Logic: Priority to LocalStorage Source ID
    const savedPrefix = localStorage.getItem('xmlTitlePrefix');
    if (savedPrefix) {
      const inp = document.getElementById('titlePrefixInput');
      if (inp) inp.value = savedPrefix;
    }

    if (selectedSourceId) {
      // We have a stored ID, fetch immediately
      fetchProducts().catch(e => console.error("Initial fetch failed:", e));
    } else {
      // No source ever selected
      chooseSource();
    }
  });
</script>
{% endblock %}