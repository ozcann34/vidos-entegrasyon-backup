{% extends "_base.html" %}

{% block title %}Trendyol İade Talepleri{% endblock %}
{% block page_title %}
<i class="bi bi-arrow-return-left text-danger me-2"></i>Trendyol İade Talepleri
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-clock-history fs-1 text-warning mb-2"></i>
                    <h3 id="pendingCount" class="mb-0">-</h3>
                    <small class="text-muted">Bekleyen</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle fs-1 text-success mb-2"></i>
                    <h3 id="approvedCount" class="mb-0">-</h3>
                    <small class="text-muted">Onaylandı</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-x-circle fs-1 text-danger mb-2"></i>
                    <h3 id="rejectedCount" class="mb-0">-</h3>
                    <small class="text-muted">Reddedildi</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <i class="bi bi-box-arrow-in-left fs-1 text-info mb-2"></i>
                    <h3 id="totalCount" class="mb-0">-</h3>
                    <small class="text-muted">Toplam</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Card -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Durum</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">Tümü</option>
                        <option value="Created">Oluşturuldu</option>
                        <option value="Pending">Beklemede</option>
                        <option value="Approved">Onaylandı</option>
                        <option value="Rejected">Reddedildi</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="btnRefresh" class="btn btn-primary w-100">
                        <i class="bi bi-arrow-clockwise me-1"></i>Yenile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Claims List -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">


            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 80px;">Ürün</th>
                            <th>Ürün Bilgisi</th>
                            <th style="width: 120px;">Sipariş No</th>
                            <th style="width: 100px;">Miktar</th>
                            <th style="width: 120px;">Tutar</th>
                            <th style="width: 100px;">Durum</th>
                            <th style="width: 150px;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="claimsBody">
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2 text-muted">İade talepleri yükleniyor...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <button id="btnPrev" class="btn btn-outline-secondary btn-sm" disabled>
                <i class="bi bi-chevron-left"></i> Önceki
            </button>
            <span id="pageInfo" class="mx-3 text-muted">Sayfa 1</span>
            <button id="btnNext" class="btn btn-outline-secondary btn-sm" disabled>
                Sonraki <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-x-circle me-2 text-danger"></i>İade Reddet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Red Nedeni:</label>
                    <select id="rejectReasonId" class="form-select">
                        <option value="1">Ürün hasarlı iade edilemez</option>
                        <option value="2">Ürün kullanılmış</option>
                        <option value="3">İade süresi dolmuş</option>
                        <option value="4">Ürün eksik/farklı</option>
                        <option value="5">Diğer</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Ek Açıklama (Opsiyonel):</label>
                    <textarea id="rejectReasonText" class="form-control" rows="3"
                        placeholder="Ek açıklama..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-danger" id="btnSubmitReject">
                    <i class="bi bi-x-circle me-1"></i>Reddet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        let currentPage = 0;
        let totalPages = 1;
        let currentClaimId = null;

        const statusFilter = document.getElementById('statusFilter');
        const btnRefresh = document.getElementById('btnRefresh');
        const claimsBody = document.getElementById('claimsBody');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const pageInfo = document.getElementById('pageInfo');

        async function loadClaims() {
            const status = statusFilter.value;

            let url = `/api/trendyol/claims?page=${currentPage}&size=20`;
            if (status) url += `&claim_status=${status}`;

            claimsBody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">İade talepleri yükleniyor...</p>
                </td>
            </tr>
        `;

            try {
                const res = await fetch(url);
                const json = await res.json();

                if (!json.success) {
                    throw new Error(json.message || 'Bilinmeyen hata');
                }

                const data = json.data || {};
                const content = data.content || data.claims || [];
                const total = data.totalElements || content.length;
                totalPages = data.totalPages || 1;

                document.getElementById('totalCount').textContent = total;

                if (content.length === 0) {
                    claimsBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 mb-3 d-block"></i>
                            <p>Henüz iade talebi bulunmamaktadır.</p>
                        </td>
                    </tr>
                `;
                } else {
                    claimsBody.innerHTML = content.map(c => renderClaimRow(c)).join('');
                }

                // Update pagination
                pageInfo.textContent = `Sayfa ${currentPage + 1} / ${totalPages}`;
                btnPrev.disabled = currentPage <= 0;
                btnNext.disabled = currentPage >= totalPages - 1;

            } catch (err) {
                console.error(err);
                claimsBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5 text-danger">
                        <i class="bi bi-exclamation-circle fs-1 mb-3 d-block"></i>
                        <p>Hata: ${err.message}</p>
                    </td>
                </tr>
            `;
            }
        }

        function renderClaimRow(c) {
            const claimId = c.id || c.claimId;
            const orderNumber = c.orderNumber || c.shipmentPackageNumber || '-';
            const productName = c.productName || c.title || 'Ürün';
            const barcode = c.barcode || '-';
            const quantity = c.quantity || 1;
            const amount = c.claimPrice || c.amount || 0;
            const status = c.claimStatus || c.status || 'Unknown';

            let statusBadge = '';
            let canAction = false;

            if (status === 'Created' || status === 'Pending') {
                statusBadge = '<span class="badge bg-warning text-dark">Beklemede</span>';
                canAction = true;
            } else if (status === 'Approved') {
                statusBadge = '<span class="badge bg-success">Onaylandı</span>';
            } else if (status === 'Rejected') {
                statusBadge = '<span class="badge bg-danger">Reddedildi</span>';
            } else {
                statusBadge = `<span class="badge bg-secondary">${status}</span>`;
            }

            const imageUrl = c.productImage || c.imageUrl || '';
            const imageHtml = imageUrl
                ? `<img src="${imageUrl}" class="rounded" style="width:50px;height:50px;object-fit:cover;">`
                : '<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width:50px;height:50px;"><i class="bi bi-image text-muted"></i></div>';

            return `
            <tr>
                <td>${imageHtml}</td>
                <td>
                    <div class="fw-bold small">${productName.substring(0, 40)}${productName.length > 40 ? '...' : ''}</div>
                    <small class="text-muted">Barkod: ${barcode}</small>
                </td>
                <td class="small">${orderNumber}</td>
                <td class="text-center">${quantity}</td>
                <td class="fw-bold">${amount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' })}</td>
                <td>${statusBadge}</td>
                <td>
                    ${canAction ? `
                        <button class="btn btn-sm btn-success me-1" onclick="acceptClaim('${claimId}')" title="Onayla">
                            <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="openRejectModal('${claimId}')" title="Reddet">
                            <i class="bi bi-x"></i>
                        </button>
                    ` : `
                        <span class="text-muted small">İşlem yok</span>
                    `}
                </td>
            </tr>
        `;
        }

        window.acceptClaim = async function (claimId) {
            const result = await Swal.fire({
                title: 'Emin misiniz?',
                text: 'Bu iade talebini onaylamak istediğinize emin misiniz?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Evet, Onayla',
                cancelButtonText: 'İptal'
            });

            if (!result.isConfirmed) return;

            try {
                const res = await fetch(`/api/trendyol/claims/${claimId}/accept`, {
                    method: 'POST'
                });
                const json = await res.json();

                if (json.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı!',
                        text: 'İade talebi onaylandı.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    loadClaims();
                } else {
                    throw new Error(json.message || 'Onaylama başarısız');
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: err.message
                });
            }
        };

        window.openRejectModal = function (claimId) {
            currentClaimId = claimId;
            document.getElementById('rejectReasonId').value = '1';
            document.getElementById('rejectReasonText').value = '';

            const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
            modal.show();
        };

        document.getElementById('btnSubmitReject').addEventListener('click', async function () {
            const rejectReasonId = parseInt(document.getElementById('rejectReasonId').value);
            const rejectReasonText = document.getElementById('rejectReasonText').value.trim();

            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>İşleniyor...';

            try {
                const res = await fetch(`/api/trendyol/claims/${currentClaimId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reject_reason_id: rejectReasonId,
                        reject_reason_text: rejectReasonText || null
                    })
                });

                const json = await res.json();

                if (json.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Başarılı!',
                        text: 'İade talebi reddedildi.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    bootstrap.Modal.getInstance(document.getElementById('rejectModal')).hide();
                    loadClaims();
                } else {
                    throw new Error(json.message || 'Reddetme başarısız');
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: err.message
                });
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-x-circle me-1"></i>Reddet';
            }
        });

        btnRefresh.addEventListener('click', () => {
            currentPage = 0;
            loadClaims();
        });

        statusFilter.addEventListener('change', () => {
            currentPage = 0;
            loadClaims();
        });

        btnPrev.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                loadClaims();
            }
        });

        btnNext.addEventListener('click', () => {
            if (currentPage < totalPages - 1) {
                currentPage++;
                loadClaims();
            }
        });

        // Initial load
        loadClaims();
    })();
</script>
{% endblock %}